<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Letterboxd Statistics Dashboard</title>
    <link href="theme.default.min.css" rel="stylesheet">
    <link href="overall.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/css-doodle/0.40.0/css-doodle.min.js"></script>
    <script src="films.js"></script>
    <script src="people.js"></script>
    <script src="data.js"></script>
    <script src="country_codes.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="jquery.tablesorter.min.js"></script>
    <script src="jquery.tablesorter.widgets.min.js"></script>
</head>
<body>

    <css-doodle id="doodle">
        :doodle {
        @grid: 64 / 100.5vmax;
        }
        :after {
        content: '\@hex(@rand(0x2800, 0x283F))';
        transform: scale(1.35);
        color: @pick(#000, #060606, #0D0D0D);
        font-size: 3em;
        line-height: 1.1em;
        }
    </css-doodle>

    <div id="menu_background">&nbsp;</div>

    <div id="image_loader"></div>

    <a target="_blank" href="" id="backdrop_link"><div id="backdrop"></div></a>

    <div id="backdrop_details">Hello World</div>

    <div id="buttons">

        <select id="FilmFilter" onchange="javascript:changeFilmFilter()">
            <option value="all">All Films</option>
            <option disabled>──────────</option>
            <option value="language_notenglish">Language: Not English</option>
            <option disabled>──────────</option>
            <option value="length_long">Length: Feature Film</option>
            <option value="length_short">Length: Short Film</option>
            <option disabled>──────────</option>
            <option value="rating_5">Rating: 5 Stars</option>
            <option value="rating_4">Rating: 4+ Stars</option>
            <option disabled>──────────</option>
        </select>

        <script>
            for (var a = 2020; a > 1890; a -= 10) {
                if (films.some(e => e.Year >= a && e.Year < a + 10)) {
                    d3
                        .select('#FilmFilter')
                        .append('option')
                        .attr('value', 'decade_' + a)
                        .text('Decade: ' + a + 's');
                }
            }
            var years = []
            for (var film of films) {
                if (film.DiaryWatchedDate) {
                    var y = film.DiaryWatchedDate.split('-')[0];
                    if (!years.some(a => a[0] == y)) {
                        years.push([y, 0]);
                    }
                    var where = years.findIndex(a => a[0] == y);
                    years[where][1]++;
                }
            }
            years = years.filter(a => a[1] >= 10);
            if (years.length) {
                d3
                    .select('#FilmFilter')
                    .append('option')
                    .attr('disabled', 'disabled')
                    .text('──────────');
                years.sort().reverse();
                for (var year of years) {
                    d3
                        .select('#FilmFilter')
                        .append('option')
                        .attr('value', 'diary_' + year[0])
                        .text('Latest Diary Year: ' + year[0]);
                }
                d3
                    .select('#FilmFilter')
                    .append('option')
                    .attr('value', 'diary_none')
                    .text('Latest Diary Year: None');
                d3
                    .select('#FilmFilter')
                    .append('option')
                    .attr('value', 'diary_any')
                    .text('Latest Diary Year: Any');
            }
        </script>

        <!--<div class="title">Overall</div>
    <span class="displayer" onmousedown="javascript:showOverall()" id="prime">Overall</span>-->
        <i class="links_decade">
            <div class="title">Release Date</div>
            <span class="displayer inline" onmousedown="javascript:showFilmsPerYear()">Year</span>
            &#9670;
            <span class="displayer inline" onmousedown="javascript:showFilmsPerDecade()">Decade</span>
            <i class="links_when">
                &#9670;
                <span class="displayer inline" onmousedown="javascript:showOldestReleasedFilms()">Earliest</span>
                &#9670;
                <span class="displayer inline" onmousedown="javascript:showNewestReleasedFilms()">Newest</span><br>
            </i>
        </i>
        <div class="title">Attributes</div>
        <div class="initially_hidden">
            <div class="host_only">
                <span class="displayer inline" onmousedown="javascript:showBAW()">Black & White</span>
                &#9670;
            </div>
        </div>
        <span class="displayer inline" onmousedown="javascript:showFilmsPerCountry()">Country</span>
        &#9670;
        <span class="displayer inline" onmousedown="javascript:showGenres()">Genre</span>
        <br />
        <span class="displayer inline" onmousedown="javascript:showFilmsPerLanguages()">Language</span>
        &#9670;
        <span class="displayer inline" onmousedown="javascript:showLengthStats()">Length</span>
        &#9670;
        <span class="displayer inline" onmousedown="javascript:showRated()">Rating</span>
        <br />
        <span class="displayer inline" onmousedown="javascript:showStudios()">Studio</span>
        &#9670;
        <span class="displayer inline" onmousedown="javascript:showThemes()">Theme</span>
        &#9670;
        <span class="displayer inline" onmousedown="javascript:showTitles()">Title</span>
        <i class="links_letterboxd">
            <div class="title">Letterboxd</div>
            <span class="displayer inline" onmousedown="javascript:showFans()">Fans</span>
            &#9670;
            <span class="displayer inline" onmousedown="javascript:showLikes()">Likes</span>
            &#9670;
            <span class="displayer inline" onmousedown="javascript:showRatings()">Ratings</span>
            &#9670;
            <span class="displayer inline" onmousedown="javascript:showPopularity()">Watches</span>
        </i>
        <div class="title">Peop<b onmousedown="showHidden()">l</b>e</div>
        <em class="subtitle">Director:</em>
        <span class="displayer inline" onmousedown="javascript:showDirectorsAll()">All</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showDirectorsWomen()">W</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showDirectorsMen()">M</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showDirectorsNonBinary()">NB</span>
        <div class="initially_hidden">
            &#9670;
            <span class="displayer inline ttt" data-tooltip="Unknown" onmousedown="javascript:showDirectorsUnknown()">U</span>
        </div>
        <br>
        <em class="subtitle ttt" data-tooltip="Top Billing">Protagonist:</em>
        <span class="displayer inline" onmousedown="javascript:showProtagonistsAll()">All</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showProtagonistsWomen()">W</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showProtagonistsMen()">M</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showProtagonistsNonBinary()">NB</span>
        <div class="initially_hidden">
            &#9670;
            <span class="displayer inline ttt" data-tooltip="Unknown" onmousedown="javascript:showProtagonistsUnknown()">U</span>
        </div>
        <br>
        <em class="subtitle ttt" data-tooltip="Top 3 Billing">Main Cast:</em>
        <span class="displayer inline" onmousedown="javascript:showTopCastAll()">All</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showTopCastWomen()">W</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showTopCastMen()">M</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showTopCastNonBinary()">NB</span>
        <div class="initially_hidden">
            &#9670;
            <span class="displayer inline ttt" data-tooltip="Unknown" onmousedown="javascript:showTopCastUnknown()">U</span>
        </div>
        <br>
        <em class="subtitle ttt" data-tooltip="Any Billing">Entire Cast:</em>
        <span class="displayer inline" onmousedown="javascript:showEntireCastAll()">All</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showEntireCastWomen()">W</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showEntireCastMen()">M</span>
        &#9670;
        <span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showEntireCastNonBinary()">NB</span>
        <div class="initially_hidden">
            &#9670;
            <span class="displayer inline ttt" data-tooltip="Unknown" onmousedown="javascript:showEntireCastUnknown()">U</span>
        </div>
        <br/>
        <span class="displayer inline" onmousedown="javascript:showAge()">Age</span>
        &#9670;
        <span class="displayer inline" onmousedown="javascript:showPeopleCombinations()">Combinations</span>
        <i class="links_decade">
            &#9670;
            <span class="displayer inline" onmousedown="javascript:showPeopleLongevity()">Longevity</span>
        </i>
        <div class="initially_hidden">
            <div class="host_only">
                <i class="links_recent">
                    <div class="title">Other</div>
                    <span class="displayer inline" onmousedown="javascript:showRecent()">Recently Watched</span>
                </i>
            </div>
        </div>
    </div>

    <div id="tt" style="display: none">
        <p id="tooltip_text"></p>
    </div>

    <script>

        d3.select('#FilmFilter').property('value', 'all');

        var documentWidth = document.body.clientWidth;

        onresize = (event) => {
            if (document.body.clientWidth != documentWidth) {
                documentWidth = document.body.clientWidth;
                if (selectedPage) {
                    var remember = lastEventTarget;
                    selectedPage();
                    remember.addClass('active');
                    lastEventTarget = remember;
                } else {
                    showOverall();
                    deactiveAll();
                }
            }
        };

        var table, thead, tbody;
        var galleryAmount = 30;
        var sufficientBase = 10;
        var backdropIndex = ~~(data.Backdrops.length * Math.random());
        var allFilms = [...films];
        var allBackdrops = [...data.Backdrops];
        var areFilmsFiltered = false;
        var currentFilmFilter = 'all';
        var selectedPage = null;
        let lastEventTarget = null;
        var lastPeopleParameters = null;

        document.documentElement.style.setProperty('--primary-colour', '#EF3340');
        document.documentElement.style.setProperty('--secondary-colour', '#3199E0');

        ////////////////// FILTERING //////////////////

        function changeFilmFilter() {
            currentFilmFilter = d3.select('#FilmFilter').property('value').split('_');
            areFilmsFiltered = currentFilmFilter != 'all';
            d3.selectAll('.links_decade').style('display', null);
            d3.selectAll('.links_recent').style('display', null);
            d3.selectAll('.links_when').style('display', null);
            d3.selectAll('.links_letterboxd').style('display', null);
            var pageFunction = selectedPage ? selectedPage.name : null;
            switch (currentFilmFilter[0]) {
                case 'all':
                    films = [...allFilms];
                    break;
                case 'diary':
                    if (currentFilmFilter[1] == 'none') {
                        films = allFilms.filter(a => !a.DiaryWatchedDate);
                    } else if (currentFilmFilter[1] == 'any') {
                        films = allFilms.filter(a => a.DiaryWatchedDate);
                    } else {
                        films = allFilms.filter(a => a.DiaryWatchedDate && a.DiaryWatchedDate.startsWith(currentFilmFilter[1]));
                    }
                    d3.select('.links_recent').style('display', 'none');
                    switch (pageFunction) {
                        case 'showRecent':
                            selectedPage = null;
                            lastEventTarget = null;
                    }
                    break;
                case 'language':
                    films = allFilms.filter(a => a.Language != 'English' && a.Language != '');
                    d3.selectAll('.links_recent').style('display', 'none');
                    switch (pageFunction) {
                        case 'showRecent':
                            selectedPage = null;
                            lastEventTarget = null;
                    }
                    break;
                case 'decade':
                    var year = +currentFilmFilter[1].replace('s', '');
                    films = allFilms.filter(a => a.Year >= year && a.Year < year + 10);
                    d3.selectAll('.links_decade').style('display', 'none');
                    d3.selectAll('.links_recent').style('display', 'none');
                    switch (pageFunction) {
                        case 'showFilmsPerYear':
                        case 'showFilmsPerDecade':
                        case 'showOldestReleasedFilms':
                        case 'showNewestReleasedFilms':
                        case 'showRecent':
                            selectedPage = null;
                            lastEventTarget = null;
                    }
                    break;
                case 'rating':
                    var stars = +currentFilmFilter[1]
                    films = allFilms.filter(a => a.RatingSelf >= stars);
                    d3.selectAll('.links_recent').style('display', 'none');
                    switch (pageFunction) {
                        case 'showRecent':
                            selectedPage = null;
                            lastEventTarget = null;
                    }
                    break;
                case 'length':
                    films = allFilms.filter(a => currentFilmFilter[1] == 'long' ? a.Minutes >= 60 : a.Minutes < 60);
                    d3.selectAll('.links_when').style('display', currentFilmFilter[1] == 'long' ? null : 'none');
                    d3.selectAll('.links_letterboxd').style('display', currentFilmFilter[1] == 'long' ? null : 'none');
                    break;
            }
            var filteredBackdrops = allBackdrops.filter(a => films.some(b => b.Id == a.LetterboxdId));
            if (filteredBackdrops.length) {
                data.Backdrops = filteredBackdrops;
            } else {
                data.Backdrops = allBackdrops;
            }
            backdropIndex = ~~(data.Backdrops.length * Math.random());
            if (selectedPage) {
                var remember = lastEventTarget;
                selectedPage();
                remember.addClass('active');
                lastEventTarget = remember;
            } else {
                showOverall();
            }
            data.Backdrops = shuffleArray(data.Backdrops);
            showNextBackdrop();
        }

        ////////////////// TOOLTIPS //////////////////

        var tt = d3.select('#tt');

        tt.on('mousedown', function () { tt.style('display', 'none'); });

        function makeFilmDetails(film, specificDate = false, includeRating = true) {
            var details = (specificDate ? film.When : film.Year) + '<br/>';
            if (includeRating) {
                if (film.RatingSelf > 0) {
                    details += '&#9670;'.repeat(Math.floor(film.RatingSelf)) + (film.RatingSelf % 1 ? '&#9671;' : '');
                } else {
                    details += '&nbsp;';
                }
                details += '<br/>';
            }
            if (film.Language.length == 0) {
                details += '<em>Silent</em>';
            } else if (film.Language != "English") {
                details += film.Language;
            } else {
                details += '&nbsp;';
            }
            return details;
        }

        // converts language names to the ones that letterboxd uses, rightly or wrongly...
        function letterboxdLanguage(language) {
            language = language.toLowerCase().replace(/ /g, '-');
            switch (language) {
                case 'mandarin':
                    return 'chinese';
                case '':
                    return 'No Spoken Language';
                default:
                    return language;
            }
        }

        function showNextBackdrop() {
            var randomBackdrop = data.Backdrops[backdropIndex];
            var backdrop = $('#backdrop');
            var where = shuffleArray(randomBackdrop.ImageUrl.split('/'))[0];
            backdrop.css('background-image', 'url("https://image.tmdb.org/t/p/w780/' + where + '")');
            d3.select('#backdrop_details').html(randomBackdrop.FilmName);
            if (randomBackdrop.Flags != null && randomBackdrop.Flags.includes('m')) {
                backdrop.addClass('mirror');
            } else {
                backdrop.removeClass('mirror');
            }
            $('#backdrop_link').attr('href', 'https://boxd.it/' + randomBackdrop.LetterboxdId);
            createTooltipTriggers();

            backdropIndex++;
            if (backdropIndex >= data.Backdrops.length) {
                backdropIndex = 0;
            }

            var imageLoader = $('#image_loader');
            imageLoader.css('background-image', 'url("https://image.tmdb.org/t/p/w780/' + data.Backdrops[backdropIndex].ImageUrl + '")');
        }

        function createTooltipTriggers() {
            d3.selectAll('.ttt')
                .on("mouseover", function (d, i) {
                    if ($(this).attr('data-tooltip-size') == 'big') {
                        $('#tt').addClass('big')
                    } else {
                        d3.select('#tt')
                        $('#tt').removeClass('big')
                    }
                    d3.select('#tooltip_text').html($(this).attr('data-tooltip'));
                })
                .on("mouseout", function () {
                    tt.style('display', 'none');
                })
                .on("mousemove", function (d, i) {
                    tt.style('opacity', '0.01');
                    var x = d3.event.pageX;
                    x = Math.max(x, 10);
                    if (x <= 0 || y <= 0) {
                        tt.style('display', 'none');
                    } else {
                        tt.style('display', null);
                    }
                    var y = d3.event.pageY + 10;
                    var y = d3.event.pageY - (+tt.style('height').replace('px', '') + 20);

                    if (y - window.scrollY < 0) {
                        y = d3.event.pageY + 10;
                    }

                    tt.style('left', Math.max(0, Math.floor(x - (+tt.style('width').replace('px', '') / 2))) + 'px');
                    tt.style('top', Math.floor(y + 5) + 'px');
                    tt.style('opacity', '1');
                });
        }

        function deactivateAll() {
            $('.active').removeClass('active');
        }

        function countryNameToUrl(country) {
            country = country.toLowerCase();
            switch (country) {
                case 'united kingdom':
                    return 'uk';
                case 'united states of america':
                    return 'usa';
                case 'russia':
                    return 'russian-federation';
                case 'soviet union':
                    return 'ussr';
                case 'türkiye':
                    return 'turkey';
                case 'côte d\'ivoire':
                    return 'ivory-coast';
                default:
                    return country.replace(/ /g, '-');
            }
        }

        function countryCodeToName(code) {
            return countryCodes[code] || 'Unknown';
        }

        function flagCode(isoCode) {
            switch (isoCode) {
                case 'su': // soviet union
                case 'xc': // czechoslavakia
                case 'xk': // kosovo
                    return '_generic';
                default:
                    return isoCode;
            }
        }

        function resetView(func = null, where = null) {
            window.scrollTo(0, 0);
            showNextBackdrop();
            $('.info').remove();
            $('button').remove();
            $('table').remove();
            $('#mapFrame').remove();
            $('.boxes').remove();
            $('#posters').remove();
            $('#outside').remove();
            $('.gallery').remove();
            selectedPage = func;
            if (where) {
                lastEventTarget = where;
            }
        }

        function createNewTable(isSortable = true) {

            $('body').append('<table class="tablesorter"' + (isSortable ? ' id="main"' : '') + '><thead></thead><tbody></tbody></table>');
            table = $('table').last();
            thead = $('table thead').last();
            tbody = $('table tbody').last();
        }

        function createGallery() {
            $('body').append('<div class="gallery"></div>');
        }

        function makeBox(number, description, tooltip = '', isYear = false)
        {
            var attribs = 'class="number"';
            if (tooltip) {
                attribs = 'class="number ttt" data-tooltip="' + tooltip + '"';
            }
            return '<table class="tablesorter box">' +
                '<thead><tr><th>' + description + '</th></tr></thead>' +
                '<tbody><tr><td ' + attribs + '>' +
                (isYear ? number : number.toLocaleString()) +
                '</td></tr></tbody>' +
                '</table>';
        }

        function makePosterBox(url, tooltip) {
            var attribs = 'class="posterbox"';
            if (tooltip) {
                attribs = 'class="posterbox ttt" data-tooltip="' + tooltip + '"';
            }
            return '<table class="box">' +
                '<tbody><tr><td ' + attribs + '>' +
                '<img src="' + url + '">' +
                '</td></tr></tbody>' +
                '</table>';
        }

        function makeInfo(title, text) {
            $('body').append(
                '<table class="tablesorter infobox">' +
                '<thead><tr><th>' + title + '</th></tr></thead>' +
                '<tbody><tr><td>' + text + '</td></tr></tbody>' +
                '</table>');
        }

        function showHidden() {
            d3.selectAll('.initially_hidden').style('display', 'inline');
        }

        function showHostOnly() {
            if (data.Username == 'LaLunaLlena') {
                d3.selectAll('.host_only').style('display', 'inline');
            }
        }

        function letterboxdStudioId(studio) {
            switch (studio) {
                case "paramount-pictures": return "paramount-1";
                case "lionsgate": return "lionsgate-1";
                case "miramax": return "miramax-1";
                case "metro-goldwyn-mayer": return "metro-goldwyn-mayer-1";
                case "relativity-media": return "relativity-media-1";
                case "canal+": return "canal-3";
                case "bfi": return "bfi-1";
                case "arte-france-cinema": return "arte-france-cinema-5";
                case "le-studio-canal+": return "le-studio-canal";
                default: return studio;
            }
        }

        function urlSafe(text) {
            // general character replacements
            text = text.replace(/\./g, '');
            text = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            text = text.replace("'", "");
            // specific fixes
            text = text.replace('beeban-kidron', 'beeban-kidron-1');
            text = text.replace('eliot-sumner', 'eliot-sumner-1');
            text = text.replace('elliot-page', 'contributor:17664');
            text = text.replace('typhoon', 'typhoon-2');
            return text;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function makeDot(gender) {
            var colour = 'black';
            var symbol = '&#9671;';
            switch (gender) {
                case 1:
                    colour = 'RGB(0, 182, 0)';
                    symbol = '&#9670;';
                    break;
                case 2:
                    colour = 'RGB(255, 128, 0)';
                    symbol = '&#9670;';
                    break;
                case 3:
                    colour = 'RGB(182, 0, 182)';
                    symbol = '&#9670;';
                    break;
            }
            return '<span style="color:' + colour + '">' + symbol + '</span>';
        }

        function makeJobRow(totalAll, totalFemale, totalMale, totalNonBinary, uniqueAll, uniqueFemale, uniqueMale, uniqueNonBinary) {

            var total = totalFemale + totalMale + totalNonBinary;
            var unique = uniqueFemale + uniqueMale + uniqueNonBinary;
            totalFemalePercent = totalFemale / total * 100;
            totalMalePercent = totalMale / total * 100;
            totalNonBinaryPercent = totalNonBinary / total * 100;
            uniqueFemalePercent = uniqueFemale / unique * 100;
            uniqueMalePercent = uniqueMale / unique * 100;
            uniqueNonBinaryPercent = uniqueNonBinary / unique * 100;

            /*
            createNewTable(false);
            thead.append('<tr class="topheader"><th colspan="4">Total</th><th colspan="4">Distinct</th></tr>');
            thead.append('<tr class="bottomheader"><th class="right">All</th><th class="right">Women</th><th class="right">Men</th><th class="right">Non-Binary</th><th class="right">All</th><th class="right">Women</th><th class="right">Men</th><th class="right">Non-Binary</th></tr>');

            tbody.append(
                '<tr>' +
                '<td class="right">' + totalAll + '</td>' +
                '<td class="right ttt" data-tooltip="' + totalFemalePercent.toFixed(2) + '% (' + totalFemale + ')">' + totalFemalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + totalMalePercent.toFixed(2) + '% (' + totalMale + ')">' + totalMalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + totalNonBinaryPercent.toFixed(2) + '% (' + totalNonBinary + ')">' + totalNonBinaryPercent.toFixed(0) + '%</td>' +
                '<td class="right">' + uniqueAll + '</td>' +
                '<td class="right ttt" data-tooltip="' + uniqueFemalePercent.toFixed(2) + '% (' + uniqueFemale + ')">' + uniqueFemalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + uniqueMalePercent.toFixed(2) + '% (' + uniqueMale + ')">' + uniqueMalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + uniqueNonBinaryPercent.toFixed(2) + '% (' + uniqueNonBinary + ')">' + uniqueNonBinaryPercent.toFixed(0) + '%</td>' +
                '</tr>')
            */

            createNewTable(false);

            //<th class="right">All</th>
            thead.append('<tr><th>&nbsp;</th><th class="right">Women</th><th class="right">Men</th><th class="right">Non-Binary</th></tr>');

            tbody.append(
                '<tr>' +
                '<td>Total</td>' +
                '<td class="right ttt" data-tooltip="' + totalFemalePercent.toFixed(2) + '% (' + totalFemale + ')">' + totalFemalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + totalMalePercent.toFixed(2) + '% (' + totalMale + ')">' + totalMalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + totalNonBinaryPercent.toFixed(2) + '% (' + totalNonBinary + ')">' + totalNonBinaryPercent.toFixed(0) + '%</td>' +
                '</tr>' +
                '<tr>' +
                '<td>Distinct</td>' +
                '<td class="right ttt" data-tooltip="' + uniqueFemalePercent.toFixed(2) + '% (' + uniqueFemale + ')">' + uniqueFemalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + uniqueMalePercent.toFixed(2) + '% (' + uniqueMale + ')">' + uniqueMalePercent.toFixed(0) + '%</td>' +
                '<td class="right ttt" data-tooltip="' + uniqueNonBinaryPercent.toFixed(2) + '% (' + uniqueNonBinary + ')">' + uniqueNonBinaryPercent.toFixed(0) + '%</td>' +
                '</tr>')
        }

        function SortableName(name) {
            return name.split(' ').reverse().join(' ');
        }

        function copyRecentTable() {
            var tbl = document.getElementById('main');
            $(tbl).css('display', 'inline');
            var body = document.body, range, sel;
            if (document.createRange && window.getSelection) {
                range = document.createRange();
                sel = window.getSelection();
                sel.removeAllRanges();
                try {
                    range.selectNodeContents(tbl);
                    sel.addRange(range);
                } catch (e) {
                    range.selectNode(tbl);
                    sel.addRange(range);
                }
            } else if (body.createTextRange) {
                range = body.createTextRange();
                range.moveToElementText(tbl);
                range.select();
            }
            document.execCommand("Copy");
        }

        function copyRecentPosters() {
            var tbl = document.getElementById('posters');
            $(tbl).css('display', 'block');
            var body = document.body, range, sel;
            if (document.createRange && window.getSelection) {
                range = document.createRange();
                sel = window.getSelection();
                sel.removeAllRanges();
                try {
                    range.selectNodeContents(tbl);
                    sel.addRange(range);
                } catch (e) {
                    range.selectNode(tbl);
                    sel.addRange(range);
                }
            } else if (body.createTextRange) {
                range = body.createTextRange();
                range.moveToElementText(tbl);
                range.select();
            }
            document.execCommand("Copy");
        }

        function copyRecentGrid() {
            var tbl = document.getElementById('grid');
            $(tbl).css('display', 'inline-block');
            var body = document.body, range, sel;
            if (document.createRange && window.getSelection) {
                range = document.createRange();
                sel = window.getSelection();
                sel.removeAllRanges();
                try {
                    range.selectNodeContents(tbl);
                    sel.addRange(range);
                } catch (e) {
                    range.selectNode(tbl);
                    sel.addRange(range);
                }
            } else if (body.createTextRange) {
                range = body.createTextRange();
                range.moveToElementText(tbl);
                range.select();
            }
            document.execCommand("Copy");
        }

        function showFilms(list) {
            var output = [];
            for (var film of list.split(' ')) {
                output.push('(' + films[+film].Year + ') ' + films[+film].Title);
            }
            output.sort();
            alert(output.join('\r\n'));
        }

        function formatNumber(number) {
            if (number >= 950000) {
                return (Math.round(number / 100000) / 10) + 'm';
            } else if (number >= 9500) {
                return Math.round(number / 1000) + 'k';
            } else {
                return number.toLocaleString();
            }
        }

        function makeFilmListTooltip(filmList) {
            var tooltip = []
            for (var filmIndex of filmList) {
                var film = films[filmIndex]
                tooltip.push('(' + film.Year + ') ' + film.Title);
            }
            tooltip.sort()
            if (tooltip.length > 20) {
                shuffleArray(tooltip);
                tooltip = tooltip.slice(0, 20)
                tooltip.sort()
                tooltip.unshift('<em>Random selection of matching films:</em>', '')
                tooltip.push('', '<em>+' + (filmList.length - 20) + ' more...</em>');
            }
            return tooltip;
        }

        function sortableName(name) {
            return name.split(' ').reverse().join(' ');
        }

        /*
            [isPopulation = true] use when all data is present
            [isPopulation = false] use when the data is a sample
        */
        function calculateStandardDeviation(numbers, isPopulation=true) {
            var mean = numbers.reduce((a, b) => a + b, 0) / numbers.length;
            var diffs = numbers.map(a => (a - mean) ** 2);
            var variance = diffs.reduce((a, b) => a + b, 0) / (numbers.length - (isPopulation ? 0 : 1));
            return Math.sqrt(variance);
        }

        // == PAGES ==

        // === Special ===

        function showSpecificPerson(id) {

            resetView(null, null);
            lastEventTarget = null;

            var index = people.findIndex(a => a.ID == id);
            var person = people[index];

            var listFilms = films.filter(a => a.Cast.includes(index) || a.Directors.includes(index));
            var yearStart = Math.min(...listFilms.map(a => a.Year));
            var yearEnd = Math.max(...listFilms.map(a => a.Year));
            var yearSpan = Math.max(1, (yearEnd - yearStart));
            var minutes = 0

            var ratingSelfSum = 0, ratingSelfCount = 0;
            var ratingLbSum = 0, ratingLbCount = 0;

            for (var film of listFilms) {
                minutes += film.Minutes;
                if (film.RatingSelf > 0) {
                    ratingSelfSum += film.RatingSelf;
                    ratingSelfCount++;
                }
                if (film.RatingLetterboxd > 0) {
                    ratingLbSum += film.RatingLetterboxd;
                    ratingLbCount++;
                }
            }

            if (person.Poster) {
                $('body').append('<div class="boxes"></div>');
                $('.boxes').append(makePosterBox('https://image.tmdb.org/t/p/w220_and_h330_face/' + person.Poster))
            }
            $('body').append('<div class="boxes"></div>');
            $('.boxes:last').append(makeBox(person.FullName, 'Name'));
            $('.boxes:last').append(makeBox(listFilms.length, 'Films'));

            createNewTable();

            thead.append('<tr class="header" style="font-weight:bold"><th>Job</th><th>Title</th><th>Year</th><th>Rating</th><th class="ttt" data-tooltip="Letterboxd Rating">LB Rating</th><th class="ttt" data-tooltip="Number of times Letterboxd users have watched this film">LB Watches</th><th>Language</th></tr>');

            for (var film of listFilms) {

                var job = []
                if (film.Directors.includes(index)) {
                    job.push('Director')
                }
                if (film.Cast.includes(index)) {
                    if (film.Cast[0] == index) {
                        job.push('Protagonist');
                    } else if (film.Cast.slice(0, 3).includes(index)) {
                        job.push('Main Cast');
                    } else {
                        job.push('Cast');
                    }
                }

                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }

                var html = '<tr>';
                html += '<td>' + job.join(' & ') + '</td>';

                var tooltip = '';
                if (film.Poster.length > 0) {
                    tooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                }
                html += '<td class="' + tooltip + '"><a href="https://boxd.it/' + film.Id + '">' + title + '</a></td>';

                html += '<td class="right">' + film.Year + '</td>';
                var ratingDetail = '&nbsp;';
                if (film.RatingSelf > 0) {
                    if (film.RatingSelf % 1) {
                        ratingDetail = '&#9670;'.repeat(Math.floor(film.RatingSelf)) + '&#11030;';
                    } else {
                        ratingDetail = '&#9670;'.repeat(film.RatingSelf);
                    }
                }
                html += '<td data-value="' + (film.RatingSelf || 0) + '">' + ratingDetail + '</td>';
                html += '<td class="right">' + (film.RatingLetterboxd >= 0 ? film.RatingLetterboxd.toFixed(2) : 'NA') + '</td>';
                html += '<td class="right" data-value="' + film.Watched + '">' + Math.round(film.Watched / 1000) + 'k</td>';
                var languageDetail = '&nbsp;';
                if (film.Language.length == 0) {
                    languageDetail = '<em>Silent</em>';
                } else {
                    languageDetail = film.Language;
                }
                html += '<td>' + languageDetail + '</td>';
                html += '</tr>';
                tbody.append(html);
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[2, 0]],
                headers: {
                    0: { sortInitialOrder: 'asc' },
                    1: { sortInitialOrder: 'asc' },
                    2: { sortInitialOrder: 'desc' },
                    3: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    4: { sortInitialOrder: 'desc' },
                    5: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    6: { sortInitialOrder: 'asc' },
                }
            });

            $('body').append('<div class="boxes"></div>');
            $('.boxes:last').append(makeBox(yearSpan + ' year' + (yearSpan == 1 ? '' : 's'), 'Span'));
            $('.boxes:last').append(makeBox(Math.floor(minutes / 60) + '<span style="opacity:0.333">h</span> ' + (minutes % 60) + '<span style="opacity:0.333">m</span>', 'Time Watched'));
            $('.boxes:last').append('<br/>');
            if (ratingSelfCount > 0) {
                $('.boxes:last').append(makeBox((ratingSelfSum / ratingSelfCount).toFixed(2), 'Averge Rating'));
            }
            if (ratingLbCount > 0) {
                $('.boxes:last').append(makeBox((ratingLbSum / ratingLbCount).toFixed(2), 'Average LB Rating'));
            }

            deactivateAll();

            createTooltipTriggers();
        }

        // === Release Date ===

        function showOverall() {
            resetView(showOverall, null);
            var filterText = '';
            if (areFilmsFiltered) {
                filterText = 'watched films that match the selected filter';
            } else {
                filterText = '<a href="https://letterboxd.com/' + data.Username + '/films/">watched films</a>';
            }
            makeInfo(
                'Hello',
                'Click a section ' + (window.innerWidth > 900 ? 'on the left' : 'above') + ' to explore the statistics for <a href="https://letterboxd.com/' + data.Username + '/">' + data.Username + '\'s</a> ' + films.length.toLocaleString() + ' ' + filterText + '.<br/> The statistics were generated on ' + data.LastUpdated + '.');
            deactivateAll();
        }

        function showFilmsPerYear() {

            resetView(showFilmsPerYear, $(event.target));

            var yearCount = 0, yearSum = 0, yearList = []

            var filmsWatchedPerYear = {}
            for (var year = 1870; year <= new Date().getFullYear(); year++) {
                filmsWatchedPerYear[year] = 0
            }
            var filmIndexes = []
            for (var index in films) {
                var film = films[index]
                if (film.Year > 0) {
                    filmsWatchedPerYear[film.Year]++
                    if (!filmIndexes[film.Year])
                        filmIndexes[film.Year] = []
                    filmIndexes[film.Year].push(index)
                    yearCount++
                    yearSum += film.Year
                    yearList.push(film.Year)
                }
            }
            yearList.sort()

            if (documentWidth > 820) {
                showFilmsPerYearChart(filmsWatchedPerYear);
            }

            var middle = ~~(yearList.length / 2)
            var medianBefore = yearList.slice(0, middle).filter(a => a == yearList[middle]).length
            var medianAfter = yearList.slice(middle + 1).filter(a => a == yearList[middle]).length
            var highest = Math.max(...Object.values(filmsWatchedPerYear))
            var mode = Object.keys(filmsWatchedPerYear).filter(a => filmsWatchedPerYear[a] == highest).join(', ')

            $('body').append('<div class="boxes"></div>');
            $('.boxes').append(makeBox(Math.round(yearSum / yearCount), 'Film Year: Mean', (yearSum / yearCount).toFixed(2), true));
            $('.boxes').append(makeBox(yearList[middle], 'Film Year: Median', 'In this year:</br>' + medianBefore + ' films before<br>' + medianAfter + ' films after', true));
            $('.boxes').append(makeBox(mode, 'Film Year: Mode', null, true));

            var yearsWithoutFilms = [
                1870, 1871, 1872, 1873, 1875, 1876, 1877, 1879,
                1880, 1881, 1883, 1884, 1886, 1889
            ];
            var thisYear = new Date().getFullYear();
            var thisDecade = thisYear - (thisYear % 10);

            var watched = 0, unwatched = 0;
            for (var a = thisDecade; a >= 1900; a -= 10) {
                for (var b = 0; b < 10; b++) {
                    if (yearsWithoutFilms.includes(a + b)) {
                    } else if (a + b > thisYear) {
                    } else {
                        var hasFilms = filmsWatchedPerYear[a + b] > 0;
                        if (hasFilms) {
                            watched++;
                        } else {
                            unwatched++;
                        }
                    }
                }
            }

            if (documentWidth > 480) {
                createNewTable();
                thead.append('<tr><th colspan="10">Years Without Watched Films</th></tr>');
                for (var a = 1900; a <= thisDecade; a += 10) {
                    if (currentFilmFilter[0] != 'decade' || a == currentFilmFilter[1]) {
                        var output = '<tr>';
                        for (var b = 0; b < 10; b++) {
                            if (yearsWithoutFilms.includes(a + b)) {
                                output += '<td>&nbsp;</td>';
                            } else if (a + b > thisYear) {
                                output += '<td>&nbsp;</td>';
                            } else {
                                var hasFilms = filmsWatchedPerYear[a + b] > 0;
                                if (hasFilms) {
                                    var tooltip = makeFilmListTooltip(filmIndexes[a+b]);
                                    output += '<td style="color: #ddd" class="ttt tttsubtle" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + (a + b) + '</td>';
                                } else {
                                    output += '<td><a target="_blank" href="https://letterboxd.com/films/popular/year/' + (a + b) + '/size/large/">' + (a + b) + '</a></td>';
                                }
                            }
                        }
                        output += '</tr>';
                        tbody.append(output);
                    }
                }
            }

            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox(watched, 'Watched Years'));
            if (currentFilmFilter[0] == 'decade') {
                $('.boxes').last().append(makeBox(10 - watched, 'Unwatched Years'));
            } else {
                $('.boxes').last().append(makeBox(unwatched, 'Unwatched Years'));
            }

            createTooltipTriggers();

            deactivateAll();
            $(event.target).addClass('active');
        }

        function showFilmsPerYearChart(filmsWatchedPerYear) {

            $('body').append('<div id="outside"><div class="title">Films Watched by Release Year</div><figure class="highcharts-figure"><div id="container"></div></figure></div>');

            var highest = 0;
            var cats = [];
            var groups = [];
            var counter = 0;
            for (var a = 1900; a <= new Date().getFullYear(); a += 10) {
                cats.push(a + 's')
            }

            for (var a = 0; a < 10; a++) {
                var series = {};
                series.color = 'black';
                series.animation = false;
                series.name = counter++;
                series.data = [];
                for (var b = 0; b < cats.length; b++) {
                    var year = 1900 + (b * 10) + a;
                    series.data.push(filmsWatchedPerYear[year]);
                    highest = Math.max(highest, filmsWatchedPerYear[year] || 0);
                }
                groups.push(series);
            }

            Highcharts.chart('container', {
                chart: {
                    type: 'column',
                    width: 730,
                    height: 450,
                    spacingLeft: 0,
                    marginLeft: 70,
                },
                title: {
                    text: null,
                    enabled: false
                },
                subtitle: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    category: false,
                    categories: cats,
                    gridLineWidth: 1,
                    tickInterval: 1,
                    gridLineColor: '#ddd',
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Release Year'
                    }
                },
                yAxis: {
                    min: 0,
                    max: Math.ceil(highest / 10) * 10,
                    plotLines: [{
                        color: '#ddd',
                        value: 0,
                        width: 1,
                        zIndex: 5
                    }],
                    gridLineWidth: 1,
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Films Watched'
                    }
                },
                legend: {
                    enabled: false
                },
                tooltip: {
                    formatter: function () {
                        return (1900 + (this.point.x * 10) + this.series.name) + '<br/>' + this.point.y + ' film' + (this.point.y == 1 ? '' : 's')
                    }
                },
                plotOptions: {
                    column: {
                        pointPadding: 0,
                        borderWidth: 0,
                        states: {
                            hover: {
                                color: document.documentElement.style.getPropertyValue('--secondary-colour'),
                                enabled: true
                            },
                            inactive: {
                                opacity: 1
                            }
                        }
                    },
                    series: {
                        groupPadding: 0,
                        pointWidth: 4,
                        borderRadius: 0,
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    var year = (1900 + (this.x * 10) + this.series.name);
                                    window.open('https://letterboxd.com/' + data.Username + '/films/year/' + year + '/by/name/size/large/', '_blank');
                                }
                            }
                        }
                    }
                },
                series: groups
            });
        }

        function showFilmsPerDecade() {

            resetView(showFilmsPerDecade, $(event.target));

            var filmsWatchedPerDecade = {}
            for (var decade = 1870; decade <= new Date().getFullYear(); decade += 10) {
                filmsWatchedPerDecade[decade] = { Count: 0, RatingCount: 0, RatingTotal: 0, Films: [] }
            }
            for (var index in films) {
                var film = films[index]
                var d = filmsWatchedPerDecade[Math.floor(film.Year / 10) * 10]
                d.Count++
                d.Films.push(index)
                if (film.RatingSelf) {
                    filmsWatchedPerDecade[Math.floor(film.Year / 10) * 10].RatingCount++
                    filmsWatchedPerDecade[Math.floor(film.Year / 10) * 10].RatingTotal += film.RatingSelf
                }
            }

            if (documentWidth > 820) {
                showFilmsPerDecadeChart(filmsWatchedPerDecade);
            }

            createNewTable();

            if (documentWidth < 500) {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th></tr>');
                thead.append('<tr class="bottomheader"><th>Decade</th><th>Σ</th><th>%</th><th>&#x25AC;</th></tr>');
            } else {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th><th colspan="2">Rating</th></tr>');
                thead.append('<tr class="bottomheader"><th>Decade</th><th>Σ</th><th>%</th><th>&#x25AC;</th><th>Average</th><th>&#x25AC;</th></tr>');
            }

            var highest = films.length, total = 0;
            for (var decade in filmsWatchedPerDecade) {
                highest = Math.max(highest, filmsWatchedPerDecade[decade].Count);
                total += filmsWatchedPerDecade[decade].Count;
            }

            var highestRating = 5;
            for (var decade in filmsWatchedPerDecade) {
                var rating = "";
                if (filmsWatchedPerDecade[decade].RatingCount > 0) {
                    rating = (filmsWatchedPerDecade[decade].RatingTotal / filmsWatchedPerDecade[decade].RatingCount).toFixed(1);
                    highestRating = Math.max(rating, highestRating);
                }
            }

            for (var decade in filmsWatchedPerDecade) {
                if (+decade >= 1900) {
                    var rating = "";
                    if (filmsWatchedPerDecade[decade].RatingCount > 0) {
                        rating = (filmsWatchedPerDecade[decade].RatingTotal / filmsWatchedPerDecade[decade].RatingCount).toFixed(1);
                    }

                    var watchedPercent = (filmsWatchedPerDecade[decade].Count / total) * 100;

                    var lowBase = filmsWatchedPerDecade[decade].RatingCount < sufficientBase;

                    var middle = '';
                    if (documentWidth >= 500) {
                        middle =
                            '<td class="' + (lowBase ? 'lowbase ' : '') + 'right ttt" data-tooltip="Based on ' + filmsWatchedPerDecade[decade].RatingCount + ' rated film(s)."><span>' + rating + '</span></td>' +
                            '<td class="' + (lowBase ? 'lowbase ' : '') + 'chart" data-value="' + rating + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((rating / highestRating) * 100) + 'px">&nbsp;</span></span></td>';
                    }

                    var tooltip = makeFilmListTooltip(filmsWatchedPerDecade[decade].Films)

                    tbody.append(
                        '<tr>' +
                        '<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/decade/' + decade + 's/by/name/size/large/">' + decade + 's</a></td>' +
                        '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + filmsWatchedPerDecade[decade].Count + '</td>' +
                        '<td class="right ttt" data-tooltip="' + watchedPercent.toFixed(2) + '%" data-value="' + filmsWatchedPerDecade[decade].Count + '">' + watchedPercent.toFixed(0) + '%</td>' +
                        '<td class="chart" data-value="' + filmsWatchedPerDecade[decade].Count + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((filmsWatchedPerDecade[decade].Count / highest) * 100) + 'px">&nbsp;</span></span></td>' +
                        middle +
                        '</tr>');
                }
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sorter: false },
                    2: { sorter: false },
                    3: { sortInitialOrder: 'desc' },
                    4: { sortInitialOrder: 'desc' },
                    5: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    6: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    7: { sortInitialOrder: 'desc' },
                    8: { sortInitialOrder: 'desc', sorter: 'data-value' },
                },
                cssHeaderRow: "tablesorter-headerRow"
            });

            $('body').append('<div class="boxes"></div>');
            $('.boxes').append(makeBox(Object.values(filmsWatchedPerDecade).filter(x => x.Count > 0).length, 'Watched Decades'));

            createTooltipTriggers();

            deactivateAll();
            if (event) {
                $(event.target).addClass('active');
            }
        }

        function showFilmsPerDecadeChart(filmsWatchedPerDecade) {

            $('body').append('<div id="outside"><div class="title">Films Watched by Release Decade</div><figure class="highcharts-figure"><div id="container"></div></figure></div>');

            var cats = [];
            var values = [];

            for (var a = 1900; a <= new Date().getFullYear(); a += 10) {
                cats.push(a + 's')
                values.push(filmsWatchedPerDecade[a].Count)
            }

            Highcharts.chart('container', {
                chart: {
                    type: 'column',
                    width: 740,
                    height: 450
                },
                title: {
                    text: null,
                    enabled: false,
                },
                credits: {
                    enabled: false
                },
                legend: {
                    enabled: false
                },
                xAxis: {
                    categories: cats,
                    xcrosshair: true,
                    title: {
                        text: 'Release Decade'
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Films Watched'
                    },
                    labels: {
                        enabled: false
                    },
                },
                tooltip: {
                    enabled: false
                },
                plotOptions: {
                    column: {
                        pointPadding: 0,
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                            useHTML: true,
                            x: -1,
                            style: {
                                textAlign: 'center',
                            },
                        },
                        states: {
                            hover: {
                                color: document.documentElement.style.getPropertyValue('--secondary-colour'),
                                enabled: true
                            },
                            inactive: {
                                opacity: 1
                            }
                        }
                    },
                },
                series: [
                    {
                        name: '',
                        animation: false,
                        color: 'black',
                        data: values,
                        enableMouseTracking: true,
                        cursor: 'pointer',
                        borderRadius: 2,
                        point: {
                            events: {
                                click: function () {
                                    window.open('https://letterboxd.com/' + data.Username + '/films/decade/' + this.category + '/by/name/size/large/', '_blank');
                                }
                            }
                        }
                    }
                ]
            });
        }

        function showOldestReleasedFilms() {

            resetView(showOldestReleasedFilms, $(event.target));
            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">Top ' + galleryAmount + ' Earliest Released Feature Films</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var filmsEarliest = films.slice().filter(a => a.Minutes >= 60).sort((a, b) => a.Title > b.Title).sort((a, b) => a.When > b.When).map(a => a.Id).slice(0, 100)

            var displayed = 0;
            for (var id of filmsEarliest.slice(0, galleryAmount)) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + makeFilmDetails(film, specificDate = true) + '</div>' +
                    '</a></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="2">Top ' + filmsEarliest.length + ' Earliest Released Feature Films</th></tr>');
            thead.append('<tr class="bottomheader"><th>Date</th><th>Title</th></tr>');

            for (var id of filmsEarliest) {
                var film = films.find(a => a.Id == id);
                var tooltip = '';
                if (film.Poster.length > 0) {
                    tooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                }
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                tbody.append(
                    '<tr>' +
                    '<td class="right' + tooltip + '">' + film.When + '</td>' +
                    '<td><a target="_blank" href="https://boxd.it/' + film.Id + '">' + title + '</a></td>' +
                    '</tr>');
            }

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[2, 0]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'asc' }
                }
            });

            makeInfo('Info', 'Show <a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/by/release-earliest/size/large/">all watched films by release date (oldest first)</a>.');

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showNewestReleasedFilms() {

            resetView(showNewestReleasedFilms, $(event.target));
            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">Top ' + galleryAmount + ' Newest Released Feature Films</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var filmsNewest = films.slice().filter(a => a.Minutes >= 60).sort((a, b) => a.Title > b.Title).sort((a, b) => b.When > a.When).map(a => a.Id).slice(0, 100)

            var displayed = 0;
            for (var id of filmsNewest.slice(0, galleryAmount)) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + makeFilmDetails(film, specificDate = true) + '</div>' +
                    '</a></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="2">Top ' + filmsNewest.length + ' Newest Released Feature Films</th></tr>');
            thead.append('<tr class="bottomheader"><th>Date</th><th>Title</th></tr>');

            for (var id of filmsNewest) {
                var film = films.find(a => a.Id == id);
                var tooltip = '';
                if (film.Poster.length > 0) {
                    tooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                }
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                tbody.append(
                    '<tr>' +
                    '<td class="right' + tooltip + '">' + film.When + '</td>' +
                    '<td><a target="_blank" href="https://boxd.it/' + film.Id + '">' + title + '</a></td>' +
                    '</tr>');
            }

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'asc' }
                }
            });

            makeInfo('Info', 'Show <a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/by/release-latest/size/large/">all watched films by release date (newest first)</a>.');

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        // === Attributes ===

        function showBAW() {

            resetView(showBAW, $(event.target));

            var filmsWatchedPerYear = {}
            for (var year = 1870; year <= new Date().getFullYear(); year++) {
                filmsWatchedPerYear[year] = 0
            }
            for (var film of films) {
                filmsWatchedPerYear[film.Year]++
            }

            if (documentWidth > 820) {
                showBAWChart(filmsWatchedPerYear);
            }

            var filmCount = films.filter(a => a.BlackAndWhite).length;

            $('body').append('<div class="boxes"></div>');
            $('.boxes').append(makeBox(filmCount + ' / ' + Math.round(filmCount / films.length * 100) + '%', 'Watched Black & White Films', (filmCount / films.length * 100).toFixed(2) + '%'));

            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">Black & White Films <span class="subtitle">starting with the most recently released</span></div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var matchingFilms = films.filter(a => a.BlackAndWhite).sort((a, b) => b.Year - a.Year);

            for (var film of matchingFilms) {
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img style="filter:grayscale(100%)" src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + makeFilmDetails(film) + '</div>' +
                    '</div>');
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showBAWChart(filmsWatchedPerYear) {

            $('body').append('<div id="outside"><div class="title">Black & White Films Watched by Release Year</div><figure class="highcharts-figure"><div id="container"></div></figure></div>');

            var cats = []
            var groups = []
            var counter = 0;
            var highest = 0;
            for (var a = 1900; a <= new Date().getFullYear(); a += 10) {
                cats.push(a + 's')
            }

            for (var a = 0; a < 10; a++) {
                var seriesBAW = {}, seriesAll = {};
                seriesBAW.color = 'black';
                seriesBAW.animation = false;
                seriesBAW.name = counter;
                seriesBAW.data = [];
                seriesBAW.pointPlacement = -0.02;
                seriesBAW.pointPadding = 0;
                seriesAll.color = document.documentElement.style.getPropertyValue('--secondary-colour');
                seriesAll.animation = false;
                seriesAll.name = counter++;
                seriesAll.data = [];
                seriesAll.pointPlacement = 0.03;
                seriesAll.pointPadding = 0;
                for (var b = 0; b < cats.length; b++) {
                    var year = 1900 + (b * 10) + a;
                    seriesAll.data.push(filmsWatchedPerYear[year]);
                    seriesBAW.data.push(films.filter(a => a.Year == year && a.BlackAndWhite == true).length);
                    highest = Math.max(highest, filmsWatchedPerYear[year] || 0);
                }
                groups.push(seriesAll);
                groups.push(seriesBAW);
            }

            Highcharts.chart('container', {
                chart: {
                    type: 'column',
                    width: 730,
                    height: 450,
                    spacingLeft: 0,
                    marginLeft: 70,
                },
                title: {
                    text: null,
                    enabled: false
                },
                subtitle: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    category: false,
                    categories: cats,
                    gridLineWidth: 1,
                    tickInterval: 1,
                    gridLineColor: '#ddd',
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Release Year'
                    }
                },
                yAxis: {
                    min: 0,
                    max: Math.ceil(highest / 10) * 10,
                    plotLines: [{
                        color: '#ddd',
                        value: 0,
                        width: 1,
                        zIndex: 5
                    }],
                    gridLineWidth: 1,
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Films Watched'
                    }
                },
                legend: {
                    enabled: false
                },
                tooltip: {
                    formatter: function () {
                        var year = 1900 + (this.point.x * 10) + +this.series.name;
                        var typeBlackAndWhite = 0, typeColour = 0;
                        typeBlackAndWhite = films.filter(a => a.Year == year && a.BlackAndWhite == true).length;
                        typeColour = filmsWatchedPerYear[year] - typeBlackAndWhite;
                        return (1900 + (this.point.x * 10) + this.series.name) + '<br/>' + typeColour + ' colour film' + (typeColour == 1 ? '' : 's') + '<br/>' + typeBlackAndWhite + ' black & white film' + (typeBlackAndWhite == 1 ? '' : 's');
                    }
                },
                plotOptions: {
                    column: {
                        borderWidth: 0,
                        states: {
                            hover: {
                                enabled: true
                            },
                            inactive: {
                                opacity: 1
                            }
                        }
                    },
                    series: {
                        groupPadding: 0,
                        pointWidth: 4,
                        borderRadius: 0,
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    var year = (1900 + (this.x * 10) + this.series.name);
                                    window.open('https://letterboxd.com/' + data.Username + '/films/year/' + year + '/by/name/size/large/', '_blank');
                                }
                            }
                        }
                    }
                },
                series: groups
            });
        }

        function showFilmsPerCountry() {

            resetView(showFilmsPerCountry, $(event.target));

            var filmsPerCountryOrigin = {}
            var filmsPerCountryProduction = {}

            for (var index in films) {
                var film = films[index]
                for (var prod of film.Countries_Origin) {
                    if (!filmsPerCountryOrigin[prod]) {
                        filmsPerCountryOrigin[prod] = [0, []]
                    }
                    filmsPerCountryOrigin[prod][0]++
                    filmsPerCountryOrigin[prod][1].push(index)
                }
                for (var prod of film.Countries_Production) {
                    if (!filmsPerCountryProduction[prod]) {
                        filmsPerCountryProduction[prod] = [0, []]
                    }
                    filmsPerCountryProduction[prod][0]++
                    filmsPerCountryProduction[prod][1].push(index)
                }
            }

            var isShowingMap = documentWidth >= 1000;

            if (isShowingMap) {
                $('body').append('<iframe id="mapFrame" src="map.html" width="978" height="586"></iframe>');
            }

            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox(Object.values(filmsPerCountryOrigin).length, 'Origin Countries'));

            createNewTable();

            var highlights = [];

            if (documentWidth < 500) {
                thead.append('<tr class="topheader"><th colspan="3">Origin Countries</th></tr>');
                thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th></tr>');
            } else {
                thead.append('<tr class="topheader"><th colspan="4">Origin Countries</th></tr>');
                thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th><th>&#x25AC;</th></tr>');
            }

            var highest = films.length;
            for (var country in filmsPerCountryOrigin) {
                highest = Math.max(highest, filmsPerCountryOrigin[country][0]);
            }

            for (var country in filmsPerCountryOrigin) {
                var percent = (filmsPerCountryOrigin[country][0] / films.length) * 100;
                var bar = '';
                if (documentWidth >= 500) {
                    bar = '<td class="chart" data-value="' + filmsPerCountryOrigin[country][0] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((filmsPerCountryOrigin[country][0] / highest) * 100) + 'px">&nbsp;</span></span></td>';
                }

                var iso = flagCode(country.toLowerCase());
                var imageLocation = "https://raw.githubusercontent.com/joielechong/iso-country-flags-svg-collection/refs/heads/master/svg/country-4x3/" + iso + ".svg";
                countryLabel = countryCodeToName(country)
                var url = 'https://letterboxd.com/' + data.Username + '/films/country/' + countryNameToUrl(countryLabel) + '/by/name/size/large/';
                highlights.push([country, url, '<img src="' + imageLocation + '" class="flag" /> ' + countryLabel, filmsPerCountryOrigin[country][0], 0]);

                var tooltip = makeFilmListTooltip(filmsPerCountryOrigin[country][1]);

                tbody.append(
                    '<tr>' +
                    '<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/country/' + countryNameToUrl(countryLabel) + '/by/name/size/large/"><img src="' + imageLocation + '" class="flag" /> ' + countryLabel + '</a></td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + filmsPerCountryOrigin[country][0] + '</td>' +
                    '<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + filmsPerCountryOrigin[country][0] + '">' + percent.toFixed(0) + '%</td>' +
                    bar +
                    '</tr>');
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1], [0, 0]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'asc' },
                    2: { sortInitialOrder: 'desc' },
                    3: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    4: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox(Object.values(filmsPerCountryProduction).length, 'Production Countries'));

            createNewTable();

            if (documentWidth < 500) {
                thead.append('<tr class="topheader"><th colspan="3">Production Countries</th></tr>');
                thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th></tr>');
            } else {
                thead.append('<tr class="topheader"><th colspan="4">Production Countries</th></tr>');
                thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th><th>&#x25AC;</th></tr>');
            }

            var highest = films.length;
            for (var country in filmsPerCountryProduction) {
                highest = Math.max(highest, filmsPerCountryProduction[country][0]);
            }

            for (var country in filmsPerCountryProduction) {
                var percent = (filmsPerCountryProduction[country][0] / films.length) * 100;
                var bar = '';
                if (documentWidth >= 500) {
                    bar = '<td class="chart" data-value="' + filmsPerCountryProduction[country][0] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((filmsPerCountryProduction[country][0] / highest) * 100) + 'px">&nbsp;</span></span></td>';
                }
                var iso = flagCode(country.toLowerCase());
                var imageLocation = "https://raw.githubusercontent.com/joielechong/iso-country-flags-svg-collection/refs/heads/master/svg/country-4x3/" + iso + ".svg";
                countryLabel = countryCodeToName(country);
                var url = 'https://letterboxd.com/' + data.Username + '/films/country/' + countryNameToUrl(countryLabel) + '/by/name/size/large/';

                var tooltip = makeFilmListTooltip(filmsPerCountryProduction[country][1]);
                tbody.append(
                    '<tr>' +
                    '<td><a target="_blank" href="' + url + '"><img src="' + imageLocation + '" class="flag" /> ' + countryLabel + '</a></td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + filmsPerCountryProduction[country][0] + '</td>' +
                    '<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + filmsPerCountryProduction[country][0] + '">' + percent.toFixed(0) + '%</td>' +
                    bar +
                    '</tr>');
                var countryExists = highlights.findIndex(a => a[0] == country);
                if (countryExists >= 0) {
                    highlights[countryExists][4] = filmsPerCountryProduction[country][0];
                } else {
                    highlights.push([country, url, '<img src="' + imageLocation + '" class="flag" /> ' + countryLabel, 0, filmsPerCountryProduction[country][0]]);
                }
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1], [0, 0]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'asc' },
                    2: { sortInitialOrder: 'desc' },
                    3: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    4: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            makeInfo(
                'Note',
                'Country information is obtained from TMDB, which is sometimes different to Letterboxd.<br/>' +
                '<br/>Percentages add to more than 100% because many films are created/produced by more than one country.');

            if (isShowingMap) {
                document.getElementById('mapFrame').onload = function () {
                    var iframe = document.getElementById('mapFrame');
                    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    var countries = iframeDoc.querySelectorAll('.svgMap-country');
                    countries.forEach(function (country) {
                        country.setAttribute('fill', '#bbb');
                    });
                    Object.keys(countryCodes).forEach(function (row) {
                        if (highlights.findIndex(a => a[0] == row) <= 0) {
                            var url = 'https://letterboxd.com/films/popular/country/' + countryNameToUrl(countryCodeToName(row)) + '/size/large/';
                            var iso = flagCode(row.toLowerCase());
                            var imageLocation = "https://raw.githubusercontent.com/joielechong/iso-country-flags-svg-collection/refs/heads/master/svg/country-4x3/" + iso + ".svg";
                            var title = '<img src="' + imageLocation + '" class="flag" /> ' + countryCodeToName(row)
                            var place = iframeDoc.querySelectorAll('.svgMap-country[data-id="' + row + '"]');
                            place.forEach(function (country) {
                                country.classList.add('clickable');
                                country.addEventListener('click', function () {
                                    window.open(url);
                                });
                                country.addEventListener('mouseenter', function () {
                                    var infoParagraph = iframeDoc.querySelector('#hover');
                                    infoParagraph.innerHTML = title + '<br/>No matching films';
                                    country.classList.add('hovered');
                                });
                                country.addEventListener('mouseleave', function () {
                                    var infoParagraph = iframeDoc.querySelector('#hover');
                                    infoParagraph.innerHTML = '';
                                    country.classList.remove('hovered');
                                });
                            });
                        }
                    });

                    highlights.forEach(function (row) {
                        var place = iframeDoc.querySelectorAll('.svgMap-country[data-id="' + row[0] + '"]');
                        place.forEach(function (country) {
                            country.setAttribute('fill', '#008800');
                            if (row[3] == 0) {
                                country.setAttribute('opacity', '0.5');
                            }
                            country.classList.add('clickable');
                            country.addEventListener('click', function () {
                                window.open(row[1]);
                            });
                            country.addEventListener('mouseenter', function () {
                                var infoParagraph = iframeDoc.querySelector('#hover');
                                infoParagraph.innerHTML = row[2] + '<br/>Originated Films: ' + row[3] + ' ◆ Produced Films: ' + row[4];
                                country.classList.add('hovered');
                            });
                            country.addEventListener('mouseleave', function () {
                                var infoParagraph = iframeDoc.querySelector('#hover');
                                infoParagraph.innerHTML = '';
                                country.classList.remove('hovered');
                            });
                        })
                    })
                };
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showGenres() {

            resetView(showGenres, $(event.target));

            createNewTable();

            if (documentWidth < 600) {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="2">Films</th><th>Rating</th></tr>');
                thead.append('<tr class="bottomheader"><th>Genre</th><th>Σ</th><th>%</th><th>Average</th></tr>');
            } else {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th><th colspan="2">Rating</th></tr>');
                thead.append('<tr class="bottomheader"><th>Genre</th><th>Σ</th><th>%</th><th>&#x25AC;</th><th>Average</th><th>&#x25AC;</th></tr>');
            }

            var genres = {}, genreSets = {}
            for (var index in films) {
                var film = films[index];
                if (film.Genres.length) {
                    for (var genre of film.Genres) {
                        if (!genres[genre]) {
                            genres[genre] = { Count: 0, RatingCount: 0, RatingTotal: 0, Films: [] }
                        }
                        genres[genre].Count++;
                        genres[genre].Films.push(index);
                        if (film.RatingSelf) {
                            genres[genre].RatingCount++;
                            genres[genre].RatingTotal += film.RatingSelf;
                        }
                    }
                    var genresCombined = film.Genres.join(', ');
                    if (!genreSets[genresCombined]) {
                        genreSets[genresCombined] = { Count: 0, RatingCount: 0, RatingTotal: 0, Films: [] }
                    }
                    genreSets[genresCombined].Count++;
                    genreSets[genresCombined].Films.push(index);
                    if (film.RatingSelf) {
                        genreSets[genresCombined].RatingCount++;
                        genreSets[genresCombined].RatingTotal += film.RatingSelf;
                    }
                }
            }

            var highest = 0;
            for (var genre in genres) {
                highest = Math.max(highest, genres[genre].Count);
            }

            var highestRating = 5;
            for (var genre in genres) {
                var rating = "";
                if (genres[genre].RatingCount > 0) {
                    rating = (genres[genre].RatingTotal / genres[genre].RatingCount).toFixed(1);
                    highestRating = Math.max(rating, highestRating);
                }
            }

            for (var genre in genres) {
                var rating = "";
                if (genres[genre].RatingCount > 0) {
                    rating = (genres[genre].RatingTotal / genres[genre].RatingCount).toFixed(1);
                }

                var watchedPercent = (genres[genre].Count / films.length) * 100;
                var lowBase = genres[genre].RatingCount < sufficientBase;
                var barAmount = '', barRating = '';
                var tooltip = makeFilmListTooltip(genres[genre].Films);

                if (documentWidth >= 600) {
                    barAmount = '<td class="chart" data-value="' + genres[genre].Count + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((genres[genre].Count / films.length) * 100) + 'px">&nbsp;</span></span></td>';
                    barRating = '<td class="' + (lowBase ? 'lowbase ' : '') + 'chart" data-value="' + rating + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((rating / highestRating) * 100) + 'px">&nbsp;</span></span></td>';
                }

                tbody.append(
                    '<tr>' +
                    '<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/genre/' + genre.toLowerCase().replace(/ /g, '-') + '/by/name/size/large/">' + genre + '</a></td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + genres[genre].Count + '</td>' +
                    '<td class="right ttt" data-tooltip="' + watchedPercent.toFixed(2) + '%" data-value="' + genres[genre].Count + '">' + watchedPercent.toFixed(0) + '%</td>' +
                    barAmount +
                    '<td class="' + (lowBase ? 'lowbase ' : '') + 'right ttt" data-tooltip="Based on ' + genres[genre].RatingCount + ' rated film(s)."><span>' + rating + '</span></td>' +
                    barRating +
                    '</tr>');
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            if (documentWidth < 600) {
                $('#main').tablesorter({
                    widgets: ['columns'],
                    usNumberFormat: true,
                    sortReset: false,
                    sortRestart: false,
                    sortList: [[1, 1]],
                    headers: {
                        0: { sorter: false },
                        1: { sorter: false },
                        2: { sorter: false },
                        3: { sortInitialOrder: 'asc' },
                        4: { sortInitialOrder: 'desc' },
                        5: { sortInitialOrder: 'desc', sorter: 'data-value' },
                        6: { sortInitialOrder: 'desc' },
                    },
                    cssHeaderRow: "tablesorter-headerRow"
                });
            } else {
                $('#main').tablesorter({
                    widgets: ['columns'],
                    usNumberFormat: true,
                    sortReset: false,
                    sortRestart: false,
                    sortList: [[1, 1]],
                    headers: {
                        0: { sorter: false },
                        1: { sorter: false },
                        2: { sorter: false },
                        3: { sortInitialOrder: 'asc' },
                        4: { sortInitialOrder: 'desc' },
                        5: { sortInitialOrder: 'desc', sorter: 'data-value' },
                        6: { sortInitialOrder: 'desc', sorter: 'data-value' },
                        7: { sortInitialOrder: 'desc' },
                        8: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    },
                    cssHeaderRow: "tablesorter-headerRow"
                });
            }

            // sets

            createNewTable();

            if (documentWidth < 600) {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="2">Films</th><th>Rating</th></tr>');
                thead.append('<tr class="bottomheader"><th>Top Genre Sets</th><th>Σ</th><th>%</th><th>Average</th></tr>');
            } else {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th><th colspan="2">Rating</th></tr>');
                thead.append('<tr class="bottomheader"><th>Top Genre Sets</th><th>Σ</th><th>%</th><th>&#x25AC;</th><th>Average</th><th>&#x25AC;</th></tr>');
            }

            var highest = 0;
            for (var key in genreSets) {
                highest = Math.max(highest, genreSets[key].Count);
            }

            var highestRating = 5;
            for (var key in genreSets) {
                var rating = "";
                if (genreSets[key].RatingCount > 0) {
                    rating = (genreSets[key].RatingTotal / genreSets[key].RatingCount).toFixed(1);
                    highestRating = Math.max(rating, highestRating);
                }
            }

            let genreArray = Object.entries(genreSets);
            genreArray.sort();
            genreArray.sort((a, b) => b[1].Count - a[1].Count);
            let sortedGenreSets = Object.fromEntries(genreArray);
            genreSets = sortedGenreSets;

            var count = 0;
            for (var key in genreSets) {
                var rating = "";
                if (genreSets[key].RatingCount > 0) {
                    rating = (genreSets[key].RatingTotal / genreSets[key].RatingCount).toFixed(1);
                }

                var watchedPercent = (genreSets[key].Count / films.length) * 100;
                var lowBase = genreSets[key].RatingCount < sufficientBase;
                var barAmount = '', barRating = '';
                var tooltip = makeFilmListTooltip(genreSets[key].Films);

                if (documentWidth >= 600) {
                    barAmount = '<td class="chart" data-value="' + genreSets[key].Count + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((genreSets[key].Count / films.length) * 100) + 'px">&nbsp;</span></span></td>';
                    barRating = '<td class="' + (lowBase ? 'lowbase ' : '') + 'chart" data-value="' + rating + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((rating / highestRating) * 100) + 'px">&nbsp;</span></span></td>';
                }

                tbody.append(
                    '<tr>' +
                    '<td>' + key + '</td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + genreSets[key].Count + '</td>' +
                    '<td class="right ttt" data-tooltip="' + watchedPercent.toFixed(2) + '%" data-value="' + genreSets[key].Count + '">' + watchedPercent.toFixed(0) + '%</td>' +
                    barAmount +
                    '<td class="' + (lowBase ? 'lowbase ' : '') + 'right ttt" data-tooltip="Based on ' + genreSets[key].RatingCount + ' rated film(s)."><span>' + rating + '</span></td>' +
                    barRating +
                    '</tr>');

                count++;
                if (count >= 10) {
                    break;
                }
            }

            if (documentWidth < 600) {
                table.tablesorter({
                    widgets: ['columns'],
                    usNumberFormat: true,
                    sortReset: false,
                    sortRestart: false,
                    sortList: [[1, 1]],
                    headers: {
                        0: { sorter: false },
                        1: { sorter: false },
                        2: { sorter: false },
                        3: { sortInitialOrder: 'asc' },
                        4: { sortInitialOrder: 'desc' },
                        5: { sortInitialOrder: 'desc', sorter: 'data-value' },
                        6: { sortInitialOrder: 'desc' },
                    },
                    cssHeaderRow: "tablesorter-headerRow"
                });
            } else {
                table.tablesorter({
                    widgets: ['columns'],
                    usNumberFormat: true,
                    sortReset: false,
                    sortRestart: false,
                    sortList: [[1, 1]],
                    headers: {
                        0: { sorter: false },
                        1: { sorter: false },
                        2: { sorter: false },
                        3: { sortInitialOrder: 'asc' },
                        4: { sortInitialOrder: 'desc' },
                        5: { sortInitialOrder: 'desc', sorter: 'data-value' },
                        6: { sortInitialOrder: 'desc', sorter: 'data-value' },
                        7: { sortInitialOrder: 'desc' },
                        8: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    },
                    cssHeaderRow: "tablesorter-headerRow"
                });
            }

            createTooltipTriggers();

            makeInfo('Note', 'Genre information is obtained from TMDB, which is sometimes different to Letterboxd.');

            deactivateAll();
            if (event) {
                $(event.target).addClass('active');
            }
        }

        function showFilmsPerLanguages() {

            resetView(showFilmsPerLanguages, $(event.target));

            var languages = []
            for (var index in films) {
                var film = films[index]
                var lang = film.Language || 'No Spoken Language'
                var where = languages.findIndex(a => a[0] == lang)
                if (where >= 0) {
                    languages[where][1]++
                    languages[where][2].push(index)
                } else {
                    languages.push([lang, 1, [index]])
                }
            }

            languages = languages.sort((a, b) => a[0] > b[0]).sort((a, b) => a[1] - b[1])

            $('body').append('<div class="boxes"></div>');
            $('.boxes').append(makeBox(languages.length, 'Primary Languages'));

            createNewTable();

            if (documentWidth < 500) {
                thead.append('<tr><th>Primary Language</th><th>Films #</th><th>Films %</th></tr>');
            } else {
                thead.append('<tr><th>Primary Language</th><th>Films #</th><th>Films %</th><th>&#x25AC;</th></tr>');
            }

            var highest = 0;
            for (var language of languages) {
                highest = Math.max(highest, language[1]);
            }
            highest = films.length

            for (var language of languages) {
                var percent = (language[1] / films.length) * 100;
                var bar = '';
                if (documentWidth >= 500) {
                    bar = '<td class="chart" data-value="' + language[1] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((language[1] / highest) * 100) + 'px">&nbsp;</span></span></td>';
                }
                var tooltip = makeFilmListTooltip(language[2]);
                tbody.append(
                    '<tr>' +
                    '<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/language/' + letterboxdLanguage(language[0]) + '/by/name/size/large/">' + (language[0] || 'No Spoken Language') + '</a></td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + language[1] + '</td>' +
                    '<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + language[1] + '">' + percent.toFixed(0) + '%</td>' +
                    bar +
                    '</tr>');
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1]],
                headers: {
                    0: { sortInitialOrder: 'desc' },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    3: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            deactivateAll();
            $(event.target).addClass('active');

            makeInfo('Note', 'Language information is obtained from TMDB, which is sometimes different to Letterboxd.');

            createTooltipTriggers();
        }

        function showLengthStats() {

            resetView(showLengthStats, $(event.target));

            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">Longest Films</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var filmsByLength = films.slice().sort((a, b) => a.Title > b.Title).sort((a, b) => b.Minutes - a.Minutes).map(a => a.Id).slice(0, galleryAmount)

            var displayed = 0;
            for (var id of filmsByLength) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                var hours = 0, minutes = 0;
                hours = Math.floor(film.Minutes / 60);
                minutes = film.Minutes - (hours * 60);
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + hours + '<span style="opacity:0.666">h</span> ' + String(minutes).padStart(1, '0') + '<span style="opacity:0.666">m</span><br/>' + makeFilmDetails(film) + '</div>' +
                    '</a></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            var filmsWithRuntime = 0, totalMinutes = 0
            var filmsWithRuntimeAll = 0, totalMinutesAll = 0

            for (var film of films) {
                if (film.Minutes > 60) {
                    filmsWithRuntime++
                    totalMinutes += film.Minutes
                }
                if (film.Minutes > 0) {
                    filmsWithRuntimeAll++
                    totalMinutesAll += film.Minutes
                }
            }

            if (totalMinutes) {
                var len = totalMinutes / filmsWithRuntime;
                len += 0.5; // this accounts for all film times being rounded down to the minute
                var seconds = len % 1;
                len = Math.floor(len);
                var lenLabel =
                    Math.floor(len / 60) + '<span style="opacity:0.333">h</span> ' +
                    ((len % 60) + '').padStart(2, '0') + '<span style="opacity:0.333">m</span> ' +
                    (Math.floor(60 * seconds) + '').padStart(2, '0') + '<span style="opacity:0.333">s</span>';

                $('body').append('<div class="boxes"></div>');
                $('.boxes').last().append(makeBox(lenLabel, 'Average Feature Film Length'));
            }

            createNewTable();

            thead.append('<tr><th>Stat</th><th class="right">Amount</th></tr>');

            //tbody.append('<tr><td>Total Films</td><td class="right">' + films.length + '</td></tr>');
            //tbody.append('<tr class="breaker"><td>Total Rated Films</td><td class="right">' + data.RatedFilms + '</td></tr>');
            tbody.append('<tr><td>Watched Minutes</td><td class="right">' + totalMinutesAll.toLocaleString() + '</td></tr>');
            tbody.append('<tr><td>Watched Hours</td><td class="right">' + Math.round(totalMinutesAll / 60).toLocaleString() + '</td></tr>');
            tbody.append('<tr><td>Watched Days</td><td class="right">' + Math.round(totalMinutesAll / 60 / 24).toLocaleString() + '</td></tr>');
            tbody.append('<tr class="breaker"><td>Watched Weeks</td><td class="right">' + Math.round(totalMinutesAll / 60 / 24 / 7).toLocaleString() + '</td></tr>');
            //tbody.append('<tr><td>Average Film Length&nbsp;</td><td class="right">&nbsp;' + lenLabel + '</td></tr>');

            createNewTable();

            if (documentWidth < 500) {
                thead.append('<tr><th>Length</th><th>Films Σ</th><th>Films %</th></tr>');
            } else {
                thead.append('<tr><th>Length</th><th>Films Σ</th><th>Films %</th><th>&#x25AC;</th></tr>');
            }

            var longest = Math.max(...films.map(a => a.Minutes));
            var filmsPerThirtyMinutes = {}
            for (var m = 0; m <= Math.floor(longest / 30) * 30; m += 30) {
                filmsPerThirtyMinutes[m] = [0, []]
            }

            for (var index in films) {
                var film = films[index]
                var bucket = Math.floor(film.Minutes / 30) * 30
                filmsPerThirtyMinutes[bucket][0]++
                filmsPerThirtyMinutes[bucket][1].push(index)
            }

            var highest = filmsWithRuntimeAll, total = 0;
            for (var thirty in filmsPerThirtyMinutes) {
                highest = Math.max(highest, filmsPerThirtyMinutes[thirty][0]);
            }

            var isEmpty = false;
            for (var thirty in filmsPerThirtyMinutes) {
                //var label = (thirty / 60).toFixed(1) + "h <= x < " + ((+thirty + 30) / 60).toFixed(1) + "h";
                var number = +thirty;
                var label =
                    Math.floor(number / 60) + "h" + (number % 60 == 0 ? '00' : '30') + "m" +
                    " to " +
                    Math.floor(number / 60) + "h" + (number % 60 == 0 ? '29' : '59') + "m";
                var percent = (filmsPerThirtyMinutes[thirty][0] / films.length) * 100;
                var bar = '';
                if (filmsPerThirtyMinutes[thirty][0] == 0) {
                    if (!isEmpty) {
                        if (documentWidth >= 500) {
                            bar = '<td class="chart" data-value="' + filmsPerThirtyMinutes[thirty][0] + '">&nbsp;</td>';
                        }
                        tbody.append(
                            '<tr>' +
                            '<td data-value="' + number + '">-</td>' +
                            '<td class="right">-</td>' +
                            '<td class="right" data-value="' + filmsPerThirtyMinutes[thirty][0] + '">-</td>' +
                            bar +
                            '</tr>');
                    }
                    isEmpty = true;
                } else {
                    var tooltip = makeFilmListTooltip(filmsPerThirtyMinutes[thirty][1]);
                    if (documentWidth >= 500) {
                        bar = '<td class="chart" data-value="' + filmsPerThirtyMinutes[thirty][0] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((filmsPerThirtyMinutes[thirty][0] / highest) * 100) + 'px">&nbsp;</span></span></td>';
                    }
                    tbody.append(
                        '<tr>' +
                        '<td data-value="' + number + '">' + label + '</td>' +
                        '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + filmsPerThirtyMinutes[thirty][0] + '</td>' +
                        '<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + filmsPerThirtyMinutes[thirty][0] + '">' + percent.toFixed(0) + '%</td>' +
                        bar +
                        '</tr>');
                    isEmpty = false;
                }
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 0]],
                headers: {
                    0: { sortInitialOrder: 'asc', sorter: 'data-value' },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    3: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            if (documentWidth > 880) {
                showFilmLengthChart();
            }

            createTooltipTriggers();

            deactivateAll();
            if (event) {
                $(event.target).addClass('active');
            }
        }

        function showFilmLengthChart() {

            const MaximumHours = 4;

            var filmsByLength = Array(1000);
            var minutes = Array(1000);
            for (var a = 0; a < minutes.length; a++) {
                if (a <= MaximumHours * 60) {
                    minutes[a] = 0;
                    filmsByLength[a] = [];
                }
            }
            var highest = 30;
            for (var index in films) {
                var film = films[index];
                if (film.Minutes > 1) {
                    if (film.Minutes <= MaximumHours * 60) {
                        minutes[+film.Minutes]++;
                        highest = Math.max(highest, film.Minutes);
                        filmsByLength[+film.Minutes].push(index);
                    }
                }
            }

            highest += 10 - (highest % 10)

            $('body').append('<div id="outside"><div class="title">Films Watched by Length <span class="subtitle">capped at ' + MaximumHours + ' hours</span></div><figure class="highcharts-figure"><div id="container"></div></figure></div>');

            var cats = [];
            var values = [];

            for (var a = 0; a <= highest; a++) {
                cats.push(a)
                values.push(minutes[a])
            }

            Highcharts.chart('container', {
                chart: {
                    type: 'column',
                    width: 802,
                    height: 450,
                    spacingLeft: 100,
                    marginLeft: 70,
                },
                title: {
                    text: null,
                    enabled: false,
                },
                credits: {
                    enabled: false
                },
                legend: {
                    enabled: false
                },
                xAxis: {
                    category: false,
                    categories: cats,
                    tickInterval: 30,
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Minutes'
                    }
                },
                yAxis: {
                    plotLines: [{
                        color: '#ddd',
                        value: 0,
                        width: 1,
                        zIndex: 5
                    }],
                    gridLineWidth: 1,
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Films Watched'
                    }
                },
                tooltip: {
                    formatter: function () {
                        var hours = 0, minutes = 0;
                        hours = Math.floor(this.point.x / 60);
                        minutes = this.point.x - (hours * 60);
                        return hours + 'h' + minutes + 'm<br/>' +
                            this.point.y + ' film' + (this.point.y == 1 ? '' : 's')
                    }
                },
                plotOptions: {
                    column: {
                        pointPadding: 0,
                        borderWidth: 0,
                        dataLabels: {
                            enabled: false,
                            align: 'center',
                            x: 3
                        },
                        states: {
                            hover: {
                                color: document.documentElement.style.getPropertyValue('--secondary-colour'),
                                enabled: true
                            },
                            inactive: {
                                opacity: 1
                            }
                        }
                    },
                },
                series: [
                    {
                        groupPadding: 0,
                        pointWidth: 2,
                        borderRadius: 0,
                        name: '',
                        animation: false,
                        color: 'black',
                        data: values,
                        enableMouseTracking: true,
                        borderRadius: 0,
                        cursor: 'zoom-in',
                        point: {
                            events: {
                                click: function () {
                                    showFilms(filmsByLength[this.x].join(' '));
                                }
                            }
                        }
                    }
                ]
            });
        }

        function showStudios() {

            resetView(showStudios, $(event.target));

            var studios = []
            for (var filmIndex in films) {
                var film = films[filmIndex]
                for (var index of film.Studios) {
                    var studio = data.Studios[index];
                    if (!studios.some(a => a.Id == studio.Id)) {
                        var s = {};
                        for (var key of Object.keys(studio)) {
                            s[key] = studio[key];
                        }
                        s.Amount = 0;
                        s.Films = [];
                        studios.push(s);
                    }
                    var i = studios.findIndex(a => a.Id == studio.Id);
                    studios[i].Amount++;
                    studios[i].Films.push(filmIndex);
                }
            }

            studios = studios.sort((a, b) => a.Title > b.Title);
            studios = studios.sort((a, b) => b.Amount - a.Amount);
            var minimum = studios[100] ? studios[100].Amount : 1;
            studios = studios.filter(a => a.Amount >= minimum)

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Most Watched Studios</th></tr>');
            thead.append('<tr class="bottomheader"><th>Name</th><th>Country</th><th>Amount</th></tr>');

            for (var index in studios) {
                var studio = studios[index];
                var cleaned = letterboxdStudioId(urlSafe(studio.Title.replace(/ /g, '-').toLowerCase()));
                var url = 'https://letterboxd.com/studio/' + cleaned + '/';
                var iso = flagCode(studio.OriginCountry.toLowerCase());
                var imageLocation = "https://raw.githubusercontent.com/joielechong/iso-country-flags-svg-collection/refs/heads/master/svg/country-4x3/" + iso + ".svg";
                var tooltip = '';
                if (studio.Poster.length > 0) {
                    tooltip = ' class="ttt" data-tooltip="<img class=\'studio\' src=\'https://image.tmdb.org/t/p/h100/' + studio.Poster + '\'>"';
                }
                var tooltipFilms = makeFilmListTooltip(studio.Films);
                tbody.append(
                    '<tr>' +
                    '<td' + tooltip + '><a target="_blank" href="' + url + '">' + studio.Title + '</a></td>' +
                    '<td>' + (studio.OriginCountry ? '<img src="' + imageLocation + '" class="flag" /> ' : '') + countryCodeToName(studio.OriginCountry).replace('United States of America', 'USA') + '</td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltipFilms.join('<br>') + '">' + studio.Amount + '</td>' +
                    '</tr>');
            }

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[2, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'asc' },
                    3: { sortInitialOrder: 'desc' },
                }
            });

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showThemes() {

            resetView(showThemes, $(event.target));

            makeInfo('Warning', 'At Letterboxd, themes are an experimental feature powered by AI. Consequently many films are wrongly tagged, are missing themes, or don\'t appear in search results.');

            createNewTable();

            if (documentWidth < 600) {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="2">Films</th></tr>');
                thead.append('<tr class="bottomheader"><th>Overall Theme</th><th>Σ</th><th>%</th></tr>');
            } else {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th></tr>');
                thead.append('<tr class="bottomheader"><th>Overall Theme</th><th>Σ</th><th>%</th><th>&#x25AC;</th></tr>');
            }

            var filmsWithThemes = 0;
            var themes = []
            for (var filmIndex in films) {
                var film = films[filmIndex]
                if (film.Themes.length) {
                    filmsWithThemes++;
                }
                for (var index of film.Themes) {
                    var theme = data.Themes[index];
                    if (!themes.some(a => a.Text == theme.Text)) {
                        var t = {};
                        for (var key of Object.keys(theme)) {
                            t[key] = theme[key];
                        }
                        t.Amount = 0;
                        t.Films = [];
                        themes.push(t);
                    }
                    var i = themes.findIndex(a => a.Text == theme.Text);
                    themes[i].Amount++;
                    themes[i].Films.push(filmIndex);
                }
            }

            themes = themes.sort((a, b) => a.Text > b.Text);
            themes = themes.sort((a, b) => b.Amount - a.Amount);

            for (var index in themes) {
                var theme = themes[index];
                if (!theme.IsMini) {
                    var watchedPercent = (theme.Amount / filmsWithThemes) * 100;
                    var barAmount = '';
                    if (documentWidth >= 600) {
                        barAmount = '<td class="chart" data-value="' + theme.Amount + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((theme.Amount / filmsWithThemes) * 100) + 'px">&nbsp;</span></span></td>';
                    }
                    var tooltipFilms = makeFilmListTooltip(theme.Films);
                    tbody.append(
                        '<tr>' +
                        '<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/' + theme.Url + '/size/large/">' + theme.Text + '</a></td>' +
                        '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltipFilms.join('<br>') + '">' + theme.Amount + '</td>' +
                        '<td class="right ttt" data-tooltip="' + watchedPercent.toFixed(2) + '%" data-value="' + theme.Amount + '">' + watchedPercent.toFixed(0) + '%</td>' +
                        barAmount +
                        '</tr>');
                }
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sorter: false },
                    2: { sortInitialOrder: 'asc' },
                    3: { sortInitialOrder: 'desc' },
                    4: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    5: { sorter: false }
                },
                cssHeaderRow: "tablesorter-headerRow"
            });

            createNewTable();

            if (documentWidth < 600) {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="2">Films</th></tr>');
                thead.append('<tr class="bottomheader"><th>Specific Theme</th><th>Σ</th><th>%</th></tr>');
            } else {
                thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th></tr>');
                thead.append('<tr class="bottomheader"><th>Specific Theme</th><th>Σ</th><th>%</th><th>&#x25AC;</th></tr>');
            }

            for (var index in themes) {
                var theme = themes[index];
                if (theme.IsMini) {
                    var watchedPercent = (theme.Amount / filmsWithThemes) * 100;
                    var barAmount = '';
                    if (documentWidth >= 600) {
                        barAmount = '<td class="chart" data-value="' + theme.Amount + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((theme.Amount / filmsWithThemes) * 100) + 'px">&nbsp;</span></span></td>';
                    }
                    var tooltipFilms = makeFilmListTooltip(theme.Films);
                    tbody.append(
                        '<tr>' +
                        '<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/' + theme.Url + '/size/large/">' + theme.Text + '</a></td>' +
                        '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltipFilms.join('<br>') + '">' + theme.Amount + '</td>' +
                        '<td class="right ttt" data-tooltip="' + watchedPercent.toFixed(2) + '%" data-value="' + theme.Amount + '">' + watchedPercent.toFixed(0) + '%</td>' +
                        barAmount +
                        '</tr>');
                }
            }

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sorter: false },
                    2: { sortInitialOrder: 'asc' },
                    3: { sortInitialOrder: 'desc' },
                    4: { sortInitialOrder: 'desc', sorter: 'data-value' },
                    5: { sorter: false }
                },
                cssHeaderRow: "tablesorter-headerRow"
            });

            createNewTable();

            thead.append('<tr class="header"><th>Most Frequent Nanogenres</th><th>Films Σ</th></tr>');

            var nanogenres = []
            for (var filmIndex in films) {
                var film = films[filmIndex]
                for (var index of film.Nanogenres) {
                    var nanogenre = data.Nanogenres[index];
                    if (!nanogenres.some(a => a.Text == nanogenre.Text)) {
                        var n = {};
                        for (var key of Object.keys(nanogenre)) {
                            n[key] = nanogenre[key];
                        }
                        n.Amount = 0;
                        n.Films = [];
                        nanogenres.push(n);
                    }
                    var i = nanogenres.findIndex(a => a.Text == nanogenre.Text);
                    nanogenres[i].Amount++;
                    nanogenres[i].Films.push(filmIndex);
                }
            }

            nanogenres = nanogenres.sort((a, b) => a.Text > b.Text);
            nanogenres = nanogenres.sort((a, b) => b.Amount - a.Amount);
            var min = Math.max(2, nanogenres.length > 100 ? nanogenres[100].Amount : 0);
            nanogenres = nanogenres.filter(a => a.Amount >= min);

            for (var index in nanogenres) {
                var nanogenre = nanogenres[index];
                var watchedPercent = (nanogenre.Amount / filmsWithThemes) * 100;
                var barAmount = '';
                var tooltipFilms = makeFilmListTooltip(nanogenre.Films);
                tbody.append(
                    '<tr>' +
                    '<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/nanogenre/' + nanogenre.Url + '/size/large/">' + nanogenre.Text + '</a></td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltipFilms.join('<br>') + '">' + nanogenre.Amount + '</td>' +
                    '</tr>');
            }

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1]],
                headers: {
                    0: { sortInitialOrder: 'asc' },
                    1: { sortInitialOrder: 'desc' },
                },
                cssHeaderRow: "tablesorter-headerRow"
            });

            createTooltipTriggers();

            deactivateAll();
            if (event) {
                $(event.target).addClass('active');
            }
        }

        function showTitles() {

            resetView(showTitles, $(event.target));
            createNewTable();

            thead.append('<tr class="topheader"><th colspan="2">Longest Titles</th></tr>');
            thead.append('<tr class="bottomheader"><th>Year</th><th>Title</th></tr>');

            var filmsLongestTitles = [...films].sort((a, b) => a.Title > b.Title).sort((a, b) => b.Title.length > a.Title.length).map(a => a.Id).slice(0, galleryAmount);

            var displayed = 0;
            for (var id of filmsLongestTitles) {
                var film = films.find(a => a.Id == id);
                var tooltip = '';
                if (film.Poster && film.Poster.length > 0) {
                    tooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                }
                tbody.append(
                    '<tr>' +
                    '<td class="right' + tooltip + '">' + film.Year + '</td>' +
                    '<td class="mono"><a target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
                    '</tr>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                headers: {
                    0: { sorter: false },
                    1: { sorter: false },
                    2: { sorter: false },
                }
            });

            var filmsShortestTitles = films.slice().filter(a => a.Title.length <= 3).sort((a, b) => a.Title > b.Title).sort((a, b) => a.Title.length > b.Title.length).map(a => a.Id);

            if (filmsShortestTitles.length) {

                createNewTable();

                thead.append('<tr class="topheader"><th colspan="2">Titles: 3 Characters or Fewer</th></tr>');
                thead.append('<tr class="bottomheader"><th>Year</th><th style="width:200px;">Title</th></tr>');

                displayed = 0;
                for (var id of filmsShortestTitles) {
                    var film = films.find(a => a.Id == id);
                    var tooltip = '';
                    if (film.Poster && film.Poster.length > 0) {
                        tooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                    }
                    tbody.append(
                        '<tr>' +
                        '<td class="right' + tooltip + '">' + film.Year + '</td>' +
                        '<td class="mono"><a target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
                        '</tr>');
                    displayed++;
                    if (displayed == galleryAmount)
                        break;
                }

                table.tablesorter({
                    widgets: ['columns'],
                    usNumberFormat: true,
                    sortReset: false,
                    sortRestart: false,
                    headers: {
                        0: { sorter: false },
                        1: { sorter: false },
                        2: { sorter: false },
                    }
                });

            }

            var ignore = ' - & 1 2 3 4 5 6 7 8 9 a and are as at by de for from he her him his i ii iii in is it iv la me my v not of on part she that the them they to was with you'.split(' ');
            var words = [];
            for (var id in films) {
                var film = films[id];
                var cleanTitle = film
                    .Title
                    .toLowerCase()
                    .replace(/[,:;\.!\?]/g, '')
                    .replace(/\//g, ' ')
                    .split(' ')
                    .filter(a => !ignore.includes(a));
                for (var word of cleanTitle) {
                    if (!words.some(a => a[0] == word)) {
                        words.push([word, []])
                    }
                    var where = words.findIndex(a => a[0] == word);
                    words[where][1].push(id);
                }
            }

            words = words.sort((a, b) => a[0].localeCompare(b[0])).sort((a, b) => b[1].length - a[1].length);
            var max = Math.max(2, words.length > 50 ? words[50][1].length + 1 : 0);
            words = words.filter(a => a[1].length >= max);

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="2">Most Frequent Words in Titles <span class="subtitle">excluding stop words</span></th></tr>');
            thead.append('<tr class="bottomheader"><th>Word</th><th>Amount</th></tr>');

            for (var word in words) {
                var tooltip = []
                for (var filmIndex of words[word][1]) {
                    var film = films[filmIndex]
                    tooltip.push('(' + film.Year + ') ' + film.Title);
                }
                tooltip.sort()
                tbody.append(
                    '<tr' + (+word < words.length - 1 && words[word][1].length != words[+word + 1][1].length ? ' class="breaker"' : '') + '>' +
                    '<td style="width:10px">' + words[word][0] + '</td>' +
                    '<td class="ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + words[word][1].length + '</td>' +
                    '</tr>');
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">First Character of Title</th></tr>');
            thead.append('<tr class="bottomheader"><th>Character</th><th>#</th><th>&#x25AC;</th></tr>');

            var maxCharacters = 0;
            var characters = [];
            characters['[Digit]'] = 0;
            characters['[Special]'] = 0;
            for (var letter of 'abcdefghijklmnopqrstuvwxyz') {
                characters[letter] = 0;
            }

            var filmIndexes = {}
            for (var index in films) {
                var film = films[index];
                var start = film.Title.substr(0, 1).toLowerCase();
                if (start >= '0' && start <= '9') {
                    start = '[Digit]';
                } else if (start < 'a' || start > 'z') {
                    start = '[Special]'
                }
                characters[start]++;
                maxCharacters = Math.max(maxCharacters, characters[start]);
                console.log(start)
                if (!filmIndexes[start])
                    filmIndexes[start] = [];
                filmIndexes[start].push(index);
            }
            console.log(filmIndexes)

            for (var character in characters) {
                var tooltip = makeFilmListTooltip(filmIndexes[character]);
                bar = '<td class="chart" data-value="' + characters[character] + '"><span class="bar" style="width:' + Math.round((characters[character] / maxCharacters) * 100) + 'px">&nbsp;</span></td>';
                tbody.append(
                    '<tr>' +
                    '<td style="width:10px">' + character + '</td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + characters[character] + '</td>' +
                    bar +
                    '</tr>');
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'asc' },
                    2: { sortInitialOrder: 'desc' },
                    3: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            if (documentWidth > 880) {
                showTitleLengthChart();
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showTitleLengthChart() {

            var titlesByLength = Array(1000);
            var lengths = Array(1000);
            for (var a = 0; a < lengths.length; a++) {
                lengths[a] = 0;
                titlesByLength[a] = [];
            }
            var highest = 0;
            for (var index in films) {
                var film = films[index];
                lengths[film.Title.length]++;
                highest = Math.max(highest, film.Title.length);
                titlesByLength[film.Title.length].push(index);
            }

            highest += 10 - (highest % 10)

            $('body').append('<div id="outside"><div class="title">Films Watched by Title Length</div><figure class="highcharts-figure"><div id="container"></div></figure></div>');

            var cats = [];
            var values = [];

            for (var a = 0; a <= highest; a++) {
                cats.push(a)
                values.push(lengths[a])
            }

            Highcharts.chart('container', {
                chart: {
                    type: 'column',
                    width: '802',
                    spacingLeft: 100,
                    marginLeft: 70,
                },
                title: {
                    text: null,
                    enabled: false,
                },
                credits: {
                    enabled: false
                },
                legend: {
                    enabled: false
                },
                xAxis: {
                    category: false,
                    categories: cats,
                    tickInterval: 10,
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Characters'
                    }
                },
                yAxis: {
                    plotLines: [{
                        color: '#ddd',
                        value: 0,
                        width: 1,
                        zIndex: 5
                    }],
                    gridLineWidth: 1,
                    tickColor: '#ddd',
                    tickLength: 8,
                    tickWidth: 1,
                    tickmarkPlacement: 'between',
                    title: {
                        text: 'Films Watched'
                    }
                },
                tooltip: {
                    formatter: function () {
                        return this.point.x + ' character' + (this.point.x == 1 ? '' : 's') + '<br/>' + this.point.y + ' film' + (this.point.y == 1 ? '' : 's')
                    }
                },
                plotOptions: {
                    column: {
                        pointPadding: 0,
                        borderWidth: 0,
                        dataLabels: {
                            enabled: false,
                            align: 'center',
                            x: 3
                        },
                        states: {
                            hover: {
                                color: document.documentElement.style.getPropertyValue('--secondary-colour'),
                                enabled: true
                            },
                            inactive: {
                                opacity: 1
                            }
                        }
                    },
                },
                series: [
                    {
                        groupPadding: 0,
                        pointWidth: 6,
                        borderRadius: 0,
                        name: '',
                        animation: false,
                        color: 'black',
                        data: values,
                        enableMouseTracking: true,
                        borderRadius: 0,
                        cursor: 'zoom-in',
                        point: {
                            events: {
                                click: function () {
                                    showFilms(titlesByLength[this.x].join(' '));
                                }
                            }
                        }
                    }
                ]
            });
        }

        function showRated() {

            resetView(showRated, $(event.target));

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Ratings</th></tr>');
            thead.append('<tr class="bottomheader"><th>Rating</th><th>Films</th><th>&#x25AC;</th></tr>');

            var highestRatingCount = 0
            for (var s = 5; s > 0; s -= .5) {
                highestRatingCount = Math.max(highestRatingCount, films.filter(a => a.RatingSelf == s).length);
            }

            for (var s = 5; s > 0; s -= .5) {
                var amount = films.filter(a => a.RatingSelf == s).length;
                bar = '<td class="chart" data-value="' + amount + '"><span class="bar" style="width:' + Math.round((amount / highestRatingCount) * 100) + 'px">&nbsp;</span></td>';
                tbody.append('<tr><td data-value="' + s + '">' + '&#9670;'.repeat(s) + (s % 1 ? '&#9671;' : '') + '</td><td class="right">' + amount + '</td>' + bar + '</tr>');
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'asc', sorter: 'data-value' },
                    2: { sortInitialOrder: 'desc' },
                    3: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            $('body').append('<div class="boxes"></div>');

            var ratedSelf = films.filter(a => a.RatingSelf).length;
            var ratedLetterboxd = films.filter(a => a.RatingSelf && a.RatingLetterboxd).length;
            var unrated = films.filter(a => !a.RatingSelf).length;

            $('.boxes').append(makeBox(ratedSelf, 'Rated Films', (ratedSelf / films.length).toFixed(2) * 100 + '%', false));
            $('.boxes').append(makeBox(unrated, 'Unrated Films', (unrated / films.length).toFixed(2) * 100 + '%', false));

            var ratingSumSelf = films.filter(a => a.RatingSelf).reduce((y, z) => y + z.RatingSelf, 0)
            var ratingSumLetterboxd = films.filter(a => a.RatingSelf && a.RatingLetterboxd).reduce((y, z) => y + z.RatingLetterboxd, 0)
            var diff = (ratingSumSelf / ratedSelf) - (ratingSumLetterboxd / ratedLetterboxd)
            $('.boxes').append(makeBox((ratingSumSelf / ratedSelf).toFixed(2), 'Average Rating', (diff > 0 ? '+' : '') + diff.toFixed(2) + ' vs Letterboxd users', false));

            var alphabetical = films.slice().sort((a, b) => a.Title > b.Title);

            for (var s = 5; s > 0; s -= .5) {

                createGallery();
                var gallery = $('.gallery').last();

                gallery.append('<div class="title">' + '&#9670;'.repeat(s) + (s % 1 ? '&#9671;' : '') + '</div>');
                gallery.append('<div class="inside"></div>');
                var insideGallery = $('.gallery .inside').last();

                var displayed = 0;
                for (var index in alphabetical) {
                    var film = alphabetical[index];
                    if (film.RatingSelf == s) {
                        var title = film.Title;
                        if (film.TitleOriginal != film.Title) {
                            title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                        }
                        insideGallery.append(
                            '<div class="item">' +
                            '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                            '<div class="details">' + makeFilmDetails(film, false, false) + '</div>' +
                            '</a></div>');
                        displayed++;
                    }
                }

            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        // === Letterboxd ===

        function showFans() {

            resetView(showFans, $(event.target));

            makeInfo(
                'Note',
                '<b>Fans</b> on Letterboxd are users who consider the film to be one of their top 4 films.');

            var numberGroups = [...Array(20)].map(a => [])
            var count = 0, sum = 0
            for (var index in films) {
                var film = films[index]
                count++;
                sum += film.Fans;
                if (film.Fans == 0) {
                    numberGroups[0].push(index);
                } else {
                    numberGroups[film.Fans.toString().length].push(index);
                }
            }
            while (!numberGroups[numberGroups.length - 1].length)
                numberGroups = numberGroups.slice(0, -1);

            createNewTable();

            thead.append('<tr><th>Letterboxd Fans</th><th class="right">Films</th><th>▬</th></tr>');
            for (var line in numberGroups) {
                var tooltip = makeFilmListTooltip(numberGroups[line]);
                if (!tooltip.length)
                    tooltip = ['<em>No matching films.</em>']
                bar = '<td class="chart" data-value="' + numberGroups[line].length + '"><span class="bar" style="width:' + Math.round((numberGroups[line].length / Math.max(...numberGroups.map(a => a.length))) * 100) + 'px">&nbsp;</span></td>';
                var range = Math.floor((10 ** (+line - 1))).toLocaleString() + ' to ' + (10 ** (+line) - 1).toLocaleString()
                if (range == '0 to 0') {
                    range = 0;
                }
                tbody.append(
                    '<tr>' +
                    '<td data-value="' + line + '" class="right">' + range + '</td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + numberGroups[line].length + '</td>' +
                    bar +
                    '</tr>')
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 0]],
                headers: {
                    0: { sortInitialOrder: 'asc', sorter: 'data-value' },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            var count = 0, sum = 0
            for (var film of films) {
                count++;
                sum += film.Fans;
            }
            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox(formatNumber(Math.round(sum / count)), 'Average Number of Fans Per Film', 'Average number of fans for all watched films'));

            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">Watched feature films with the most fans on Letterboxd</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var filmsMostFans = films.slice().filter(a => a.Minutes >= 60).sort((a, b) => a.Title > b.Title).sort((a, b) => b.Fans - a.Fans).map(a => a.Id).slice(0, galleryAmount)

            var displayed = 0;
            for (var id of filmsMostFans) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details"><span class="ttt" data-tooltip="' + film.Fans.toLocaleString() + ' Fans">' + formatNumber(film.Fans) + '</span><br/>' + makeFilmDetails(film) + '</div>' +
                    '</a></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showLikes() {

            resetView(showLikes, $(event.target));

            var numberGroups = [...Array(20)].map(a => [])
            var count = 0, sum = 0
            for (var index in films) {
                var film = films[index]
                count++;
                sum += film.Likes;
                if (film.Likes == 0) {
                    numberGroups[0].push(index);
                } else {
                    numberGroups[film.Likes.toString().length].push(index);
                }
            }
            while (!numberGroups[numberGroups.length - 1].length)
                numberGroups = numberGroups.slice(0, -1);

            createNewTable();

            thead.append('<tr><th>Letterboxd Likes</th><th class="right">Films</th><th>▬</th></tr>');
            for (var line in numberGroups) {
                var tooltip = makeFilmListTooltip(numberGroups[line]);
                if (!tooltip.length)
                    tooltip = ['<em>No matching films.</em>']
                bar = '<td class="chart" data-value="' + numberGroups[line].length + '"><span class="bar" style="width:' + Math.round((numberGroups[line].length / Math.max(...numberGroups.map(a => a.length))) * 100) + 'px">&nbsp;</span></td>';
                var range = Math.floor((10 ** (+line - 1))).toLocaleString() + ' to ' + (10 ** (+line) - 1).toLocaleString()
                if (range == '0 to 0') {
                    range = 0;
                }
                tbody.append(
                    '<tr>' +
                    '<td data-value="' + line + '" class="right">' + range + '</td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + numberGroups[line].length + '</td>' +
                    bar +
                    '</tr>')
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 0]],
                headers: {
                    0: { sortInitialOrder: 'asc', sorter: 'data-value' },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            var count = 0, sum = 0
            for (var film of films) {
                count++;
                sum += film.Likes;
            }
            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox(formatNumber(Math.round(sum / count)), 'Average Likes Per Film', Math.round(sum / count).toLocaleString() + '<br/><br/>Average number of likes for all watched films'));

            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">Watched feature films with the most likes on Letterboxd</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var filmsMostLikes = films.slice().filter(a => a.Minutes >= 60).sort((a, b) => a.Title > b.Title).sort((a, b) => b.Likes - a.Likes).map(a => a.Id).slice(0, galleryAmount)

            var displayed = 0;
            for (var id of filmsMostLikes) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details"><span class="ttt" data-tooltip="' + film.Likes.toLocaleString() + ' Likes">' + formatNumber(film.Likes) + '</span><br/>' + makeFilmDetails(film) + '</div>' +
                    '</a></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showRatings() {

            resetView(showRatings, $(event.target));

            var numberGroups = [...Array(20)].map(a => [])
            var count = 0
            for (var index in films) {
                var film = films[index]
                if (film.RatingLetterboxd >= 0) {
                    numberGroups[Math.floor(film.RatingLetterboxd * 2)].push(index);
                }
            }
            while (!numberGroups[numberGroups.length - 1].length)
                numberGroups = numberGroups.slice(0, -1);

            createNewTable();

            thead.append('<tr><th>Letterboxd Rating</th><th class="right">Films</th><th>▬</th></tr>');
            for (var line in numberGroups) {
                var tooltip = makeFilmListTooltip(numberGroups[line]);
                if (!tooltip.length)
                    tooltip = ['<em>No matching films.</em>']
                bar = '<td class="chart" data-value="' + numberGroups[line].length + '"><span class="bar" style="width:' + Math.round((numberGroups[line].length / Math.max(...numberGroups.map(a => a.length))) * 100) + 'px">&nbsp;</span></td>';
                var range = (line/2).toFixed(1) + ' to ' + ((line/2) + 0.49);
                tbody.append(
                    '<tr>' +
                    '<td data-value="' + line + '" class="right">' + range + '</td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + numberGroups[line].length + '</td>' +
                    bar +
                    '</tr>')
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 0]],
                headers: {
                    0: { sortInitialOrder: 'asc', sorter: 'data-value' },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            var count = 0, sum = 0
            for (var film of films) {
                if (film.RatingLetterboxd > 0) {
                    count++;
                    sum += film.RatingLetterboxd;
                }
            }
            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox((sum / count).toFixed(2), 'Average Letterboxd Rating', 'Average rating of all watched films by Letterboxd users'));

            var filmsHighestRated = films.slice().filter(a => a.Minutes >= 60).sort((a, b) => a.Title > b.Title).sort((a, b) => b.RatingLetterboxd - a.RatingLetterboxd).map(a => a.Id).slice(0, galleryAmount)
            var filmsLowestRated = films.slice().filter(a => a.Minutes >= 60).filter(a => a.RatingLetterboxd > 0).sort((a, b) => a.Title > b.Title).sort((a, b) => a.RatingLetterboxd - b.RatingLetterboxd).map(a => a.Id).slice(0, galleryAmount)

            var filmsDifferenceRatedPositive = films.slice().filter(a => a.Minutes >= 60).filter(a => a.RatingSelf > 0 && a.RatingLetterboxd > 0 && a.RatingSelf > a.RatingLetterboxd).sort((a, b) => a.Title > b.Title).sort((a, b) => (a.RatingLetterboxd - a.RatingSelf) - (b.RatingLetterboxd - b.RatingSelf)).map(a => a.Id).slice(0, galleryAmount)
            var filmsDifferenceRatedNegative = films.slice().filter(a => a.Minutes >= 60).filter(a => a.RatingSelf > 0 && a.RatingLetterboxd > 0 && a.RatingSelf < a.RatingLetterboxd).sort((a, b) => a.Title > b.Title).sort((a, b) => (b.RatingLetterboxd - b.RatingSelf) - (a.RatingLetterboxd - a.RatingSelf)).map(a => a.Id).slice(0, galleryAmount)

            createGallery();
            var gallery = $('.gallery');
            gallery.append('<div class="title">Watched feature films with the highest ratings on Letterboxd</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var displayed = 0;
            for (var id of filmsHighestRated) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + film.RatingLetterboxd + '<br/>' + makeFilmDetails(film) + '</div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            createGallery();
            gallery = $('.gallery').last();
            gallery.append('<div class="title">Watched feature films with the lowest ratings on Letterboxd</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside').last();

            displayed = 0;
            for (var id of filmsLowestRated) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + film.RatingLetterboxd + '<br/>' + makeFilmDetails(film) + '</div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            createGallery();
            var gallery = $('.gallery').last();
            gallery.append('<div class="title">Watched feature films rated higher than the Letterboxd average</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside').last();

            var displayed = 0;
            for (var id of filmsDifferenceRatedPositive) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">+' + (film.RatingSelf - film.RatingLetterboxd).toFixed(2) + ' vs ' + film.RatingLetterboxd + '<br/>' + makeFilmDetails(film) + '</div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            createGallery();
            var gallery = $('.gallery').last();
            gallery.append('<div class="title">Watched feature films rated lower than the Letterboxd average</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside').last();

            var displayed = 0;
            for (var id of filmsDifferenceRatedNegative) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + (film.RatingSelf - film.RatingLetterboxd).toFixed(2) + ' vs ' + film.RatingLetterboxd + '<br/>' + makeFilmDetails(film) + '</div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showPopularity() {

            resetView(showPopularity, $(event.target));

            var watchesGroups = [...Array(20)].map(a => [])
            var count = 0, sum = 0
            for (var index in films) {
                var film = films[index]
                count++;
                sum += film.Watched;
                watchesGroups[film.Watched.toString().length].push(index)
            }
            while (!watchesGroups[watchesGroups.length - 1].length)
                watchesGroups = watchesGroups.slice(0, -1);

            createNewTable();

            thead.append('<tr><th>Letterboxd Watches</th><th class="right">Films</th><th>▬</th></tr>');
            for (var line in watchesGroups) {
                if (+line) {
                    var tooltip = makeFilmListTooltip(watchesGroups[line]);
                    if (!tooltip.length)
                        tooltip = ['<em>No matching films.</em>']
                    bar = '<td class="chart" data-value="' + watchesGroups[line].length + '"><span class="bar" style="width:' + Math.round((watchesGroups[line].length / Math.max(...watchesGroups.map(a => a.length))) * 100) + 'px">&nbsp;</span></td>';
                    tbody.append(
                        '<tr>' +
                        '<td data-value="' + line + '" class="right">' + (10 ** (+line - 1)).toLocaleString() + ' to ' + (10 ** (+line) - 1).toLocaleString() + '</td>' +
                        '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + watchesGroups[line].length + '</td>' +
                        bar +
                        '</tr>')
                }
            }

            $.tablesorter.addParser({
                id: 'data-value',
                is: function () {
                    return false;
                },
                format: function (s, table, cell) {
                    return $(cell).attr('data-value') || s;
                },
                type: 'text'
            });

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[0, 0]],
                headers: {
                    0: { sortInitialOrder: 'asc', sorter: 'data-value' },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'desc', sorter: 'data-value' },
                }
            });

            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox(formatNumber(sum / count), 'Average Watches Per Film', Math.round(sum / count).toLocaleString() + '<br/><br/>Average number of watches by Letterboxd users for all watched films'));

            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">Watched feature films with the most watches by Letterboxd users</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var filmsHighestWatched = films.slice().filter(a => a.Minutes >= 60).sort((a, b) => a.Title > b.Title).sort((a, b) => b.Watched - a.Watched).map(a => a.Id).slice(0, galleryAmount)
            var filmsLowestWatched = films.slice().filter(a => a.Minutes >= 60).sort((a, b) => a.Title > b.Title).sort((a, b) => a.Watched - b.Watched).map(a => a.Id).slice(0, galleryAmount)

            var displayed = 0;
            for (var id of filmsHighestWatched) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details"><span class="ttt" data-tooltip="' + film.Watched.toLocaleString() + ' Watches">' + formatNumber(film.Watched) + '</span><br/>' + makeFilmDetails(film) + '</div>' +
                    '</a></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            createGallery();
            gallery = $('.gallery').last();

            gallery.append('<div class="title">Watched feature films with the fewest watches by Letterboxd users</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside').last();

            displayed = 0;
            for (var id of filmsLowestWatched) {
                var film = films.find(a => a.Id == id);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details"><span class="ttt" data-tooltip="' + film.Watched.toLocaleString() + ' Watches">' + formatNumber(film.Watched) + '</span><br/>' + makeFilmDetails(film) + '</div>' +
                    '</a></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        // === People ===

        function showAge() {

            resetView(showAge, $(event.target));

            makeInfo(
                'Note',
                'All ages are based on the day the film was released.');

            var directorDays = 0, directorCount = 0;
            var protagonistDays = 0, protagonistCount = 0;

            var directorAll = [], protagonistAll = [];

            for (var index in films) {
                var film = films[index];
                var releaseDate = new Date(film.When);
                for (var director of film.Directors) {
                    var dir = people[director];
                    if (dir.BirthDate) {
                        var gap = (releaseDate - new Date(dir.BirthDate)) / (1000 * 60 * 60 * 24);
                        directorDays += gap;
                        directorCount++;
                        directorAll.push([gap, index, director])
                    }
                }
                if (film.Cast.length) {
                    var prot = people[film.Cast[0]];
                    if (prot.BirthDate) {
                        var gap = (releaseDate - new Date(prot.BirthDate)) / (1000 * 60 * 60 * 24);
                        protagonistDays += gap;
                        protagonistCount++;
                        protagonistAll.push([gap, index, film.Cast[0]])
                    }
                }
            }

            protagonistAll.sort((a, b) => a[0] - b[0]);
            directorAll.sort((a, b) => a[0] - b[0]);
            console.log(directorAll.slice(0, 20));

            $('body').append('<div class="boxes"></div>');
            $('.boxes').last().append(makeBox((directorDays / directorCount / 365.25).toFixed(0) + ' Years',
                'Average Director Age',
                (directorDays / directorCount / 365.25).toFixed(2) + ' Years'));
            $('.boxes').last().append(makeBox((protagonistDays / protagonistCount / 365.25).toFixed(0) + ' Years',
                'Average Protagonist Age',
                (protagonistDays / protagonistCount / 365.25).toFixed(2) + ' Years'));

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Youngest Directors</th></tr>');
            thead.append('<tr class="bottomheader"><th>Director</th><th>Film</th><th class="right">Age (Years)</th></tr>');

            for (var dir of directorAll.slice(0, 10)) {
                var film = films[dir[1]];
                var per = people[dir[2]];               
                var personUrl = 'https://letterboxd.com/' + data.Username + '/films/with/director/' + urlSafe(per.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var personTooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + per.Poster + '\'>"';
                var filmTooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                var gap = (((new Date(film.When) - new Date(per.BirthDate)) / (1000 * 60 * 60 * 24)) / 365).toFixed(1);
                tbody.append(
                    '<tr>' +
                    '<td>' + makeDot(per.Gender) + ' <a ' + personTooltip + 'target="_blank" href="' + personUrl + '">' + per.FullName + '</a></td>' +
                    '<td>' + film.Year + ' <a class="' + filmTooltip + '" target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
                    '<td class="right">' + gap + '</a></td>' +
                    '</tr>');
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Oldest Directors</th></tr>');
            thead.append('<tr class="bottomheader"><th>Director</th><th>Film</th><th class="right">Age (Years)</th></tr>');

            for (var dir of directorAll.slice(-10).reverse()) {
                var film = films[dir[1]];
                var per = people[dir[2]];
                var personUrl = 'https://letterboxd.com/' + data.Username + '/films/with/director/' + urlSafe(per.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var personTooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + per.Poster + '\'>"';
                var filmTooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                var gap = (((new Date(film.When) - new Date(per.BirthDate)) / (1000 * 60 * 60 * 24)) / 365).toFixed(1);
                tbody.append(
                    '<tr>' +
                    '<td>' + makeDot(per.Gender) + ' <a ' + personTooltip + 'target="_blank" href="' + personUrl + '">' + per.FullName + '</a></td>' +
                    '<td>' + film.Year + ' <a class="' + filmTooltip + '" target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
                    '<td class="right">' + gap + '</a></td>' +
                    '</tr>');
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Youngest Protagonists</th></tr>');
            thead.append('<tr class="bottomheader"><th>Protagonist</th><th>Film</th><th class="right">Age (Years)</th></tr>');

            for (var dir of protagonistAll.slice(0, 10)) {
                var film = films[dir[1]];
                var per = people[dir[2]];
                var personUrl = 'https://letterboxd.com/' + data.Username + '/films/with/actor/' + urlSafe(per.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var personTooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + per.Poster + '\'>"';
                var filmTooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                var gap = (((new Date(film.When) - new Date(per.BirthDate)) / (1000 * 60 * 60 * 24)) / 365).toFixed(1);
                tbody.append(
                    '<tr>' +
                    '<td>' + makeDot(per.Gender) + ' <a ' + personTooltip + 'target="_blank" href="' + personUrl + '">' + per.FullName + '</a></td>' +
                    '<td>' + film.Year + ' <a class="' + filmTooltip + '" target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
                    '<td class="right">' + gap + '</a></td>' +
                    '</tr>');
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Oldest Protagonists</th></tr>');
            thead.append('<tr class="bottomheader"><th>Protagonist</th><th>Film</th><th class="right">Age (Years)</th></tr>');

            for (var dir of protagonistAll.slice(-10).reverse()) {
                var film = films[dir[1]];
                var per = people[dir[2]];
                var personUrl = 'https://letterboxd.com/' + data.Username + '/films/with/actor/' + urlSafe(per.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var personTooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + per.Poster + '\'>"';
                var filmTooltip = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>';
                var gap = (((new Date(film.When) - new Date(per.BirthDate)) / (1000 * 60 * 60 * 24)) / 365).toFixed(1);
                tbody.append(
                    '<tr>' +
                    '<td>' + makeDot(per.Gender) + ' <a ' + personTooltip + 'target="_blank" href="' + personUrl + '">' + per.FullName + '</a></td>' +
                    '<td>' + film.Year + ' <a class="' + filmTooltip + '" target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
                    '<td class="right">' + gap + '</a></td>' +
                    '</tr>');
            }

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

        function showPeopleCombinations() {

            resetView(showPeopleCombinations, $(event.target));

            var peoplePairs = [];
            for (var index in films) {
                if (films[index].Cast[0] >= 0) {
                    for (var director of films[index].Directors) {
                        var identifier = director + ' ' + films[index].Cast[0];
                        var where = peoplePairs.findIndex(a => a[0] == identifier)
                        if (where <= 0) {
                            peoplePairs.push([identifier, []]);
                            where = peoplePairs.length - 1;
                        }
                        peoplePairs[where][1].push(index);
                    }
                }
            }

            peoplePairs = peoplePairs
                .filter(a => a[1].length >= 2)
                .sort((a, b) => sortableName(people[a[0].split(' ')[0]].FullName).localeCompare(sortableName(people[b[0].split(' ')[0]].FullName)))
                .sort((a, b) => b[1].length - a[1].length);
            if (peoplePairs.length > 10) {
                var max = peoplePairs[9][1].length;
                peoplePairs = peoplePairs.filter(a => a[1].length >= max);
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Most Frequent Pairs - Director and Protagonist</th></tr>');
            thead.append('<tr class="bottomheader"><th>Director</th><th>Protagonist</th><th>Films</th></tr>');

            for (var index in peoplePairs) {

                var pair = peoplePairs[index];

                pair.PersonA = people[pair[0].split(' ')[0]]
                pair.PersonB = people[pair[0].split(' ')[1]]

                var urlA = url = 'https://letterboxd.com/' + data.Username + '/films/with/director/' + urlSafe(pair.PersonA.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var urlB = url = 'https://letterboxd.com/' + data.Username + '/films/with/actor/' + urlSafe(pair.PersonB.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var tooltipA = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + pair.PersonA.Poster + '\'>"';
                var tooltipB = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + pair.PersonB.Poster + '\'>"';
                var tooltipFilms = []
                for (var filmIndex of pair[1]) {
                    var film = films[filmIndex]
                    tooltipFilms.push('(' + film.Year + ') ' + film.Title);
                }
                tooltipFilms.sort()
                tbody.append(
                    '<tr' + (index < peoplePairs.length - 2 && pair[1].length != peoplePairs[+index + 1][1].length ? ' class="breaker"' : '') + '>' +
                    '<td>' + makeDot(pair.PersonA.Gender) + ' <a ' + tooltipA + 'target="_blank" href="' + urlA + '">' + pair.PersonA.FullName + '</a></td>' +
                    '<td>' + makeDot(pair.PersonB.Gender) + ' <a ' + tooltipB + 'target="_blank" href="' + urlB + '">' + pair.PersonB.FullName + '</a></td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltipFilms.join('<br/>') + '">' + pair[1].length + '</td>' +
                    '</tr>');
            }

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[2, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'asc' },
                    3: { sortInitialOrder: 'desc' },
                }
            });

            var peoplePairs = [];
            for (var index in films) {
                var cast = films[index].Cast.slice(0, 3).filter(a => a >= 0).sort((a, b) => sortableName(people[a].FullName).localeCompare(sortableName(people[b].FullName)));
                for (var a = 0; a < cast.length; a++) {
                    for (var b = a + 1; b < cast.length; b++) {
                        var identifier = cast[a] + ' ' + cast[b];
                        var where = peoplePairs.findIndex(a => a[0] == identifier)
                        if (where <= 0) {
                            peoplePairs.push([identifier, []]);
                            where = peoplePairs.length - 1;
                        }
                        peoplePairs[where][1].push(index);
                    }
                }
            }

            peoplePairs = peoplePairs
                .filter(a => a[1].length >= 2)
                .sort((a, b) => sortableName(people[a[0].split(' ')[0]].FullName).localeCompare(sortableName(people[b[0].split(' ')[0]].FullName)))
                .sort((a, b) => b[1].length - a[1].length);
            if (peoplePairs.length > 10) {
                var max = peoplePairs[9][1].length;
                peoplePairs = peoplePairs.filter(a => a[1].length >= max);
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="3">Most Frequent Pairs - Main Cast</th></tr>');
            thead.append('<tr class="bottomheader"><th>Main Cast 1</th><th>Main Cast 2</th><th>Films</th></tr>');

            for (var index in peoplePairs) {

                var pair = peoplePairs[index];

                pair.PersonA = people[pair[0].split(' ')[0]]
                pair.PersonB = people[pair[0].split(' ')[1]]

                var urlA = url = 'https://letterboxd.com/' + data.Username + '/films/with/actor/' + urlSafe(pair.PersonA.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var urlB = url = 'https://letterboxd.com/' + data.Username + '/films/with/actor/' + urlSafe(pair.PersonB.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var tooltipA = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + pair.PersonA.Poster + '\'>"';
                var tooltipB = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + pair.PersonB.Poster + '\'>"';
                var tooltipFilms = []
                for (var filmIndex of pair[1]) {
                    var film = films[filmIndex]
                    tooltipFilms.push('(' + film.Year + ') ' + film.Title);
                }
                tooltipFilms.sort()
                tbody.append(
                    '<tr' + (index < peoplePairs.length - 2 && pair[1].length != peoplePairs[+index + 1][1].length ? ' class="breaker"' : '') + '>' +
                    '<td>' + makeDot(pair.PersonA.Gender) + ' <a ' + tooltipA + 'target="_blank" href="' + urlA + '">' + pair.PersonA.FullName + '</a></td>' +
                    '<td>' + makeDot(pair.PersonB.Gender) + ' <a ' + tooltipB + 'target="_blank" href="' + urlB + '">' + pair.PersonB.FullName + '</a></td>' +
                    '<td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltipFilms.join('<br/>') + '">' + pair[1].length + '</td>' +
                    '</tr>');
            }

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[2, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'asc' },
                    3: { sortInitialOrder: 'desc' },
                }
            });

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();

        }

        function showPeopleLongevity() {

            resetView(showPeopleLongevity, $(event.target));

            showPeopleLengthsSpecific('Directors', 'director');
            showPeopleLengthsSpecific('Protagonists', 'actor');
            //showPeopleLengthsSpecific('Main Cast', 'actor');

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();

        }

        function showPeopleLengthsSpecific(title, job) {

            var peopleLengths = [...people]

            for (var index in people) {
                peopleLengths[index].YearFirst = 0
                peopleLengths[index].YearLast = 0
            }

            for (var index in films) {
                var year = films[index].Year;

                var source;
                switch (title) {
                    case 'Directors':
                        source = films[index].Directors;
                        break;
                    case 'Protagonists':
                        source = [films[index].Cast[0]];
                        break;
                    case 'Main Cast':
                        source = films[index].Cast.slice(0, 3);
                        break;
                }

                for (var person of source.filter(a => a !== undefined)) {
                    if (peopleLengths[person].YearFirst == 0 || peopleLengths[person].YearFirst > year) {
                        peopleLengths[person].YearFirst = year;
                        peopleLengths[person].Earliest = films[index].Id;
                        peopleLengths[person].Index = person;
                    }
                    if (peopleLengths[person].YearLast < year) {
                        peopleLengths[person].YearLast = year;
                        peopleLengths[person].Newest = films[index].Id;
                    }
                }
            }

            peopleLengths = peopleLengths
                .filter(a => a.YearFirst != a.YearLast)
                .sort((a, b) => sortableName(a.FullName).localeCompare(sortableName(b.FullName)))
                .sort((a, b) => (b.YearLast - b.YearFirst) - (a.YearLast - a.YearFirst));

            if (peopleLengths.length > 10) {
                var maxSpan = peopleLengths[9].YearLast - peopleLengths[9].YearFirst;
                peopleLengths = peopleLengths.filter(a => (a.YearLast - a.YearFirst) >= maxSpan)
            }

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="4">Longest Spanning ' + title + '</th></tr>');
            thead.append('<tr class="bottomheader"><th>Name</th><th>Years</th><th>Earliest Film</th><th>Newest Film</th></tr>');

            for (var person of peopleLengths) {
                var per = people[person.Index];
                var url = 'https://letterboxd.com/' + data.Username + '/films/with/' + job + '/' + urlSafe(per.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var tooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + per.Poster + '\'>"';

                var filmEarliest = films.find(a => a.Id == person.Earliest);
                var tooltipEarliest = '';
                if (filmEarliest.Poster && filmEarliest.Poster.length > 0) {
                    tooltipEarliest = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + filmEarliest.Poster + '\'>';
                }
                var filmNewest = films.find(a => a.Id == person.Newest);
                var tooltipNewest = '';
                if (filmNewest.Poster && filmNewest.Poster.length > 0) {
                    tooltipNewest = ' ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + filmNewest.Poster + '\'>';
                }

                tbody.append(
                    '<tr>' +
                    '<td>' + makeDot(per.Gender) + ' <a ' + tooltip + 'target="_blank" href="' + url + '">' + per.FullName + '</a></td>' +
                    '<td class="right">' + (person.YearLast - person.YearFirst) + '</td>' +
                    '<td>' + filmEarliest.Year + ' <a class="' + tooltipEarliest + '" target="_blank" href="https://boxd.it/' + filmEarliest.Id + '">' + filmEarliest.Title + '</a></td>' +
                    '<td>' + filmNewest.Year + ' <a class="' + tooltipNewest + '" target="_blank" href="https://boxd.it/' + filmNewest.Id + '">' + filmNewest.Title + '</a></td>' +
                    '</tr>');
            }

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'asc' },
                    2: { sortInitialOrder: 'desc' },
                    3: { sortInitialOrder: 'asc' },
                    4: { sortInitialOrder: 'desc' },
                }
            });

        }

        function showPeople(job, jobSpecific, index = 'All') {

            if (!job) {
                [job, jobSpecific, index] = [...lastPeopleParameters]
            } else {
                lastPeopleParameters = [job, jobSpecific, index]
            }

            resetView(showPeople, $(event.target));

            var jobSpecificCleaned = jobSpecific.replace(' ', '').toLowerCase();

            var dataSourceAlt = {};
            dataSourceAlt.Total = 0;
            dataSourceAlt.Unique = 0;
            dataSourceAlt.PeopleData = [];

            var statTotalGenderAll = [];
            var statTotalGender_1 = [];
            var statTotalGender_2 = [];
            var statTotalGender_3 = [];

            var peopleDuplicate = [...people];
            peopleDuplicate.forEach(a => { a.Amount = 0; a.Minutes = 0; a.Include = false; a.Films = []; })

            dataSourceAlt.Total = 0;
            for (var filmIndex in films) {
                var peopleIndexes;
                switch (jobSpecificCleaned) {
                    case 'director':
                        peopleIndexes = films[filmIndex].Directors;
                        break;
                    case 'protagonist':
                        peopleIndexes = [films[filmIndex].Cast[0]];
                        break;
                    case 'maincast':
                        peopleIndexes = films[filmIndex].Cast.slice(0, 3);
                        break;
                    case 'entirecast':
                        peopleIndexes = films[filmIndex].Cast;
                        break;
                }
                for (var personIndex of peopleIndexes) {
                    if (personIndex >= 0) {
                        var gender = people[personIndex].Gender;
                        statTotalGenderAll.push(personIndex);
                        switch (gender) {
                            case 1:
                                statTotalGender_1.push(personIndex);
                                break;
                            case 2:
                                statTotalGender_2.push(personIndex);
                                break;
                            case 3:
                                statTotalGender_3.push(personIndex);
                                break;
                        }
                        if (index == 'All' || gender == index) {
                            peopleDuplicate[personIndex].Include = true;
                            peopleDuplicate[personIndex].Amount++;
                            peopleDuplicate[personIndex].Minutes += films[filmIndex].Minutes;
                            peopleDuplicate[personIndex].Films.push(filmIndex);
                            dataSourceAlt.Total++;
                        }
                    }
                }
            }
            peopleDuplicate = peopleDuplicate.filter(a => a.Include);
            dataSourceAlt.Unique = peopleDuplicate.length;
            dataSourceAlt.PeopleData = peopleDuplicate;

            var statUniqueGenderAll = new Set(statTotalGenderAll).size;
            var statUniqueGender_1 = new Set(statTotalGender_1).size;
            var statUniqueGender_2 = new Set(statTotalGender_2).size;
            var statUniqueGender_3 = new Set(statTotalGender_3).size;

            statTotalGenderAll = statTotalGenderAll.length;
            statTotalGender_1 = statTotalGender_1.length;
            statTotalGender_2 = statTotalGender_2.length;
            statTotalGender_3 = statTotalGender_3.length;

            dataSourceAlt
                .PeopleData
                .sort((a, b) => sortableName(a.FullName).localeCompare(sortableName(b.FullName)))
                .sort((a, b) => b.Amount - a.Amount);

            dataSource = dataSourceAlt.PeopleData;

            createGallery();

            var gallery = $('.gallery');
            var minimum = 0;
            if (dataSource.length > galleryAmount) {
                var minimumVisible = dataSource[galleryAmount - 1].Amount;
                var minimumInvisible = dataSource[galleryAmount].Amount;
                if (minimumVisible == minimumInvisible) {
                    minimum = minimumVisible;
                }
            }

            var shuffled = dataSource.filter(a => a.Amount > minimum);
            shuffled = shuffled.sort((a, b) => sortableName(b.FullName) < sortableName(a.FullName));
            shuffled = shuffled.sort((a, b) => b.Amount - a.Amount);

            gallery.append('<div class="title">Most Frequent - ' + jobSpecific + (index == 'All' ? '' : ' - ' + ['Unknown', 'Women', 'Men', 'Non-Binary'][index]) + '</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var displayed = 0;
            for (var person of shuffled) {
                console.log(person)
                var hours = 0, minutes = 0;
                hours = Math.floor(person.Minutes / 60);
                minutes = person.Minutes - (hours * 60);
                var url = 'https://letterboxd.com/' + data.Username + '/films/with/' + job.toLowerCase() + '/' + urlSafe(person.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var tooltip = []
                for (var filmIndex of person.Films) {
                    var film = films[filmIndex]
                    tooltip.push('(' + film.Year + ') ' + film.Title);
                }
                tooltip.sort()
                insideGallery.append(
                    '<div class="item' + (person.Amount == minimum ? ' lowlight' : '') + '">' +
                    '<div class="poster ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '"><a target="_blank" href="' + url + '">' +
                    (person.Poster ? '<img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + person.Poster + '">' : '<div class="empty">no picture available</div>') +
                    '</a></div> ' +
                    '<div class="details"><span class="ttt" data-tooltip="Total Time: ' + hours + 'h ' + minutes + 'm">×' + person.Amount + '</span> <span class="clickable" onmousedown="showSpecificPerson(' + person.ID + ')" style="position:relative;top:-2px;">&#x1F50E;&#xFE0E;</span><div><a target="_blank" href="' + url + '">' + person.FullName + '</a>' +
                    '</div></div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            $('body').append('<div class="boxes"></div>');
            $('.boxes').append(makeBox(dataSourceAlt.Total, 'Total'));
            $('.boxes').append(makeBox(dataSourceAlt.Unique, 'Distinct'));

            if (index == 'All') {
                makeJobRow(
                    statTotalGenderAll,
                    statTotalGender_1,
                    statTotalGender_2,
                    statTotalGender_3,
                    statUniqueGenderAll,
                    statUniqueGender_1,
                    statUniqueGender_2,
                    statUniqueGender_3,
                );
            }

            createNewTable();

            var sorted = dataSource.slice(0);
            sorted = sorted.sort((a, b) => SortableName(b.FullName) < SortableName(a.FullName)).sort((a, b) => b.Amount > a.Amount);
            if (sorted.length > 100) {
                var min = sorted[100].Amount;
                sorted = sorted.filter(a => a.Amount >= min);
            }

            thead.append('<tr class="topheader"><th colspan="2">Top ' + Object.values(sorted).length + ' Most Frequent</th></tr>');
            thead.append('<tr class="bottomheader"><th>Person</th><th>Amount</th></tr>');

            for (var a = 0; a < sorted.length; a++) {
                var url = 'https://letterboxd.com/' + data.Username + '/films/with/' + job.toLowerCase() + '/' + urlSafe(sorted[a].FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
                var extraClass = '';
                if (a < sorted.length - 1 && sorted[a].Amount != sorted[a + 1].Amount) {
                    extraClass = ' class="breaker"';
                }
                var dot = '';
                if (index == 'All') {
                    dot = makeDot(sorted[a].Gender) + ' ';
                }

                var tooltipPoster = '';
                if (sorted[a].Poster.length > 0) {
                    tooltipPoster = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + sorted[a].Poster + '\'>"';
                }

                var tooltip = []
                for (var filmIndex of sorted[a].Films) {
                    var film = films[filmIndex]
                    tooltip.push('(' + film.Year + ') ' + film.Title);
                }
                tooltip.sort()

                tbody.append(
                    '<tr' + extraClass + '>' +
                    '<td>' + dot + ' ' + '<span class="clickable" onmousedown="showSpecificPerson(' + sorted[a].ID + ')">&#x1F50E;</span>' + ' <a ' + tooltipPoster + 'target="_blank" href="' + url + '">' + sorted[a].FullName + '</a></td>' +
                    '<div><td class="right ttt" data-tooltip-size="big" data-tooltip="' + tooltip.join('<br>') + '">' + sorted[a].Amount + '</td>' +
                    '</tr>');
            }

            $('#main').tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                sortList: [[1, 1]],
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'asc' },
                    2: { sortInitialOrder: 'desc' }
                }
            });

            createTooltipTriggers();

            deactivateAll();
            $(event.target).addClass('active');

            console.timeEnd('a');
        }

        function showDirectorsWomen() {
            showPeople('Director', 'Director', 1);
        }

        function showDirectorsMen() {
            showPeople('Director', 'Director', 2);
        }

        function showDirectorsNonBinary() {
            showPeople('Director', 'Director', 3);
        }

        function showDirectorsAll() {
            showPeople('Director', 'Director');
        }

        function showDirectorsUnknown() {
            showPeople('Director', 'Director', 0);
        }

        function showProtagonistsWomen() {
            showPeople('Actor', 'Protagonist', 1);
        }

        function showProtagonistsMen() {
            showPeople('Actor', 'Protagonist', 2);
        }

        function showProtagonistsNonBinary() {
            showPeople('Actor', 'Protagonist', 3);
        }

        function showProtagonistsAll() {
            showPeople('Actor', 'Protagonist');
        }

        function showProtagonistsUnknown() {
            showPeople('Actor', 'Protagonist', 0);
        }

        function showTopCastWomen() {
            showPeople('Actor', 'Main Cast', 1);
        }

        function showTopCastMen() {
            showPeople('Actor', 'Main Cast', 2);
        }

        function showTopCastNonBinary() {
            showPeople('Actor', 'Main Cast', 3);
        }

        function showTopCastAll() {
            showPeople('Actor', 'Main Cast');
        }

        function showTopCastUnknown() {
            showPeople('Actor', 'Main Cast', 0);
        }

        function showEntireCastWomen() {
            showPeople('Actor', 'Entire Cast', 1);
        }

        function showEntireCastMen() {
            showPeople('Actor', 'Entire Cast', 2);
        }

        function showEntireCastNonBinary() {
            showPeople('Actor', 'Entire Cast', 3);
        }

        function showEntireCastAll() {
            showPeople('Actor', 'Entire Cast');
        }

        function showEntireCastUnknown() {
            showPeople('Actor', 'Entire Cast', 0);
        }

        // === Other ===

        function showRecent() {

            resetView(showRecent, $(event.target));

            //'<div class="info">Click a section ' + (window.innerWidth > 900 ? 'on the left' : 'above') + ' to explore the statistics for <a target="_blank" href="https://letterboxd.com/' + data.Username + '/">' + data.Username + '\'s</a> ' + films.length.toLocaleString() + ' <a href="https://letterboxd.com/' + data.Username + '/films/">watched films</a>.<br/>The statistics were generated on ' + data.LastUpdated + '.</div>');

            //$('body').append('<div class="boxes"></div>');
            //$('.boxes').last().append(makeBox(, 'Stats Generated Date'));

            //$('body').append('<div class="boxes"></div>');
            //$('.boxes').last().append(makeBox(films.length.toLocaleString(), 'Watched Films'));

            //$('body').append('<div class="info"><a target="_blank" href="https://letterboxd.com/' + data.Username + '/">' + data.Username + '\'s Letterboxd</a>.</div>');

            showListRecent('Recently Watched', "Recently Watched <span class='subtitle'>starting with the most recent</span>", galleryAmount);
            showTableRecent('Recently Watched', "Recently Watched <span class='subtitle'>starting with the most recent</span>", 20);

            createTooltipTriggers();

            deactivateAll();
            if (event) {
                $(event.target).addClass('active');
            }
        }

        function showListRecent(listName, listTitle, amount = galleryAmount) {

            var lbList = data.Lists.filter(a => a.ListName == listName)[0];

            createGallery();
            var gallery = $('.gallery');

            gallery.append('<div class="title">' + listTitle + '</div>');
            gallery.append('<div class="inside"></div>');
            var insideGallery = $('.gallery .inside');

            var listFilms = lbList.Entries.slice(-amount).reverse();

            for (var film of listFilms) {
                var title = film.FilmName;
                if (film.FilmNameOriginal != film.FilmName) {
                    title = film.FilmNameOriginal + '<br>(&quot;' + film.FilmName + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item">' +
                    '<div class="poster ttt" data-tooltip="' + title + '"><a target="_blank" href="https://boxd.it/' + film.LetterboxdIdentifier + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.PosterUrl + '"></a></div>' +
                    '<div class="details">' + makeFilmDetails(film) + '<br/></div>' +
                    '</a></div>');
            }

            createTooltipTriggers();

            deactivateAll();
        }

        function deleteRow(row) {
            row.parentNode.removeChild(row);
        }

        function showTableRecent(listName, listTitle, amount = galleryAmount) {

            var lbList = data.Lists.filter(a => a.ListName == listName)[0];

            $('body').append('<button onclick="copyRecentTable()">Copy Recently Watched: Table</button>');

            createNewTable();

            table.css('display', 'none');

            tbody.append('<tr class="topheader"><td colspan="5"><span style="font-weight:bold">Recently Watched</span> <span class="subtitle">(starting with the most recent)</span></td></tr>');
            tbody.append('<tr class="bottomheader" style="font-weight:bold"><td>Title</td><td>Year</td><td>Rating</td><td>Language</td><td>Genre</td></tr>');

            var listFilms = lbList.Entries.slice(-amount).reverse();

            for (var film of listFilms) {
                var html = '<tr onclick="deleteRow(this)">';
                html += '<td><a title="' + film.Overview + '" href="https://boxd.it/' + film.LetterboxdIdentifier + '">' + film.FilmName + '</a>' + (film.IsRewatch ? ' &#8635;' : '') + '</td>';
                html += '<td>' + film.Year + '</td>';
                //tbody.append('<td>' + film.Protagonist + '</td>');
                var ratingDetail = '&nbsp;';
                if (film.RatingSelf > 0) {
                    if (film.RatingSelf % 1) {
                        ratingDetail = '&#9670;'.repeat(Math.floor(film.RatingSelf)) + '&#11030;' + '&#9671;'.repeat(4 - Math.floor(film.RatingSelf));
                    } else {
                        ratingDetail = '&#9670;'.repeat(film.RatingSelf) + '&#9671;'.repeat(5 - film.RatingSelf);
                    }
                }
                html += '<td>' + ratingDetail + '</td>';
                var languageDetail = '&nbsp;';
                if (film.Language.length == 0) {
                    languageDetail = '<em>Silent</em>';
                } else if (film.Language != "English") {
                    languageDetail = film.Language;
                } else {
                    languageDetail = '&nbsp;';
                }
                html += '<td>' + languageDetail + '</td>';
                html += '<td title="Hello World">' + film.Genres.sort().join(', ') + '</td>';
                html += '</tr>';
                var overviewDetails = film.Overview;
                if (overviewDetails.length > 90) {
                    overviewDetails = overviewDetails.substr(0, 89).trim() + '...';
                }
                //tbody.append('<tr style="color:grey"><td colspan="6">' + overviewDetails + '</td></tr>');
                tbody.append(html);
            }

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                headers: {
                    0: { sorter: false },
                    1: { sorter: false },
                    2: { sorter: false },
                }
            });

            $('body').append('<button onclick="copyRecentPosters()">Copy Recently Watched: Posters</button>');
            var posterHtml = '';
            for (var film of listFilms) {
                posterHtml += '<a target="_blank" href="https://boxd.it/' + film.LetterboxdIdentifier + '"><img alt="' + film.FilmName + ' (' + film.Year + ')" width="110" height="175" src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.PosterUrl + '"></a>';
            }
            $('body').append('<div id="posters" style="display:none">' + posterHtml + '</div>');

            $('body').append('<button onclick="copyRecentGrid()">Copy Recently Watched: Grid</button>');
            var html = '<tr>';
            for (var a = 0; a <= 5; a += 5) {
                for (var film of listFilms.slice(a, a + 5)) {
                    html += '<td><img alt="`' + film.FilmName + '` \r\n' + film.Overview.replace(/"/g, "''") + '" width="110" height="175" src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.PosterUrl + '"></td>';
                }
                html += '</tr><tr>';
                for (var film of listFilms.slice(a, a + 5)) {
                    html += '<td><a target="_blank" href="https://boxd.it/' + film.LetterboxdIdentifier + '">' + film.Year + '</a><br/>';
                    if (film.RatingSelf > 0) {
                        html += '&#9670;'.repeat(Math.floor(film.RatingSelf)) + (film.RatingSelf % 1 ? '&#11030;' : '');
                    } else {
                        html += '.';
                    }
                    html += '<br>';
                    if (film.Language.length == 0) {
                        html += '<em>Silent</em>';
                    } else if (film.Language != "English") {
                        html += film.Language;
                    } else {
                        html += '.';
                    }
                    html += '</td>';
                }
                html += '</tr>';
            }

            $('body').append('<table id="grid" style="display:none">' + html + '</div>');
        }

        showOverall();
        data.Backdrops = shuffleArray(data.Backdrops);
        showNextBackdrop();
        showHostOnly();

        $('#prime').addClass('active');

    </script>

</body>
</html>