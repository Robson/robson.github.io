<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Letterboxd Statistics Dashboard</title>
	<link href="theme.default.min.css" rel="stylesheet">
	<link href="overall.css" rel="stylesheet">
	<link rel="icon" type="image/x-icon" href="favicon.ico">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/css-doodle/0.40.0/css-doodle.min.js"></script>
	<script src="films.js"></script>
	<script src="data.js"></script>
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="jquery.tablesorter.min.js"></script>
	<script src="jquery.tablesorter.widgets.min.js"></script>
	<!--<link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">-->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>

	<css-doodle id="doodle">
		:doodle {
			@grid: 64 / 100.5vmax;
		}
		:after {
			content: '\@hex(@rand(0x2800, 0x283F))';
			transform: scale(1.35);
			color: @pick(#000, #060606, #0D0D0D);
			font-size: 3em;
			line-height: 1.1em;
		}
	</css-doodle>

	<div id="menu_background">&nbsp;</div>

	<div id="image_loader"></div>

	<a target="_blank" href="" id="backdrop_link"><div id="backdrop" class="ttt"></div></a>

	<div id="buttons">
		<!--<div class="title">Overall</div>
	<span class="displayer" onmousedown="javascript:showOverall()" id="prime">Overall</span>-->
		<div class="title">Release D<b onmousedown="showHidden()">a</b><b onmousedown="setNewColours()">t</b>e</div>
		<span class="displayer inline" onmousedown="javascript:showFilmsPerYear()">Year</span>
		&#9670;
		<span class="displayer inline" onmousedown="javascript:showFilmsPerDecade()">Decade</span>
		<!--<span class="displayer" onmousedown="javascript:showFilmsPerCentury()">Films Per Century</span>-->
		&#9670;
		<span class="displayer inline" onmousedown="javascript:showOldestReleasedFilms()">Earliest</span>
		&#9670;
		<span class="displayer inline" onmousedown="javascript:showNewestReleasedFilms()">Newest</span><br>
		<!--<span class="displayer inlinefirst" onmousedown="javascript:showYearsWithoutFilms()">Years With No Films</span> <em style="opacity:0">&#9670;</em>-->
		<div class="title">Region</div>
		<span class="displayer inline" onmousedown="javascript:showFilmsPerCountry()">Country</span>
		&#9670;
		<span class="displayer inline" onmousedown="javascript:showFilmsPerLanguages()">Language</span>
		<div class="title">Attributes</div>
		<span class="displayer inline" onmousedown="javascript:showGenres()">Genre</span>
		&#9670;
		<span class="displayer inline" onmousedown="javascript:showLengthStats()">Length</span>
		&#9670;
		<span class="displayer inline" onmousedown="javascript:showTitles()">Title</span>
		<div class="title">Letterboxd</div>
		<span class="displayer inline" onmousedown="javascript:showPopularity()">Popularity</span>
		&#9670;
		<span class="displayer inline" onmousedown="javascript:showRatings()">Rating</span>
		<div class="title">People</div>
		<em class="subtitle">Director:</em>
		<span class="displayer inline" onmousedown="javascript:showDirectorsAll()">All</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showDirectorsWomen()">W</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showDirectorsMen()">M</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showDirectorsNonBinary()">NB</span>
		<br>
		<em class="subtitle">Protagonist:</em>
		<span class="displayer inline" onmousedown="javascript:showProtagonistsAll()">All</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showProtagonistsWomen()">W</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showProtagonistsMen()">M</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showProtagonistsNonBinary()">NB</span>
		<br>
		<em class="subtitle">Main Cast:</em>
		<span class="displayer inline" onmousedown="javascript:showTopCastAll()">All</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showTopCastWomen()">W</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showTopCastMen()">M</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showTopCastNonBinary()">NB</span>
		<br>
		<em class="subtitle">Entire Cast:</em>
		<span class="displayer inline" onmousedown="javascript:showEntireCastAll()">All</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Women" onmousedown="javascript:showEntireCastWomen()">W</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Men" onmousedown="javascript:showEntireCastMen()">M</span>
		&#9670;
		<span class="displayer inline ttt" data-tooltip="Non-Binary" onmousedown="javascript:showEntireCastNonBinary()">NB</span>
		<div class="initially_hidden">
			<div class="title">Watched</div>
			<span class="displayer inline" onmousedown="javascript:showList('Watched in 2023')">In 2023</span>
			&#9670;
			<span class="displayer inline" onmousedown="javascript:showList('Watched in 2024')">In 2024</span>
		</div>
		<!--<div class="title">Director</div>
	<span class="displayer inlinefirst" onmousedown="javascript:showDirectorsAll()">All</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showDirectorsWomen()">Women</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showDirectorsMen()">Men</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showDirectorsNonBinary()">NB</span>
	<div class="title">Protagonist</div>
	<span class="displayer inlinefirst" onmousedown="javascript:showProtagonistsAll()">All</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showProtagonistsWomen()">Women</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showProtagonistsMen()">Men</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showProtagonistsNonBinary()">NB</span>
	<div class="title">Main Cast</div>
	<span class="displayer inlinefirst" onmousedown="javascript:showTopCastAll()">All</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showTopCastWomen()">Women</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showTopCastMen()">Men</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showTopCastNonBinary()">NB</span>
	<div class="title">Entire Cast</div>
	<span class="displayer inlinefirst" onmousedown="javascript:showEntireCastAll()">All</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showEntireCastWomen()">Women</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showEntireCastMen()">Men</span>
	&#9670;
	<span class="displayer inline" onmousedown="javascript:showEntireCastNonBinary()">NB</span>-->
	</div>

	<div id="tt" style="display: none">
		<p id="tooltip_text"></p>
	</div>

	<script>

		var documentWidth = document.body.clientWidth;

		onresize = (event) => {
			if (document.body.clientWidth != documentWidth) {
				documentWidth = document.body.clientWidth;
				showOverall();
				deactivateAll();
			}
		};

		var table, thead, tbody;
		var galleryAmount = 30;
		var sufficientBase = 10;
		var backdropIndex = ~~(data.Backdrops.length * Math.random());

		////////////////// TOOLTIPS //////////////////

		var tt = d3.select('#tt');

		tt.on('mousedown', function () { tt.style('display', 'none'); });

		function setNewColours() {
			var colourData = prompt("Set new colours:");
            if (colourData.length > 0) {
                if (colourData.includes(' ')) {
                    document.documentElement.style.setProperty('--primary-colour', colourData.split(' ')[0]);
                    document.documentElement.style.setProperty('--secondary-colour', colourData.split(' ')[1]);
                } else {
                    document.documentElement.style.setProperty('--primary-colour', colourData);
                    document.documentElement.style.setProperty('--secondary-colour', colourData);
                }
            } else {
                document.documentElement.style.setProperty('--primary-colour', '#EF3340');
                document.documentElement.style.setProperty('--secondary-colour', '#EF3340');
            }     
		}

		function setRandomBackdrop() {

			var randomBackdrop = data.Backdrops[backdropIndex];
			var backdrop = $('#backdrop');
			backdrop.css('background-image', 'url("https://image.tmdb.org/t/p/w780/' + randomBackdrop.ImageUrl + '")');
			backdrop.attr('data-tooltip', randomBackdrop.FilmName);
			$('#backdrop_link').attr('href', 'https://boxd.it/' + randomBackdrop.LetterboxdId);
			createTooltipTriggers();

			var colourData = data.Backdrops[backdropIndex].Colour;
			if (colourData.length > 0) {
				if (colourData.includes(' ')) {
					document.documentElement.style.setProperty('--primary-colour', colourData.split(' ')[0]);
					document.documentElement.style.setProperty('--secondary-colour', colourData.split(' ')[1]);
				} else {
					document.documentElement.style.setProperty('--primary-colour', colourData);
					document.documentElement.style.setProperty('--secondary-colour', colourData);
				}
			} else {
                document.documentElement.style.setProperty('--primary-colour', '#EF3340');
                document.documentElement.style.setProperty('--secondary-colour', '#EF3340');
			}        

			backdropIndex++;
			if (backdropIndex >= data.Backdrops.length) {
				backdropIndex = 0;
			}
			var imageLoader = $('#image_loader');
			imageLoader.css('background-image', 'url("https://image.tmdb.org/t/p/w780/' + data.Backdrops[backdropIndex].ImageUrl + '")');
		}

		function createTooltipTriggers() {
			d3.selectAll('.ttt')
				.on("mouseover", function (d, i) {
					d3.select('#tooltip_text').html($(this).attr('data-tooltip'));
				})
				.on("mouseout", function () {
					tt.style('display', 'none');
				})
				.on("mousemove", function (d, i) {
					tt.style('opacity', '0.01');
					var x = d3.event.pageX;
					x = Math.max(x, 10);
                    if (x <= 0 || y <= 0) {
                        tt.style('display', 'none');
                    } else {
                        tt.style('display', null);
                    }
					var y = d3.event.pageY + 10;
					var y = d3.event.pageY - (+tt.style('height').replace('px', '') + 20);

                    //(y + 10 + +tt.style('height').replace('px', '')) - window.scrollY > $(window.top).height()

                    if (y - window.scrollY < 0) {
						y = d3.event.pageY + 10;
					}

                    tt.style('left', Math.floor(x - (+tt.style('width').replace('px', '') / 2)) + 'px');
					tt.style('top', Math.floor(y + 5) + 'px');
					tt.style('opacity', '1');

					/*
					console.log('----');
                    console.log(document.body.clientHeight);
                    console.log(y)
                    console.log(tt.style('height'));
					console.log($(window.top).height());
                    console.log();
					*/
				});
		}

		function deactivateAll() {
			$('.active').removeClass('active');
		}

		function countryNameToUrl(country) {
			country = country.toLowerCase();
			switch (country) {
				case 'united kingdom':
					return 'uk';
				case 'united states of america':
					return 'usa';
				case 'russia':
					return 'russian-federation';
				case 'soviet union':
					return 'ussr';
				default:
					return country.replace(/ /g, '-');
			}
		}

		function resetView() {
			window.scrollTo(0, 0);
			setRandomBackdrop();
			$('.info').remove();
			$('table').remove();
			$('.boxes').remove();
			$('#outside').remove();
			$('.gallery').remove();
		}

		function createNewTable(isSortable = true) {

			$('body').append('<table class="tablesorter"' + (isSortable ? ' id="main"' : '') + '><thead></thead><tbody></tbody></table>');
			table = $('table').last();
			thead = $('table thead').last();
			tbody = $('table tbody').last();
		}

		function createGallery() {
			$('body').append('<div class="gallery"></div>');
		}

		function makeJobRow(totalAll, totalFemale, totalMale, totalNonBinary, uniqueAll, uniqueFemale, uniqueMale, uniqueNonBinary) {

			var total = totalFemale + totalMale + totalNonBinary;
			var unique = uniqueFemale + uniqueMale + uniqueNonBinary;
			totalFemalePercent = totalFemale / total * 100;
			totalMalePercent = totalMale / total * 100;
			totalNonBinaryPercent = totalNonBinary / total * 100;
			uniqueFemalePercent = uniqueFemale / unique * 100;
			uniqueMalePercent = uniqueMale / unique * 100;
			uniqueNonBinaryPercent = uniqueNonBinary / unique * 100;

			/*
			createNewTable(false);
			thead.append('<tr class="topheader"><th colspan="4">Total</th><th colspan="4">Distinct</th></tr>');
			thead.append('<tr class="bottomheader"><th class="right">All</th><th class="right">Women</th><th class="right">Men</th><th class="right">Non-Binary</th><th class="right">All</th><th class="right">Women</th><th class="right">Men</th><th class="right">Non-Binary</th></tr>');

			tbody.append(
				'<tr>' +
				'<td class="right">' + totalAll + '</td>' +
				'<td class="right ttt" data-tooltip="' + totalFemalePercent.toFixed(2) + '% (' + totalFemale + ')">' + totalFemalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + totalMalePercent.toFixed(2) + '% (' + totalMale + ')">' + totalMalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + totalNonBinaryPercent.toFixed(2) + '% (' + totalNonBinary + ')">' + totalNonBinaryPercent.toFixed(0) + '%</td>' +
				'<td class="right">' + uniqueAll + '</td>' +
				'<td class="right ttt" data-tooltip="' + uniqueFemalePercent.toFixed(2) + '% (' + uniqueFemale + ')">' + uniqueFemalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + uniqueMalePercent.toFixed(2) + '% (' + uniqueMale + ')">' + uniqueMalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + uniqueNonBinaryPercent.toFixed(2) + '% (' + uniqueNonBinary + ')">' + uniqueNonBinaryPercent.toFixed(0) + '%</td>' +
				'</tr>')
			*/

			createNewTable(false);

			//<th class="right">All</th>
			thead.append('<tr><th>&nbsp;</th><th class="right">Women</th><th class="right">Men</th><th class="right">Non-Binary</th></tr>');

			tbody.append(
				'<tr>' +
				'<td>Total</td>' +
				'<td class="right ttt" data-tooltip="' + totalFemalePercent.toFixed(2) + '% (' + totalFemale + ')">' + totalFemalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + totalMalePercent.toFixed(2) + '% (' + totalMale + ')">' + totalMalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + totalNonBinaryPercent.toFixed(2) + '% (' + totalNonBinary + ')">' + totalNonBinaryPercent.toFixed(0) + '%</td>' +
				'</tr>' +
				'<tr>' +
				'<td>Distinct</td>' +
				'<td class="right ttt" data-tooltip="' + uniqueFemalePercent.toFixed(2) + '% (' + uniqueFemale + ')">' + uniqueFemalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + uniqueMalePercent.toFixed(2) + '% (' + uniqueMale + ')">' + uniqueMalePercent.toFixed(0) + '%</td>' +
				'<td class="right ttt" data-tooltip="' + uniqueNonBinaryPercent.toFixed(2) + '% (' + uniqueNonBinary + ')">' + uniqueNonBinaryPercent.toFixed(0) + '%</td>' +
				'</tr>')
		}

		function makeBox(number, description, tooltip = '', isYear = false) {
			var attribs = ' class="tablesorter box"';
            if (tooltip) {
                attribs = ' class="tablesorter box ttt" data-tooltip="' + tooltip + '"';
            }
			return '<table' + attribs + '>' +
                '<thead><tr><th>' + description + '</th></tr></thead>' +
				'<tbody><tr><td class="number">' +
				(isYear ? number : number.toLocaleString()) +
				'</td></tr></tbody>' +
                '</table>';
		}

		function makeInfo(title, text) {
            $('body').append(
				'<table class="tablesorter">' +
                '<thead><tr><th>' + title + '</th></tr></thead>' +
                '<tbody><tr><td>' + text + '</td></tr></tbody>' +
                '</table>');
		}

		function showHidden() {
			d3.select('.initially_hidden').style('display', 'block');
		}

		function showList(listName) {

			var lbList = data.Lists.filter(a => a.ListName == listName)[0];

			resetView();
			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">' + lbList.ListName + '</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			for (var film in lbList.Entries) {

				var details = lbList.Entries[film].Year + '<br/>';
				if (lbList.Entries[film].RatingSelf > 0) {
                    details += '&#9670;'.repeat(lbList.Entries[film].RatingSelf);
				} else {
					details += '&nbsp;';
				}

				details += '<br/>';
				if (lbList.Entries[film].PrimaryLanguage.length == 0) {
					details += 'No Spoken Language';
				} else if (lbList.Entries[film].PrimaryLanguage != "English") {
					details += lbList.Entries[film].PrimaryLanguage;
				} else {
					details += '&nbsp;';
				}

                var title = lbList.Entries[film].FilmName;
                if (lbList.Entries[film].FilmNameOriginal != lbList.Entries[film].FilmName) {
                    title = lbList.Entries[film].FilmNameOriginal + '<br>(&quot;' + lbList.Entries[film].FilmName + '&quot;)';
                }

				// <a href="https://boxd.it/' + lbList.Entries[film].LetterboxdIdentifier + '">' + lbList.Entries[film].FilmName + '</a>
				insideGallery.append(
                    '<div class="item ttt" data-tooltip="' + title + '">' +
					'<div class="poster"><a target="_blank" href="https://boxd.it/' + lbList.Entries[film].LetterboxdIdentifier + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + lbList.Entries[film].PosterUrl + '"></a></div>' +
					'<div class="details">' + details + '<br/></div>' +
					'</a></div>');
			}

			createNewTable();

			if (documentWidth < 500) {
				thead.append('<tr class="topheader"><th colspan="4">' + lbList.ListName + '</th></tr>');
				thead.append('<tr class="bottomheader"><th>#</th><th>Film</th><th>Year</th><th>Rating</th></tr>');
			} else {
				thead.append('<tr class="topheader"><th colspan="5">' + lbList.ListName + '</th></tr>');
				thead.append('<tr class="bottomheader"><th>Order</th><th>Film</th><th>Year</th><th>Rating</th><th>Language</th></tr>');
			}

			for (var film in lbList.Entries) {

				var lang = '';
				if (lbList.Entries[film].PrimaryLanguage.length == 0) {
					lang = 'No Spoken Language';
				} else if (lbList.Entries[film].PrimaryLanguage != "English") {
					lang = lbList.Entries[film].PrimaryLanguage;
				}

				var langInfo = '';
				if (documentWidth >= 500) {
					langInfo = '<td>' + lang + '</td>';
				}

                var title = lbList.Entries[film].FilmName;
                if (lbList.Entries[film].FilmNameOriginal != lbList.Entries[film].FilmName) {
                    title = lbList.Entries[film].FilmNameOriginal + '<br>(&quot;' + lbList.Entries[film].FilmName + '&quot;)';
                }

				tbody.append(
					'<tr>' +
					'<td class="right">' + lbList.Entries[film].Order + '</td>' +
					'<td><a target="_blank" href="https://boxd.it/' + lbList.Entries[film].LetterboxdIdentifier + '">' + title + '</a></td>' +
					'<td class="right">' + lbList.Entries[film].Year + '</td>' +
                    '<td style="line-height: 0.8em;padding-top:5px;vertical-align:top">' + (lbList.Entries[film].RatingSelf > 0 ? '&#9670;'.repeat(lbList.Entries[film].RatingSelf) : '&nbsp;') + '</td>' +
					langInfo +
					'</tr>');

			}

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[0, 0]],
				headers: {
					0: { sorter: false },
					1: { sortInitialOrder: 'asc' },
					2: { sortInitialOrder: 'asc' },
					3: { sortInitialOrder: 'desc' },
					4: { sortInitialOrder: 'desc' },
					5: { sortInitialOrder: 'asc' },
				}
			});

			createTooltipTriggers();

			deactivateAll();
			$(event.target).addClass('active');

		}

		function showListRecent(listName, listTitle, amount = galleryAmount) {

			var lbList = data.Lists.filter(a => a.ListName == listName)[0];

			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">' + listTitle + '</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var listFilms = lbList.Entries.slice(-amount).reverse();

			for (var film of listFilms) {

				var details = film.Year + '<br/>';
                if (film.RatingSelf > 0) {
                    details += '&#9670;'.repeat(film.RatingSelf);
				} else {
					details += '&nbsp;';
				}

				details += '<br/>';
				if (film.PrimaryLanguage.length == 0) {
					details += 'No Spoken Language';
				} else if (film.PrimaryLanguage != "English") {
					details += film.PrimaryLanguage;
				} else {
					details += '&nbsp;';
				}

				var title = film.FilmName;
				if (film.FilmNameOriginal != film.FilmName) {
                    title = film.FilmNameOriginal + '<br>(&quot;' + film.FilmName + '&quot;)';
				}

				// <a href="https://boxd.it/' + film.LetterboxdIdentifier + '">' + film.FilmName + '</a>
				insideGallery.append(
					'<div class="item ttt" data-tooltip="' + title + '">' +
					'<div class="poster"><a target="_blank" href="https://boxd.it/' + film.LetterboxdIdentifier + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.PosterUrl + '"></a></div>' +
					'<div class="details">' + details + '<br/></div>' +
					'</a></div>');
			}

			createTooltipTriggers();

			deactivateAll();
			$(event.target).addClass('active');

		}

		function showOverall() {

			resetView();

			makeInfo(
				'Hello',
				'Click a section ' + (window.innerWidth > 900 ? 'on the left' : 'above') + ' to explore the statistics for the <a href="https://letterboxd.com/' + data.Username + '/films/">' + data.TotalFilms.toLocaleString() + ' watched films</a>.<br/> The statistics were generated on ' + data.LastUpdated + '.')

			//'<div class="info">Click a section ' + (window.innerWidth > 900 ? 'on the left' : 'above') + ' to explore the statistics for <a target="_blank" href="https://letterboxd.com/' + data.Username + '/">' + data.Username + '\'s</a> ' + data.TotalFilms.toLocaleString() + ' <a href="https://letterboxd.com/' + data.Username + '/films/">watched films</a>.<br/>The statistics were generated on ' + data.LastUpdated + '.</div>');

			//$('body').append('<div class="boxes"></div>');
			//$('.boxes').last().append(makeBox(, 'Stats Generated Date'));

			//$('body').append('<div class="boxes"></div>');
			//$('.boxes').last().append(makeBox(data.TotalFilms.toLocaleString(), 'Watched Films'));

			var percent = (data.RatedFilms / data.TotalFilms * 100);
			//$('.boxes').last().append(makeBox(data.RatedFilms.toLocaleString(), 'Rated Films'));
			//$('.boxes').last().append(makeBox(percent.toFixed(0) + '%', 'Rated Films', percent.toFixed(2) + '%'));

			//$('body').append('<div class="info"><a target="_blank" href="https://letterboxd.com/' + data.Username + '/">' + data.Username + '\'s Letterboxd</a>.</div>');

			showListRecent('Watched in 2024', "Recently Watched <span class='subtitle'>starting with the most recent</span>", galleryAmount);

			createTooltipTriggers();

			//deactivateAll();
			//if (event) {
			//	$(event.target).addClass('active');
			//}
		}

		function showFilmsPerYearChart() {

			$('body').append('<div id="outside"><div class="title">Films Watched by Release Year <span class="subtitle">capped at 40</span></div><figure class="highcharts-figure"><div id="container"></div></figure></div>');

			var cats = []
			var groups = []
			var counter = 0;
			for (var a = 1920; a <= new Date().getFullYear(); a += 10) {
				cats.push(a + 's')
			}

			for (var a = 0; a < 10; a++) {
				var series = {};
				series.color = 'black';
				series.animation = false;
				series.name = counter++;
				series.data = [];
				for (var b = 0; b < cats.length; b++) {
					var year = 1920 + (b * 10) + a;
					series.data.push(Math.min(40, data.FilmsWatchedPerYear[year]));
				}
				groups.push(series);
			}

			Highcharts.chart('container', {
				chart: {
					type: 'column',
				},
				title: {
					text: null,
					enabled: false
				},
				subtitle: {
					enabled: false
				},
				credits: {
					enabled: false
				},
				xAxis: {
					category: false,
					categories: cats,
					gridLineWidth: 1,
					tickInterval: 1,
					gridLineColor: '#ddd',
					tickColor: '#ddd',
					tickLength: 8,
					tickWidth: 1,
					tickmarkPlacement: 'between',
					title: {
						text: 'Release Year'
					}
				},
				yAxis: {
					min: 0,
					max: 40,
					plotLines: [{
						color: '#ddd',
						value: 0,
						width: 1,
						zIndex: 5
					}],
					gridLineWidth: 1,
					tickColor: '#ddd',
					tickLength: 8,
					tickWidth: 1,
					tickmarkPlacement: 'between',
					title: {
						text: 'Films Watched'
					}
				},
				legend: {
					enabled: false
				},
				tooltip: {
					formatter: function () {
						return (1920 + (this.point.x * 10) + this.series.name) + '<br/>' + this.point.y + ' film' + (this.point.y == 1 ? '' : 's')
					}
				},
				plotOptions: {
					column: {
						pointPadding: 0,
						borderWidth: 0,
						states: {
							hover: {
								color: 'RGBA(229, 0, 126)',
								enabled: true
							},
							inactive: {
								opacity: 1
							}
						}
					},
					series: {
						groupPadding: 0,
						pointWidth: 5,
						borderRadius: 0,
						cursor: 'pointer',
						point: {
							events: {
								click: function () {
									var year = (1920 + (this.x * 10) + this.series.name);
									window.open('https://letterboxd.com/' + data.Username + '/films/year/' + year + '/by/name/size/large/', '_blank');
								}
							}
						}
					}
				},
				series: groups
			});
		}

		function showFilmsPerYear() {

			resetView();

			if (documentWidth > 820) {
				showFilmsPerYearChart();
			}

			$('body').append('<div class="boxes"></div>');
			$('.boxes').append(makeBox(Math.round(data.AverageFilmYearMean), 'Film Year: Mean', data.AverageFilmYearMean.toFixed(2), true));
			$('.boxes').append(makeBox(data.AverageFilmYearMedian, 'Film Year: Median', null, true));
			$('.boxes').append(makeBox(data.AverageFilmYearMode, 'Film Year: Mode', null, true));

			//$('body').append('<div class="boxes"></div>');
			//$('.boxes').append(makeBox(Object.values(data.FilmsWatchedPerYear).filter(value => value > 0).length, 'Watched Years'));

			createNewTable();

			thead.append('<tr class="topheader"><th colspan="3">Films Watched by Release Year</th></tr>')
			thead.append('<tr class="bottomheader"><th>Year</th><th>Amount</th><th>Bar</th></tr>');

			var highest = 0;
			for (var year in data.FilmsWatchedPerYear) {
				highest = Math.max(highest, data.FilmsWatchedPerYear[year]);
			}

			for (var year in data.FilmsWatchedPerYear) {
				if (year >= 1874) {
					tbody.append(
						'<tr>' +
						'<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/year/' + year + '/by/name/size/large/">' + year + '</a></td>' +
						'<td class="right">' + data.FilmsWatchedPerYear[year] + '</td>' +
						'<td class="chart" data-value=' + data.FilmsWatchedPerYear[year] + '><span class="bar" style="width:' + Math.round((data.FilmsWatchedPerYear[year] / highest) * 100) + 'px">&nbsp;</span></td>' +
						'</tr>');
				}
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[0, 1]],
				headers: {
					0: { sorter: false },
					1: { sortInitialOrder: 'desc' },
					2: { sortInitialOrder: 'desc' },
					3: { sorter: false }
				}
			});

			var yearsWithoutFilms = [
				1870, 1871, 1872, 1873, 1875, 1876, 1877, 1879,
				1880, 1881, 1883, 1884, 1886, 1889
			];
			var thisYear = new Date().getFullYear();
			var thisDecade = thisYear - (thisYear % 10);

			var watched = 0, unwatched = 0;
			for (var a = thisDecade; a >= 1870; a -= 10) {
				for (var b = 0; b < 10; b++) {
					if (yearsWithoutFilms.includes(a + b)) {
					} else if (a + b > thisYear) {
					} else {
						var hasFilms = data.FilmsWatchedPerYear[a + b] > 0;
						if (hasFilms) {
							watched++;
						} else {
							unwatched++;
						}
					}
				}
			}

			$('body').append('<div class="boxes"></div>');
			$('.boxes').last().append(makeBox(watched, 'Watched Years'));
			$('.boxes').last().append(makeBox(unwatched, 'Unwatched Years'));

			if (documentWidth > 480) {
				createNewTable();
				thead.append('<tr><th colspan="10">Years Without Watched Films</th></tr>');
				for (var a = thisDecade; a >= 1870; a -= 10) {
					var output = '<tr>';
					for (var b = 0; b < 10; b++) {
						if (yearsWithoutFilms.includes(a + b)) {
							output += '<td>&nbsp;</td>';
						} else if (a + b > thisYear) {
							output += '<td>&nbsp;</td>';
						} else {
							var hasFilms = data.FilmsWatchedPerYear[a + b] > 0;
							if (hasFilms) {
								output += '<td style="color: #ddd">' + (a + b) + '</td>';
							} else {
								output += '<td><a target="_blank" href="https://letterboxd.com/films/popular/year/' + (a + b) + '/size/large/">' + (a + b) + '</a></td>';
							}
						}
					}
					output += '</tr>';
					tbody.append(output);
				}
			}

			createTooltipTriggers();

			deactivateAll();
			$(event.target).addClass('active');
		}

		function showFilmsPerDecadeChart() {

			$('body').append('<div id="outside"><div class="title">Films Watched by Release Decade</div><figure class="highcharts-figure"><div id="container"></div></figure></div>');

			var cats = [];
			var values = [];

			for (var a = 1900; a <= new Date().getFullYear(); a += 10) {
				cats.push(a + 's')
				values.push(data.FilmsWatchedPerDecade[a].Count)
			}

			Highcharts.chart('container', {
				chart: {
					type: 'column'
				},
				title: {
					text: null,
					enabled: false,
				},
				credits: {
					enabled: false
				},
				legend: {
					enabled: false
				},
				xAxis: {
					categories: cats,
					xcrosshair: true,
					title: {
						text: 'Release Decade'
					}
				},
				yAxis: {
					min: 0,
					title: {
						text: 'Films Watched'
					},
					labels: {
						enabled: false
					},
				},
				tooltip: {
					enabled: false
				},
				plotOptions: {
					column: {
						pointPadding: 0,
						borderWidth: 0,
						dataLabels: {
							enabled: true,
							align: 'center',
							x: 3
						},
					},
				},
				series: [
					{
						name: '',
						animation: false,
						color: 'black',
						data: values,
						enableMouseTracking: true,
						cursor: 'pointer',
						point: {
							events: {
								click: function () {
									window.open('https://letterboxd.com/' + data.Username + '/films/decade/' + this.category + '/by/name/size/large/', '_blank');
								}
							}
						}
					}
				]
			});
		}

		function showFilmsPerDecade() {

			resetView();

			if (documentWidth > 820) {
				showFilmsPerDecadeChart();
			}

			$('body').append('<div class="boxes"></div>');
			$('.boxes').append(makeBox(Object.values(data.FilmsWatchedPerDecade).filter(x => x.Count > 0).length, 'Watched Decades'));

			createNewTable();

			if (documentWidth < 500) {
				thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th></tr>');
				thead.append('<tr class="bottomheader"><th>Decade</th><th>Σ</th><th>%</th><th>Bar</th></tr>');
			} else {
				thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th><th colspan="2">Rating</th></tr>');
				thead.append('<tr class="bottomheader"><th>Decade</th><th>Σ</th><th>%</th><th>Bar</th><th>Average</th><th>Bar</th></tr>');
			}

			var highest = data.TotalFilms, total = 0;
			for (var decade in data.FilmsWatchedPerDecade) {
				highest = Math.max(highest, data.FilmsWatchedPerDecade[decade].Count);
				total += data.FilmsWatchedPerDecade[decade].Count;
			}

			var highestRating = 5;
			for (var decade in data.FilmsWatchedPerDecade) {
				var rating = "";
				if (data.FilmsWatchedPerDecade[decade].RatingCount > 0) {
					rating = (data.FilmsWatchedPerDecade[decade].RatingTotal / data.FilmsWatchedPerDecade[decade].RatingCount).toFixed(1);
					highestRating = Math.max(rating, highestRating);
				}
			}

			for (var decade in data.FilmsWatchedPerDecade) {
				var rating = "";
				if (data.FilmsWatchedPerDecade[decade].RatingCount > 0) {
					rating = (data.FilmsWatchedPerDecade[decade].RatingTotal / data.FilmsWatchedPerDecade[decade].RatingCount).toFixed(1);
				}

				var watchedPercent = (data.FilmsWatchedPerDecade[decade].Count / total) * 100;

				var lowBase = data.FilmsWatchedPerDecade[decade].RatingCount < sufficientBase;

				var middle = '';
				if (documentWidth >= 500) {
					middle =
						'<td class="' + (lowBase ? 'lowbase ' : '') + 'right ttt" data-tooltip="Based on ' + data.FilmsWatchedPerDecade[decade].RatingCount + ' rated film(s)."><span>' + rating + '</span></td>' +
						'<td class="' + (lowBase ? 'lowbase ' : '') + 'chart" data-value="' + rating + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((rating / highestRating) * 100) + 'px">&nbsp;</span></span></td>';
				}

				tbody.append(
					'<tr>' +
					'<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/decade/' + decade + 's/by/name/size/large/">' + decade + 's</a></td>' +
					'<td class="right">' + data.FilmsWatchedPerDecade[decade].Count + '</td>' +
					'<td class="right ttt" data-tooltip="' + watchedPercent.toFixed(2) + '%" data-value="' + data.FilmsWatchedPerDecade[decade].Count + '">' + watchedPercent.toFixed(0) + '%</td>' +
					'<td class="chart" data-value="' + data.FilmsWatchedPerDecade[decade].Count + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((data.FilmsWatchedPerDecade[decade].Count / highest) * 100) + 'px">&nbsp;</span></span></td>' +
					middle +
					'</tr>');
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[0, 1]],
				headers: {
					0: { sorter: false },
					1: { sorter: false },
					2: { sorter: false },
					3: { sortInitialOrder: 'desc' },
					4: { sortInitialOrder: 'desc' },
					5: { sortInitialOrder: 'desc', sorter: 'data-value' },
					6: { sorter: false },
					7: { sortInitialOrder: 'desc' },
					8: { sorter: false },
				},
				cssHeaderRow: "tablesorter-headerRow"
			});

			createTooltipTriggers();

			deactivateAll();
			if (event) {
				$(event.target).addClass('active');
			}
		}

		function showFilmsPerCentury() {

			resetView();
			createNewTable();

			thead.append('<tr><th>Century</th><th>Films #</th><th>Films %</th><th>Bar</th></tr>');

			var centuryData = { '1800': 0, '1900': 0, '2000': 0 };

			var total = 0;
			for (var decade in data.FilmsWatchedPerDecade) {
				var century = +decade - (+decade % 100)
				centuryData[century] += data.FilmsWatchedPerDecade[decade];
				total += data.FilmsWatchedPerDecade[decade];
			}

			var highest = 0;
			for (var century in centuryData) {
				highest = Math.max(highest, centuryData[century]);
			}

			for (var century in centuryData) {
				tbody.append(
					'<tr>' +
					'<td>' + century + 's</td>' +
					'<td class="right">' + centuryData[century] + '</td>' +
					'<td class="right" data-value="' + centuryData[century] + '">' + ((centuryData[century] / total) * 100).toFixed(0) + '%</td>' +
					'<td class="chart" data-value="' + centuryData[century] + '"><span class="bar" style="width:' + Math.round((centuryData[century] / highest) * 100) + 'px">&nbsp;</span></td>' +
					'</tr>');
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[0, 1]],
				headers: {
					0: { sortInitialOrder: 'desc' },
					1: { sortInitialOrder: 'desc' },
					2: { sortInitialOrder: 'desc', sorter: 'data-value' },
					3: { sortInitialOrder: 'desc', sorter: 'data-value' },
				}
			});

			deactivateAll();
			$(event.target).addClass('active');
		}

		function showYearsWithoutFilms() {

			var yearsWithoutFilms = [
				1870, 1871, 1872, 1873, 1875, 1876, 1877, 1879,
				1880, 1881, 1883, 1884, 1886,
			];

			resetView();
			createNewTable();

			thead.append('<tr><th colspan="10">Years</th></tr>');

			var thisYear = new Date().getFullYear();
			var thisDecade = thisYear - (thisYear % 10);

			var watched = 0, unwatched = 0;
			for (var a = thisDecade; a >= 1870; a -= 10) {
				var output = '<tr>';
				for (var b = 0; b < 10; b++) {
					if (yearsWithoutFilms.includes(a + b)) {
						output += '<td>&nbsp;</td>';
					} else if (a + b > thisYear) {
						output += '<td>&nbsp;</td>';
					} else {
						var hasFilms = data.FilmsWatchedPerYear[a + b] > 0;
						if (hasFilms) {
							output += '<td style="color: #bbb">' + (a + b) + '</td>';
							watched++;
						} else {
							output += '<td><a target="_blank" href="https://letterboxd.com/films/popular/year/' + (a + b) + '/size/large/">' + (a + b) + '</a></td>';
							unwatched++;
						}
					}
				}
				output += '</tr>';
				tbody.append(output);
			}

			$('body').append('<div class="boxes"></div>');
			$('.boxes').append(makeBox(watched, 'Watched Years'));
			$('.boxes').append(makeBox(unwatched, 'Unwatched Years'));

			deactivateAll();
			$(event.target).addClass('active');
		}

		function showNewestReleasedFilms() {

			resetView();
			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">Top ' + galleryAmount + ' Newest Released Films</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var displayed = 0;
			for (var index of data.NewestReleasedFilms) {
				var film = films[index];
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
				insideGallery.append(
					'<div class="item ttt" data-tooltip="' + title + '">' +
					'<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + film.When + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>' +
					'</a></div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			createNewTable();

			thead.append('<tr class="topheader"><th colspan="2">Top ' + Object.values(data.OldestReleasedFilms).length + ' Newest Released Films</th></tr>');
			thead.append('<tr class="bottomheader"><th>Date</th><th>Title</th></tr>');

            for (var index of data.NewestReleasedFilms) {
				var film = films[index];
                var tooltip = '';
                if (film.Poster.length > 0) {
                    tooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>"';
				}
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
				tbody.append(
					'<tr' + tooltip + '>' +
					'<td class="right">' + film.When + '</td>' +
					'<td><a target="_blank" href="https://boxd.it/' + film.Id + '">' + title + '</a></td>' +
					'</tr>');
			}

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[0, 1]],
				headers: {
					0: { sorter: false },
					1: { sortInitialOrder: 'desc' },
					2: { sortInitialOrder: 'asc' }
				}
			});

            makeInfo('Info', 'Show <a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/by/release-latest/size/large/">all watched films by release date (newest first)</a>.');

			deactivateAll();
			$(event.target).addClass('active');

			createTooltipTriggers();
		}

		function showOldestReleasedFilms() {

			resetView();
			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">Top ' + galleryAmount + ' Earliest Released Films</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var displayed = 0;
			for (var index of data.OldestReleasedFilms) {
				var film = films[index];
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
				insideGallery.append(
					'<div class="item ttt" data-tooltip="' + title + '">' +
					'<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + film.When + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>' +
					'</a></div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			createNewTable();

			thead.append('<tr class="topheader"><th colspan="2">Top ' + Object.values(data.OldestReleasedFilms).length + ' Earliest Released Films</th></tr>');
			thead.append('<tr class="bottomheader"><th>Date</th><th>Title</th></tr>');

			for (var index of data.OldestReleasedFilms) {
				var film = films[index];
                var tooltip = '';
                if (film.Poster.length > 0) {
                    tooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>"';
				}
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
				tbody.append(
					'<tr' + tooltip + '>' +
					'<td class="right">' + film.When + '</td>' +
					'<td><a target="_blank" href="https://boxd.it/' + film.Id + '">' + title + '</a></td>' +
					'</tr>');
			}

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[2, 0]],
				headers: {
					0: { sorter: false },
					1: { sortInitialOrder: 'desc' },
					2: { sortInitialOrder: 'asc' }
				}
			});

            makeInfo('Info', 'Show <a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/by/release-earliest/size/large/">all watched films by release date (oldest first)</a>.');

			deactivateAll();
			$(event.target).addClass('active');

			createTooltipTriggers();
		}

		function showFilms(list) {
			var output = [];
			for (var film of list.split(' ')) {
                output.push(films[+film].Title + ' (' + films[+film].Year + ')');
			}
			output.sort();
			alert(output.join('\r\n'));
		}

        function showTitles() {

            resetView();
            createNewTable();

            thead.append('<tr class="topheader"><th colspan="2">Top ' + galleryAmount + ' Longest Film Titles</th></tr>');
            thead.append('<tr class="bottomheader"><th>Year</th><th>Title</th></tr>');

            var displayed = 0;
			for (var index of data.LongestTitleFilms) {
				var film = films[index];
                var tooltip = '';
                if (film.Poster && film.Poster.length > 0) {
                    tooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>"';
                }
                tbody.append(
                    '<tr' + tooltip + '>' +
                    '<td class="right">' + film.Year + '</td>' +
                    '<td class="mono"><a target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
					'</tr>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'asc' }
                }
			});

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="2">Film Titles: 3 Characters or Fewer</th></tr>');
            thead.append('<tr class="bottomheader"><th>Year</th><th style="width:200px;">Title</th></tr>');

			displayed = 0;
            for (var index of data.ShortestTitleFilms) {
				var film = films[index];
                var tooltip = '';
                if (film.Poster && film.Poster.length > 0) {
                    tooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '\'>"';
                }
                tbody.append(
                    '<tr' + tooltip + '>' +
                    '<td class="right">' + film.Year + '</td>' +
                    '<td class="mono"><a target="_blank" href="https://boxd.it/' + film.Id + '">' + film.Title + '</a></td>' +
					'</tr>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
            }

            table.tablesorter({
                widgets: ['columns'],
                usNumberFormat: true,
                sortReset: false,
                sortRestart: false,
                headers: {
                    0: { sorter: false },
                    1: { sortInitialOrder: 'desc' },
                    2: { sortInitialOrder: 'asc' }
                }
			});

            createNewTable();

            thead.append('<tr class="topheader"><th colspan="2">Top ' + galleryAmount + ' Most Frequent Words in Titles <span class="subtitle">excluding stop words</span></th></tr>');
			thead.append('<tr class="bottomheader"><th>Word</th><th>Amount</th></tr>');

            displayed = 0;
			for (var word in data.MostFrequentWords) {
                tbody.append(
                    '<tr>' +
                    '<td style="width:10px" class="message" onmousedown="showFilms(\'' + data.MostFrequentWords[word].join(' ') + '\')">' + word + '</td>' +
                    '<td>' + data.MostFrequentWords[word].length + '</td>' +
                    '</tr>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

            deactivateAll();
            $(event.target).addClass('active');

            createTooltipTriggers();
        }

		function showLengthStats() {
			resetView();

			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">Top ' + galleryAmount + ' Longest Films</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var displayed = 0;
			for (var index of data.LongestFilms) {
				var film = films[index];
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
				var hours = 0, minutes = 0;
				hours = Math.floor(film.Minutes / 60);
				minutes = film.Minutes - (hours * 60);
				insideGallery.append(
					'<div class="item ttt" data-tooltip="' + title + '">' +
					'<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + hours + 'h ' + String(minutes).padStart(2, '0') + 'm<br/>' + film.Year + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>' +
					'</a></div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			var len = data.TotalMinutes / data.FilmsWithRuntime;
			len += 0.5; // this accounts for all film times being rounded down to the minute
			var seconds = len % 1;
			len = Math.floor(len);
			var lenLabel =
				Math.floor(len / 60) + '<span style="opacity:0.333">h</span> ' +
				((len % 60) + '').padStart(2, '0') + '<span style="opacity:0.333">m</span> ' +
				(Math.floor(60 * seconds) + '').padStart(2, '0') + '<span style="opacity:0.333">s</span>';

			$('body').append('<div class="boxes"></div>');
			$('.boxes').append(makeBox(lenLabel, '&VeryThinSpace;Average Film Length (Including Short Films)&VeryThinSpace;'));

			var len = data.TotalMinutesFull / data.FilmsWithRuntimeFull;
			len += 0.5; // this accounts for all film times being rounded down to the minute
			var seconds = len % 1;
			len = Math.floor(len);
			var lenLabel =
				Math.floor(len / 60) + '<span style="opacity:0.333">h</span> ' +
				((len % 60) + '').padStart(2, '0') + '<span style="opacity:0.333">m</span> ' +
				(Math.floor(60 * seconds) + '').padStart(2, '0') + '<span style="opacity:0.333">s</span>';

			$('body').append('<div class="boxes"></div>');
			$('.boxes').last().append(makeBox(lenLabel, 'Average Film Length (Excluding Short Films)'));

			createNewTable();

			thead.append('<tr><th>Stat</th><th class="right">Amount</th></tr>');

			//tbody.append('<tr><td>Total Films</td><td class="right">' + data.TotalFilms + '</td></tr>');
			//tbody.append('<tr class="breaker"><td>Total Rated Films</td><td class="right">' + data.RatedFilms + '</td></tr>');
			tbody.append('<tr><td>Watched Minutes</td><td class="right">' + data.TotalMinutes.toLocaleString() + '</td></tr>');
			tbody.append('<tr><td>Watched Hours</td><td class="right">' + Math.round(data.TotalMinutes / 60).toLocaleString() + '</td></tr>');
			tbody.append('<tr><td>Watched Days</td><td class="right">' + Math.round(data.TotalMinutes / 60 / 24).toLocaleString() + '</td></tr>');
			tbody.append('<tr class="breaker"><td>Watched Weeks</td><td class="right">' + Math.round(data.TotalMinutes / 60 / 24 / 7).toLocaleString() + '</td></tr>');
			//tbody.append('<tr><td>Average Film Length&nbsp;</td><td class="right">&nbsp;' + lenLabel + '</td></tr>');

			createNewTable();

			if (documentWidth < 500) {
				thead.append('<tr><th>Length</th><th>Films Σ</th><th>Films %</th></tr>');
			} else {
				thead.append('<tr><th>Length</th><th>Films Σ</th><th>Films %</th><th>Bar</th></tr>');
			}

			var highest = data.FilmsWithRuntime, total = 0;
			for (var thirty in data.FilmsPerThirtyMinutes) {
				highest = Math.max(highest, data.FilmsPerThirtyMinutes[thirty]);
			}

			for (var thirty in data.FilmsPerThirtyMinutes) {
				//var label = (thirty / 60).toFixed(1) + "h <= x < " + ((+thirty + 30) / 60).toFixed(1) + "h";
				var number = +thirty;
				var label =
					Math.floor(number / 60) + "h" + (number % 60 == 0 ? '00' : '30') + "m" +
					" to " +
					Math.floor(number / 60) + "h" + (number % 60 == 0 ? '29' : '59') + "m";
				var percent = (data.FilmsPerThirtyMinutes[thirty] / data.TotalFilms) * 100;
				var bar = '';
				if (documentWidth >= 500) {
					bar = '<td class="chart" data-value="' + data.FilmsPerThirtyMinutes[thirty] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((data.FilmsPerThirtyMinutes[thirty] / highest) * 100) + 'px">&nbsp;</span></span></td>';
				}
				tbody.append(
					'<tr>' +
					'<td data-value="' + number + '">' + label + '</td>' +
					'<td class="right">' + data.FilmsPerThirtyMinutes[thirty] + '</td>' +
					'<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + data.FilmsPerThirtyMinutes[thirty] + '">' + percent.toFixed(0) + '%</td>' +
					bar +
					'</tr>');
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			table.tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[0, 0]],
				headers: {
					0: { sortInitialOrder: 'asc', sorter: 'data-value' },
					1: { sortInitialOrder: 'desc' },
					2: { sortInitialOrder: 'desc', sorter: 'data-value' },
					3: { sortInitialOrder: 'desc', sorter: 'data-value' },
				}
			});

			createTooltipTriggers();

			deactivateAll();
			if (event) {
				$(event.target).addClass('active');
			}
		}

		function showLongestFilms() {

			resetView();
			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">Top ' + galleryAmount + ' Longest Films</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var displayed = 0;
            for (var index of data.LongestFilms) {
                var film = films[index];
				var hours = 0, minutes = 0;
                hours = Math.floor(film.Minutes / 60);
				minutes = film.Minutes - (hours * 60);
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
				insideGallery.append(
					'<div class="item ttt" data-tooltip="' + title + '">' +
                    '<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + hours + 'h ' + String(minutes).padStart(2, '0') + 'm<br/>' + film.Year + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>' +
					'</a></div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			createNewTable();

			if (documentWidth < 500) {
				thead.append('<tr class="topheader"><th colspan="3">Top ' + Object.values(data.LongestFilms).length + ' Longest Films</th></tr>');
				thead.append('<tr class="bottomheader"><th>Title</th><th>Year</th><th>Length</th></tr>');
			} else {
				thead.append('<tr class="topheader"><th colspan="4">Top ' + Object.values(data.LongestFilms).length + ' Longest Films</th></tr>');
				thead.append('<tr class="bottomheader"><th>Title</th><th>Year</th><th>Length</th><th>Bar</th></tr>');
			}

			var highest = 0;
			for (var index of data.LongestFilms) {
                var film = films[index];
                highest = Math.max(highest, film.Minutes);
			}

            for (var index of data.LongestFilms) {
				var film = films[index];

				var hours = 0, minutes = 0;
                hours = Math.floor(film.Minutes / 60);
                minutes = film.Minutes - (hours * 60);

				var bar = '';
				if (documentWidth >= 500) {
                    bar = '<td class="chart"><span class="hidden">' + film.Minutes + '</span><span class="bar" style="width:' + Math.round((film.Minutes / highest) * 100) + 'px">&nbsp;</span></td>';
				}

				tbody.append(
					'<tr>' +
                    '<td><a target="_blank" href="https://boxd.it/' + film.Id + '">' + film + '</a></td>' +
                    '<td>' + film.Year + '</td>' +
					'<td class="right">' + hours + 'h ' + String(minutes).padStart(2, '0') + 'm</td>' +
					bar +
					'</tr>');
			}

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[2, 1]],
				headers: {
					0: { sorter: false },
					2: { sortInitialOrder: 'asc' },
					3: { sortInitialOrder: 'asc' },
					4: { sortInitialOrder: 'desc' },
					5: { sorter: false },
				}
			});

			$('body').append('<div class="info"><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/by/longest/size/large/">Show all watched films by length</a>.</div>');

			deactivateAll();
			$(event.target).addClass('active');

			createTooltipTriggers();
		}

		function formatNumber(number) {
			if (number >= 1000000) {
				return (Math.round(number / 100000) / 10) + 'm';
			} else {
				return number.toLocaleString();
			}
		}

		function showPopularity() {

			resetView();
			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">Top ' + galleryAmount + ' Most Watched Films by Letterboxd Users</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var displayed = 0;
			for (var index of data.MostWatchedFilms) {
				var film = films[index];
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
				insideGallery.append(
                    '<div class="item ttt" data-tooltip="' + title + '">' +
                    '<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details ttt" data-tooltip="' + film.Watched.toLocaleString() + '">' + formatNumber(film.Watched) + '<br/>' + film.Year + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>' +
					'</a></div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			createGallery();
			gallery = $('.gallery').last();

			gallery.append('<div class="title">Top ' + galleryAmount + ' Least Watched Films by Letterboxd Users</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside').last();

			displayed = 0;
			for (var index of data.LeastWatchedFilms) {
				var film = films[index];
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item ttt" data-tooltip="' + title + '">' +
                    '<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details ttt" data-tooltip="' + film.Watched.toLocaleString() + '">' + formatNumber(film.Watched) + '<br/>' + film.Year + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>' +
                    '</a></div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			deactivateAll();
			$(event.target).addClass('active');

			createTooltipTriggers();
		}

		function showRatings() {

			resetView();
			createGallery();
			var gallery = $('.gallery');

			gallery.append('<div class="title">Top ' + galleryAmount + ' Highest Rated Films by Letterboxd Users</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var displayed = 0;
			for (var index of data.HighestRatedFilms) {
				var film = films[index];
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + title + '&quot;)';
                }
				insideGallery.append(
					'<div class="item ttt" data-tooltip="' + film.Title + '">' +
                    '<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + film.RatingLetterboxd + '<br/>' + film.Year + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			createGallery();
			gallery = $('.gallery').last();

			gallery.append('<div class="title">Top ' + galleryAmount + ' Lowest Rated Films by Letterboxd Users</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside').last();

			displayed = 0;
			for (var index of data.LowestRatedFilms) {
				var film = films[index];
                var title = film.Title;
                if (film.TitleOriginal != film.Title) {
                    title = film.TitleOriginal + '<br>(&quot;' + film.Title + '&quot;)';
                }
                insideGallery.append(
                    '<div class="item ttt" data-tooltip="' + title + '">' +
                    '<div class="poster"><a target="_blank" href="https://boxd.it/' + film.Id + '"><img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + film.Poster + '"></a></div>' +
                    '<div class="details">' + film.RatingLetterboxd + '<br/>' + film.Year + '<br>' + (film.RatingSelf > 0 ? '&#9670;'.repeat(film.RatingSelf) : '&nbsp;') + '</div>');
                displayed++;
                if (displayed == galleryAmount)
                    break;
			}

			deactivateAll();
			$(event.target).addClass('active');

			createTooltipTriggers();
		}

		// converts language names to the ones that letterboxd uses, rightly or wrongly...
		function letterboxdLanguage(language) {
			language = language.toLowerCase().replace(/ /g, '-');
			switch (language) {
				case 'mandarin':
					return 'chinese';
				default:
					return language;
			}
		}

		function showFilmsPerLanguages() {

			resetView();

			$('body').append('<div class="boxes"></div>');
			$('.boxes').append(makeBox(Object.values(data.FilmsPerLanguage).length, 'Languages'));

			createNewTable();

			if (documentWidth < 500) {
				thead.append('<tr><th>Language</th><th>Films #</th><th>Films %</th></tr>');
			} else {
				thead.append('<tr><th>Language</th><th>Films #</th><th>Films %</th><th>Bar</th></tr>');
			}

			var highest = data.TotalFilms;
			for (var language in data.FilmsPerLanguage) {
				highest = Math.max(highest, data.FilmsPerLanguage[language]);
			}

			for (var language in data.FilmsPerLanguage) {
				var percent = (data.FilmsPerLanguage[language] / data.TotalFilms) * 100;
				var bar = '';
				if (documentWidth >= 500) {
					bar = '<td class="chart" data-value="' + data.FilmsPerLanguage[language] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((data.FilmsPerLanguage[language] / highest) * 100) + 'px">&nbsp;</span></span></td>';
				}
				tbody.append(
					'<tr>' +
					'<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/language/' + letterboxdLanguage(language) + '/by/name/size/large/">' + language + '</a></td>' +
					'<td class="right">' + data.FilmsPerLanguage[language] + '</td>' +
					'<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + data.FilmsPerLanguage[language] + '">' + percent.toFixed(0) + '%</td>' +
					bar +
					'</tr>');
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[1, 1]],
				headers: {
					0: { sortInitialOrder: 'desc' },
					1: { sortInitialOrder: 'desc' },
					2: { sortInitialOrder: 'desc', sorter: 'data-value' },
					3: { sorter: false },
				}
			});

			deactivateAll();
			$(event.target).addClass('active');

			makeInfo('Note', 'Language information is obtained from TMDB, which is sometimes different to Letterboxd.');

			createTooltipTriggers();
		}

		function showFilmsPerCountry() {

			resetView();

			$('body').append('<div class="boxes"></div>');
			$('.boxes').append(makeBox(Object.values(data.FilmsPerCountryOrigin).length, 'Origin Countries'));

			createNewTable();

			if (documentWidth < 500) {
				thead.append('<tr class="topheader"><th colspan="3">Origin Countries</th></tr>');
				thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th></tr>');
			} else {
				thead.append('<tr class="topheader"><th colspan="4">Origin Countries</th></tr>');
				thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th><th>Bar</th></tr>');
			}

			var highest = data.TotalFilms;
			for (var country in data.FilmsPerCountryOrigin) {
				highest = Math.max(highest, data.FilmsPerCountryOrigin[country]);
			}

			for (var country in data.FilmsPerCountryOrigin) {
				var percent = (data.FilmsPerCountryOrigin[country] / data.TotalFilms) * 100;
				var bar = '';
				if (documentWidth >= 500) {
					bar = '<td class="chart" data-value="' + data.FilmsPerCountryOrigin[country] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((data.FilmsPerCountryOrigin[country] / highest) * 100) + 'px">&nbsp;</span></span></td>';
				}
				tbody.append(
					'<tr>' +
					'<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/country/' + countryNameToUrl(country) + '/by/name/size/large/">' + country + '</a></td>' +
					'<td class="right">' + data.FilmsPerCountryOrigin[country] + '</td>' +
					'<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + data.FilmsPerCountryOrigin[country] + '">' + percent.toFixed(0) + '%</td>' +
					bar +
					'</tr>');
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			table.tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[1, 1]],
				headers: {
					0: { sorter: false },
					1: { sortInitialOrder: 'asc' },
					2: { sortInitialOrder: 'desc' },
					3: { sortInitialOrder: 'desc', sorter: 'data-value' },
					4: { sorter: false },
				}
			});

			$('body').append('<div class="boxes"></div>');
			$('.boxes').last().append(makeBox(Object.values(data.FilmsPerCountryProduction).length, 'Production Countries'));

			createNewTable();

			if (documentWidth < 500) {
				thead.append('<tr class="topheader"><th colspan="3">Production Countries</th></tr>');
				thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th></tr>');
			} else {
				thead.append('<tr class="topheader"><th colspan="4">Production Countries</th></tr>');
				thead.append('<tr class="bottomheader"><th>Name</th><th>Films Σ</th><th>Films %</th><th>Bar</th></tr>');
			}

			var highest = data.TotalFilms;
			for (var country in data.FilmsPerCountryProduction) {
				highest = Math.max(highest, data.FilmsPerCountryProduction[country]);
			}

			for (var country in data.FilmsPerCountryProduction) {
				var percent = (data.FilmsPerCountryProduction[country] / data.TotalFilms) * 100;
				var bar = '';
				if (documentWidth >= 500) {
					bar = '<td class="chart" data-value="' + data.FilmsPerCountryProduction[country] + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((data.FilmsPerCountryProduction[country] / highest) * 100) + 'px">&nbsp;</span></span></td>';
				}
				tbody.append(
					'<tr>' +
					'<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/country/' + countryNameToUrl(country) + '/by/name/size/large/">' + country + '</a></td>' +
					'<td class="right">' + data.FilmsPerCountryProduction[country] + '</td>' +
					'<td class="right ttt" data-tooltip="' + percent.toFixed(2) + '%" data-value="' + data.FilmsPerCountryProduction[country] + '">' + percent.toFixed(0) + '%</td>' +
					bar +
					'</tr>');
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			table.tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[1, 1]],
				headers: {
					0: { sorter: false },
					1: { sortInitialOrder: 'asc' },
					2: { sortInitialOrder: 'desc' },
					3: { sortInitialOrder: 'desc', sorter: 'data-value' },
					4: { sorter: false },
				}
			});

			makeInfo('Note', 'Country information is obtained from TMDB, which is sometimes different to Letterboxd.<br/><br/>Percentages add to more than 100% because many films are created/produced by more than one country.');

			deactivateAll();
			$(event.target).addClass('active');

			createTooltipTriggers();
		}

		function showGenres() {

			resetView();

			createNewTable();

			if (documentWidth < 600) {
				thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="2">Films</th><th>Rating</th></tr>');
				thead.append('<tr class="bottomheader"><th>Genre</th><th>Σ</th><th>%</th><th>Average</th></tr>');
			} else {
				thead.append('<tr class="topheader"><th>&nbsp;</th><th colspan="3">Films</th><th colspan="2">Rating</th></tr>');
				thead.append('<tr class="bottomheader"><th>Genre</th><th>Σ</th><th>%</th><th>Bar</th><th>Average</th><th>Bar</th></tr>');
			}

			var total = data.FilmsWithGenres;

			var highest = 0;
			for (var genre in data.Genres) {
				highest = Math.max(highest, data.Genres[genre].Count);
			}

			var highestRating = 5;
			for (var genre in data.Genres) {
				var rating = "";
				if (data.Genres[genre].RatingCount > 0) {
					rating = (data.Genres[genre].RatingTotal / data.Genres[genre].RatingCount).toFixed(1);
					highestRating = Math.max(rating, highestRating);
				}
			}

			for (var genre in data.Genres) {
				var rating = "";
				if (data.Genres[genre].RatingCount > 0) {
					rating = (data.Genres[genre].RatingTotal / data.Genres[genre].RatingCount).toFixed(1);
				}

				var watchedPercent = (data.Genres[genre].Count / total) * 100;
				var lowBase = data.Genres[genre].RatingCount < sufficientBase;
				var barAmount = '', barRating = '';
				if (documentWidth >= 600) {
					barAmount = '<td class="chart" data-value="' + data.Genres[genre].Count + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((data.Genres[genre].Count / data.FilmsWithGenres) * 100) + 'px">&nbsp;</span></span></td>';
					barRating = '<td class="' + (lowBase ? 'lowbase ' : '') + 'chart" data-value="' + rating + '"><span class="bar_container"><span class="bar" style="width:' + Math.round((rating / highestRating) * 100) + 'px">&nbsp;</span></span></td>';
				}

				tbody.append(
					'<tr>' +
					'<td><a target="_blank" href="https://letterboxd.com/' + data.Username + '/films/genre/' + genre.toLowerCase().replace(/ /g, '-') + '/by/name/size/large/">' + genre + '</a></td>' +
					'<td class="right">' + data.Genres[genre].Count + '</td>' +
					'<td class="right ttt" data-tooltip="' + watchedPercent.toFixed(2) + '%" data-value="' + data.Genres[genre].Count + '">' + watchedPercent.toFixed(0) + '%</td>' +
					barAmount +
					'<td class="' + (lowBase ? 'lowbase ' : '') + 'right ttt" data-tooltip="Based on ' + data.Genres[genre].RatingCount + ' rated film(s)."><span>' + rating + '</span></td>' +
					barRating +
					'</tr>');
			}

			$.tablesorter.addParser({
				id: 'data-value',
				is: function () {
					return false;
				},
				format: function (s, table, cell) {
					return $(cell).attr('data-value') || s;
				},
				type: 'text'
			});

			if (documentWidth < 600) {
				$('#main').tablesorter({
					widgets: ['columns'],
					usNumberFormat: true,
					sortReset: false,
					sortRestart: false,
					sortList: [[1, 1]],
					headers: {
						0: { sorter: false },
						1: { sorter: false },
						2: { sorter: false },
						3: { sortInitialOrder: 'asc' },
						4: { sortInitialOrder: 'desc' },
						5: { sortInitialOrder: 'desc', sorter: 'data-value' },
						6: { sortInitialOrder: 'desc' },
					},
					cssHeaderRow: "tablesorter-headerRow"
				});
			} else {
				$('#main').tablesorter({
					widgets: ['columns'],
					usNumberFormat: true,
					sortReset: false,
					sortRestart: false,
					sortList: [[1, 1]],
					headers: {
						0: { sorter: false },
						1: { sorter: false },
						2: { sorter: false },
						3: { sortInitialOrder: 'asc' },
						4: { sortInitialOrder: 'desc' },
						5: { sortInitialOrder: 'desc', sorter: 'data-value' },
						6: { sorter: false },
						7: { sortInitialOrder: 'desc' },
						8: { sorter: false },
					},
					cssHeaderRow: "tablesorter-headerRow"
				});
			}

			createTooltipTriggers();

			makeInfo('Note', 'Genre information is obtained from TMDB, which is sometimes different to Letterboxd.');

			deactivateAll();
			if (event) {
				$(event.target).addClass('active');
			}
		}

		function urlSafe(text) {
			// general character replacements
			text = text.replace(/\./g, '');
			text = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
			text = text.replace("'", "");
			// specific fixes
			text = text.replace('elliot-page', 'contributor:17664');
			text = text.replace('eliot-sumner', 'eliot-sumner-1');
			text = text.replace('beeban-kidron', 'beeban-kidron-1');
			text = text.replace('typhoon', 'typhoon-2');
			return text;
		}

		function shuffleArray(array) {
			for (let i = array.length - 1; i > 0; i--) {
				const j = Math.floor(Math.random() * (i + 1));
				[array[i], array[j]] = [array[j], array[i]];
			}
			return array;
		}

		function makeDot(gender) {
			var colour = 'black';
			var symbol = '&#9671;';
			switch (gender) {
				case 1:
					colour = 'RGB(235, 0, 100)';
                    symbol = '&#9670;';
					break;
				case 2:
					colour = 'RGB(0, 182, 255)';
                    symbol = '&#9670;';
					break;
				case 3:
					colour = 'RGB(0, 182, 0)';
                    symbol = '&#9670;';
					break;
			}
			return '<span style="color:' + colour + '">' + symbol + '</span>';
		}

		function showPeople(dataSource, job, jobSpecific, gender = '') {

			resetView();
			createGallery();

			var gallery = $('.gallery');
			var minimum = dataSource.length >= galleryAmount ? dataSource[galleryAmount].Amount : 0;

			//var shuffled = shuffleArray(dataSource.filter(a => a.Poster.length > 2).slice(0));
			//shuffled = shuffled.sort((a, b) => b.Amount - a.Amount);
			//var lowest = shuffled.length >= galleryAmount - 1 ? shuffled[galleryAmount - 1].Amount : 0;

			var shuffled = dataSource.filter(a => a.Amount > minimum);

			gallery.append('<div class="title">Most Frequent - ' + jobSpecific + (gender == 'All' ? '' : ' - ' + gender) + '</div>');
			gallery.append('<div class="inside"></div>');
			var insideGallery = $('.gallery .inside');

			var displayed = 0;
			for (var person of shuffled) {
				var url = 'https://letterboxd.com/' + data.Username + '/films/with/' + job.toLowerCase() + '/' + urlSafe(person.FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
				insideGallery.append(
					'<div class="item">' +
					'<div class="poster"><a target="_blank" href="' + url + '">' +
					(person.Poster ? '<img src="https://image.tmdb.org/t/p/w220_and_h330_face/' + person.Poster + '">' : '<div class="empty">&nbsp;</div>') +
					'</a></div > ' +
					'<div class="details">×' + person.Amount + '<br/><a target="_blank" href="' + url + '">' + person.FullName + '</a></div>' +
					'</a></div>');
				displayed++;
				if (displayed == galleryAmount)
					break;
			}

			$('body').append('<div class="boxes"></div>');
			switch (gender) {
				case 'All':
					switch (jobSpecific) {
						case 'Director':
							$('.boxes').append(makeBox(data.DirectorTotalAll, 'Total'));
							$('.boxes').append(makeBox(data.DirectorUniqueAll, 'Distinct'));
							break;
						case 'Protagonist':
							$('.boxes').append(makeBox(data.ProtagonistTotalAll, 'Total'));
							$('.boxes').append(makeBox(data.ProtagonistUniqueAll, 'Distinct'));
							break;
						case 'Main Cast':
							$('.boxes').append(makeBox(data.TopCastTotalAll, 'Total'));
							$('.boxes').append(makeBox(data.TopCastUniqueAll, 'Distinct'));
							break;
						case 'Entire Cast':
							$('.boxes').append(makeBox(data.EntireCastTotalAll, 'Total'));
							$('.boxes').append(makeBox(data.EntireCastUniqueAll, 'Distinct'));
							break;
					}
					break;
				case 'Women':
					switch (jobSpecific) {
						case 'Director':
							$('.boxes').append(makeBox(data.DirectorTotalFemale, 'Total'));
							$('.boxes').append(makeBox(data.DirectorUniqueFemale, 'Distinct'));
							break;
						case 'Protagonist':
							$('.boxes').append(makeBox(data.ProtagonistTotalFemale, 'Total'));
							$('.boxes').append(makeBox(data.ProtagonistUniqueFemale, 'Distinct'));
							break;
						case 'Main Cast':
							$('.boxes').append(makeBox(data.TopCastTotalFemale, 'Total'));
							$('.boxes').append(makeBox(data.TopCastUniqueFemale, 'Distinct'));
							break;
						case 'Entire Cast':
							$('.boxes').append(makeBox(data.EntireCastTotalFemale, 'Total'));
							$('.boxes').append(makeBox(data.EntireCastUniqueFemale, 'Distinct'));
							break;
					}
					break;
				case 'Men':
					switch (jobSpecific) {
						case 'Director':
							$('.boxes').append(makeBox(data.DirectorTotalMale, 'Total'));
							$('.boxes').append(makeBox(data.DirectorUniqueMale, 'Distinct'));
							break;
						case 'Protagonist':
							$('.boxes').append(makeBox(data.ProtagonistTotalMale, 'Total'));
							$('.boxes').append(makeBox(data.ProtagonistUniqueMale, 'Distinct'));
							break;
						case 'Main Cast':
							$('.boxes').append(makeBox(data.TopCastTotalMale, 'Total'));
							$('.boxes').append(makeBox(data.TopCastUniqueMale, 'Distinct'));
							break;
						case 'Entire Cast':
							$('.boxes').append(makeBox(data.EntireCastTotalMale, 'Total'));
							$('.boxes').append(makeBox(data.EntireCastUniqueMale, 'Distinct'));
							break;
					}
					break;
				case 'Non-Binary':
					switch (jobSpecific) {
						case 'Director':
							$('.boxes').append(makeBox(data.DirectorTotalNonBinary, 'Total'));
							$('.boxes').append(makeBox(data.DirectorUniqueNonBinary, 'Distinct'));
							break;
						case 'Protagonist':
							$('.boxes').append(makeBox(data.ProtagonistTotalNonBinary, 'Total'));
							$('.boxes').append(makeBox(data.ProtagonistUniqueNonBinary, 'Distinct'));
							break;
						case 'Main Cast':
							$('.boxes').append(makeBox(data.TopCastTotalNonBinary, 'Total'));
							$('.boxes').append(makeBox(data.TopCastUniqueNonBinary, 'Distinct'));
							break;
						case 'Entire Cast':
							$('.boxes').append(makeBox(data.EntireCastTotalNonBinary, 'Total'));
							$('.boxes').append(makeBox(data.EntireCastUniqueNonBinary, 'Distinct'));
							break;
					}
					break;
			}

			if (gender == 'All') {
				switch (jobSpecific) {
					case 'Director':
						makeJobRow(data.DirectorTotalAll, data.DirectorTotalFemale, data.DirectorTotalMale, data.DirectorTotalNonBinary, data.DirectorUniqueAll, data.DirectorUniqueFemale, data.DirectorUniqueMale, data.DirectorUniqueNonBinary);
						break;
					case 'Protagonist':
						makeJobRow(data.ProtagonistTotalAll, data.ProtagonistTotalFemale, data.ProtagonistTotalMale, data.ProtagonistTotalNonBinary, data.ProtagonistUniqueAll, data.ProtagonistUniqueFemale, data.ProtagonistUniqueMale, data.ProtagonistUniqueNonBinary);
						break;
					case 'Main Cast':
						makeJobRow(data.TopCastTotalAll, data.TopCastTotalFemale, data.TopCastTotalMale, data.TopCastTotalNonBinary, data.TopCastUniqueAll, data.TopCastUniqueFemale, data.TopCastUniqueMale, data.TopCastUniqueNonBinary);
						break;
					case 'Entire Cast':
						makeJobRow(data.EntireCastTotalAll, data.EntireCastTotalFemale, data.EntireCastTotalMale, data.EntireCastTotalNonBinary, data.EntireCastUniqueAll, data.EntireCastUniqueFemale, data.EntireCastUniqueMale, data.EntireCastUniqueNonBinary);
						break;
				}
			} else {

			}

			createNewTable();

			thead.append('<tr class="topheader"><th colspan="2">Top ' + Object.values(dataSource).length + ' Most Frequent</th></tr>');
			thead.append('<tr class="bottomheader"><th>Person</th><th>Amount</th></tr>');

			for (var a = 0; a < dataSource.length; a++) {
				var url = 'https://letterboxd.com/' + data.Username + '/films/with/' + job.toLowerCase() + '/' + urlSafe(dataSource[a].FullName.replace(/ /g, '-').toLowerCase()) + '/by/name/size/large/';
				var extraClass = '';
				if (a < dataSource.length - 1 && dataSource[a].Amount != dataSource[a + 1].Amount) {
					extraClass = ' class="breaker"';
				}
				var dot = '';
				if (gender == 'All') {
					dot = makeDot(dataSource[a].Gender) + ' ';
				}

				var tooltip = '';
				if (dataSource[a].Poster.length > 0) {
					tooltip = ' class="ttt" data-tooltip="<img width=\'150px\' height=\'225px\' src=\'https://image.tmdb.org/t/p/w220_and_h330_face/' + dataSource[a].Poster + '\'>"';
					if (extraClass.length > 0) {
						tooltip = tooltip.replace('ttt', 'ttt breaker');
						extraClass = '';
					}
				}

				tbody.append(
                    '<tr' + extraClass + tooltip + '>' +
                    '<td><a target="_blank" href="' + url + '">' + dot + dataSource[a].FullName + '</a></td>' +
					'<td class="right">' + dataSource[a].Amount + '</td>' +
					'</tr>');
			}

			$('#main').tablesorter({
				widgets: ['columns'],
				usNumberFormat: true,
				sortReset: false,
				sortRestart: false,
				sortList: [[1, 1]],
				headers: {
					0: { sorter: false },
					1: { sortInitialOrder: 'asc' },
					2: { sortInitialOrder: 'desc' }
				}
			});

			createTooltipTriggers();

			deactivateAll();
			$(event.target).addClass('active');
		}

		function showDirectorsWomen() {
			showPeople(data.DirectorFemale, 'Director', 'Director', 'Women');
		}

		function showDirectorsMen() {
			showPeople(data.DirectorMale, 'Director', 'Director', 'Men');
		}

		function showDirectorsNonBinary() {
			showPeople(data.DirectorNonBinary, 'Director', 'Director', 'Non-Binary');
		}

		function showDirectorsAll() {
			showPeople(data.DirectorAll, 'Director', 'Director', 'All');
		}

		function showProtagonistsWomen() {
			showPeople(data.ProtagonistFemale, 'Actor', 'Protagonist', 'Women');
		}

		function showProtagonistsMen() {
			showPeople(data.ProtagonistMale, 'Actor', 'Protagonist', 'Men');
		}

		function showProtagonistsNonBinary() {
			showPeople(data.ProtagonistNonBinary, 'Actor', 'Protagonist', 'Non-Binary');
		}

		function showProtagonistsAll() {
			showPeople(data.ProtagonistAll, 'Actor', 'Protagonist', 'All');
		}

		function showTopCastWomen() {
			showPeople(data.TopCastFemale, 'Actor', 'Main Cast', 'Women');
		}

		function showTopCastMen() {
			showPeople(data.TopCastMale, 'Actor', 'Main Cast', 'Men');
		}

		function showTopCastNonBinary() {
			showPeople(data.TopCastNonBinary, 'Actor', 'Main Cast', 'Non-Binary');
		}

		function showTopCastAll() {
			showPeople(data.TopCastAll, 'Actor', 'Main Cast', 'All');
		}

		function showEntireCastWomen() {
			showPeople(data.EntireCastFemale, 'Actor', 'Entire Cast', 'Women');
		}

		function showEntireCastMen() {
			showPeople(data.EntireCastMale, 'Actor', 'Entire Cast', 'Men');
		}

		function showEntireCastNonBinary() {
			showPeople(data.EntireCastNonBinary, 'Actor', 'Entire Cast', 'Non-Binary');
		}

		function showEntireCastAll() {
			showPeople(data.EntireCastAll, 'Actor', 'Entire Cast', 'All');
		}

		showOverall();
        setRandomBackdrop();

		$('#prime').addClass('active');

	</script>

</body>
</html>